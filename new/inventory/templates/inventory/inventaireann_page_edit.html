{% extends "base.html" %}
{% load static %}

{% block body_class %}{% endblock %}

{% block content %}
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' %}
 {% include 'tabs.html' with active_tab="stock" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_stock.html" %}
  <div class="h-full w-full">
	<!-- Main content header -->
	<body class="antialiased sans-serif" x-data="entries()"
			x-init="generateInvoiceNumber(111111, 999999);"
			x-cloak>
	<div  class="container mx-auto py-6 px-4">

			<div class="flex justify-between">
				<h2 class="text-2xl font-bold mb-6 pb-2 tracking-wider uppercase">Inventaire Annuel</h2>				
			</div>
	
			<div class="flex mb-8 justify-between">
				<div class="w-2/4">					
					<div class="mb-2 md:mb-1 md:flex items-center">
						<label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Date De début</label>
						<span class="mr-4 inline-block  md:block">:</span>
						<div class="flex-1">
								<input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500 " type="date" {% if request.session.role != 'manager' %}disabled{% endif %} x-model="invoiceDate">
						</div>
					</div>
					<div class="mb-2 md:mb-1 md:flex items-center">
						<label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Date de Fin d'inventaire</label>
						<span class="mr-4 inline-block  md:block">:</span>
						<div class="flex-1">
								<input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500 " type="date" {% if request.session.role != 'manager' %}disabled{% endif %} x-model="invoiceDueDate">
						</div>
					</div>
					<div class="flex justify-start mb-2 md:mb-0">
						<div class="mb-4 flex ">
							<label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Date de Fin d'inventaire</label>
							<span class="mr-4 inline-block  md:block">:</span>
							<div class="flex-1">
								<select
								class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white"
								id="entrepotArr"
								name="entrepotArr"
								x-model="Inventrepot"
								required  
								>
									<option value="" disabled selected>Entrepot</option>
									{% for entrepot in entrepots %}
										<option value="{{ entrepot.name }}" data-address="{{entrepot.location}}"  >
											{{ entrepot.name }} 
										</option>
									{% endfor %}
								</select>
							</div>
						</div>				  
						<div class="flex justify-between py-1">
							<span x-on:click="printExcelFile(Inventrepot)" class="cursor-pointer font-semibold whitespace-nowrap">
								<svg id='file-spreadsheet_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
									<g transform="matrix(1 0 0 1 12 12)" >
									<g style="" >
									<g transform="matrix(1 0 0 1 0 0)" >
									<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 4 -7)" >
									<path style="stroke: rgb(29,117,9); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-16.5, -5.5)" d="M 14 3 L 14 7 C 14 7.552284749830793 14.447715250169207 8 15 8 L 19 8" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.5 -0.5)" >
									<path style="stroke: rgb(29,117,9); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 17 21 L 7 21 C 5.8954305003384135 21 5 20.104569499661586 5 19 L 5 5 C 5 3.895430500338413 5.8954305003384135 3 7 3 L 14 3 L 19 8 L 19 19 C 19 20.104569499661586 18.104569499661586 21 17 21 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.5 2)" >
									<path style="stroke: rgb(29,117,9); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -14.5)" d="M 8 11 L 16 11 L 16 18 L 8 18 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.5 2.5)" >
									<path style="stroke: rgb(29,117,9); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -15)" d="M 8 15 L 16 15" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -1.5 2)" >
									<path style="stroke: rgb(29,117,9); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-11, -14.5)" d="M 11 11 L 11 18" stroke-linecap="round" />
									</g>
									</g>
									</g>
								</svg>
							</span>
							<span x-on:click="printPDFFile(Inventrepot)" class="cursor-pointer font-semibold whitespace-nowrap">
								<svg id='file-type-pdf_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
									<g transform="matrix(1 0 0 1 12 12)" >
									<g style="" >
									<g transform="matrix(1 0 0 1 0 0)" >
									<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 4 -7)" >
									<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-16.5, -5.5)" d="M 14 3 L 14 7 C 14 7.552284749830793 14.447715250169207 8 15 8 L 19 8" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.5 -5)" >
									<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -7.5)" d="M 5 12 L 5 5 C 5 3.895430500338413 5.8954305003384135 3 7 3 L 14 3 L 19 8 L 19 12" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -6 5.5)" >
									<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-6.5, -18)" d="M 5 18 L 6.5 18 C 7.32842712474619 18 8 17.32842712474619 8 16.5 C 8 15.67157287525381 7.32842712474619 15 6.5 15 L 5 15 L 5 21" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 5.5 5.5)" >
									<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-18, -18)" d="M 17 18 L 19 18" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 6 5.5)" >
									<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-18.5, -18)" d="M 20 15 L 17 15 L 17 21" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 0 5.5)" >
									<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12.5, -18)" d="M 11 15 L 11 21 L 12 21 C 13.104569499661586 21 14 20.104569499661586 14 19 L 14 17 C 14 15.895430500338414 13.104569499661586 15 12 15 L 11 15 z" stroke-linecap="round" />
									</g>
									</g>
									</g>
								</svg>
							</span>
						</div>
					</div>
				</div>				
			</div>
	


			   <div x-data="{ tab: 1 }" x-cloak class="my-10 antialiased ">
					<div class="relative flex flex-col rounded-lg shadow-xs overflow-hidden"> 
						<div class="flex space-x-8 bg-white border-b border-gray-200 ">
							<button
								type="button"
								class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
								x-on:click="tab = 1"
								:class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 1 }"
							 >
								EQUIPE A
							</button>
							<button
								type="button"
								class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
								x-on:click="tab = 2"
								:class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 2 }"
							 >
								EQUIPE B
							</button>
							<button
								type="button"
								class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
								x-on:click="tab = 3"
								:class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 3 }"
							 >
							 QUANTITES REELES
							</button>
						</div>     
						<div class="h-full">
							<div x-show="tab === 1">
								<div class=" mb-8 py-4">
								    <div class="w-full flex md:w-1/2 mb-2 md:mb-0">
										<label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Membre 01 :</label>
										<select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
											x-on:change="
												equipe1.push($event.target.value)
											"
											>
											<option value="" disabled selected>Ajouter Membre</option>
											{% for user in users  %}
												<option value="client.id">{{user.first_name}} {{user.last_name}}</option>
											{% endfor %}
										</select>			 
									</div>	
								    <div class="w-full flex md:w-1/2 mb-2 md:mb-0">
										<label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Membre 02 :</label>
										<select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
											x-on:change="
												equipe1.push($event.target.value)
											"
											>
											<option value="" disabled selected>Ajouter Membre</option>
											{% for user in users  %}
												<option value="client.id">{{user.first_name}} {{user.last_name}}</option>
											{% endfor %}
										</select>			 
									</div>	
								    <div class="w-full flex md:w-1/2 mb-2 md:mb-0">
										<label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Membre 03 :</label>
										<select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
											x-on:change="
												equipe1.push($event.target.value)
											"
											>
											<option value="" disabled selected>Ajouter Membre</option>
											{% for user in users  %}
												<option value="client.id">{{user.first_name}} {{user.last_name}}</option>
											{% endfor %}
										</select>				 
									</div>	
								</div>
								<div class="block py-2">
									<p>Ajouter à travers fichier excel</p>
									<input type="file" id="excelFileInput" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChange1">
									<span class="">
										<a href="#" class="text-red-500 hover:text-red-600 text-sm font-semibold" @click.prevent="products = []">Réinitialiser</a>																	
									</span>
								</div>
									<a href="#" class="text-gray-700 text-sm font-semibold" @click.prevent="filemodel()">Télécharger modèle de fichier</a>	
								 <div x-show="products1.length > 0">
									<h3 class="text-lg font-semibold mb-2">Liste Produits </h3>
									<table class="w-full  rounded border-2-collapse border-2">
										<thead class="bg-gray-50">
											<tr class="border-b">
												<th class=" p-2">Référence Produit</th>
												<th class=" p-2">Désignation Produit</th>
												<th class=" p-2">Quantité</th>
												<th class=" p-2"></th>
											</tr>
										</thead>
										<tbody>
											<template x-for="product in products1" >
											<tr class="border-b">
												<td class="text-center p-2" x-text="product.reference"></td>
												<td class="text-center p-2" x-text="product.name"></td>
												<td class=" text-center p-2" x-text="product.quantity"></td>
												<td class=" text-center p-2 flex space-x-1" >                            
												{% comment %} <a  @click="
													item.name =product.name
													item.ref = product.reference;
													item.qty = product.quantity;
													showqtyAvailable =true;
													availableqty = product.avqty;
													"class="text-gray-700">{% heroicon_mini "pencil-square" class="cursor-pointer transition-transform" %}</a> {% endcomment %}
												<a @click="deleteItem(product.reference)" class="text-red-500 font-bold cursor-pointer">
												X
												</a>
										
												</td>
											</tr>
											</template>
										</tbody>
									</table>
								</div>						
							</div>     
							<div x-show="tab === 2">
							    <div class=" mb-8 py-4">
								    <div class="w-full flex md:w-1/2 mb-2 md:mb-0">
										<label class="text-gray-800 flex mb-1 font-bold text-sm uppercase tracking-wide">Membre 01 :</label>
										<select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
											x-on:change="
												equipe2.push($event.target.value)
											"
											>
											<option value="" disabled selected>Ajouter Membre</option>
											{% for user in users  %}
												<option value="client.id">{{user.first_name}} {{user.last_name}}</option>
											{% endfor %}
										</select>				 
									</div>	
								    <div class="w-full flex md:w-1/2 mb-2 md:mb-0">
										<label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Membre 02 :</label>
										<select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
											x-on:change="
												equipe2.push($event.target.value)
											"
											>
											<option value="" disabled selected>Ajouter Membre</option>
											{% for user in users  %}
												<option value="client.id">{{user.first_name}} {{user.last_name}}</option>
											{% endfor %}
										</select>			 
									</div>	
								    <div class="w-full flex md:w-1/2 mb-2 md:mb-0">
										<label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Membre 03 :</label>
										<select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
											x-on:change="
												equipe2.push($event.target.value)
											"
											>
											<option value="" disabled selected>Ajouter Membre</option>
											{% for user in users  %}
												<option value="client.id">{{user.first_name}} {{user.last_name}}</option>
											{% endfor %}
										</select>			 
									</div>	
								</div>
								<h1 class="text-xl font-bold mb-6 py-2 tracking-wider uppercase border-b w-fit ">Listes des produits </h1>   
								<div class="block py-2">
									<p>Ajouter à travers fichier excel</p>
									<input type="file" id="excelFileInput" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChange2">
									<span class="">
										<a href="#" class="text-red-500 hover:text-red-600 text-sm font-semibold" @click.prevent="products = []">Réinitialiser</a>																	
									</span>
								</div>
                      			 <a href="#" class="text-gray-700 text-sm font-semibold" @click.prevent="filemodel()">Télécharger modèle de fichier</a>	
								 <div x-show="products2.length > 0">
									<h3 class="text-lg font-semibold mb-2">Liste Produits </h3>
									<table class="w-full  rounded border-2-collapse border-2">
										<thead class="bg-gray-50">
											<tr class="border-b">
												<th class=" p-2">Référence Produit</th>
												<th class=" p-2">Désignation Produit</th>
												<th class=" p-2">Quantité</th>
												<th class=" p-2"></th>
											</tr>
										</thead>
										<tbody>
											<template x-for="product in products2" >
												<tr class="border-b">
													<td class="text-center p-2" x-text="product.reference"></td>
													<td class="text-center p-2" x-text="product.name"></td>
													<td class=" text-center p-2" x-text="product.quantity"></td>
													<td class=" text-center p-2 flex space-x-1" >
														<a @click="deleteItem(product.reference)" class="text-red-500 font-bold cursor-pointer">
															X
														</a>									
													</td>
												</tr>
											</template>
										</tbody>
									</table>
								 </div>
							</div>
			 
							<div class="w-full" x-show="tab === 3">    
								 
								<h1 class="text-xl font-bold mb-6 py-2 tracking-wider uppercase border-b w-fit ">Listes des produits </h1>   
								<div class="block py-2">
									<p>Ajouter à travers fichier excel</p>
									<input type="file" id="excelFileInput" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChange2">
									<span class="">
										<a href="#" class="text-red-500 hover:text-red-600 text-sm font-semibold" @click.prevent="products = []">Réinitialiser</a>																	
									</span>
								</div>
                      			 <a href="#" class="text-gray-700 text-sm font-semibold" @click.prevent="GenerateConclusion()">Générer les quantités Réelles</a>	
								 <div x-show="products2.length > 0">
									<h3 class="text-lg font-semibold mb-2">Liste Produits </h3>
									<table class="w-full  rounded border-2-collapse border-2">
										<thead class="bg-gray-50">
											<tr class="border-b">
												<th class=" p-2">Référence Produit</th>
												<th class=" p-2">Désignation Produit</th>
												<th class=" p-2">Quantité Equipe1 </th>
												<th class=" p-2">Quantité Equipe2 </th>
												<th class=" p-2">Quantité Réelle </th>
												<th class=" p-2"></th>
											</tr>
										</thead>
										<tbody>
											<template x-for="product in products_real" >
												<tr class="border-b">
													<td class="text-center p-2" x-text="product.ref"></td>
													<td class="text-center p-2" x-text="product.name"></td>
													<td class=" text-center p-2" x-text="product.quantity1"></td>
													<td class=" text-center p-2" x-text="product.quantity2"></td>
													<td class=" text-center p-2" x-text="product.quantityreal"></td>
													<td class=" text-center p-2 flex space-x-1" >                            
														<a @click="deleteItem(product.reference)" class="text-red-500 font-bold cursor-pointer">
															X
														</a>									
													</td>
												</tr>
											</template>
										</tbody>
									</table>
								</div>
							</div>												
						</div> 					
					</div>
				</div>
	
				<div class="py-2 ml-auto mt-5 w-full ">	
					<div class="flex justify-between border-t w-full">
						<div></div>
						<button class="mt-6 bg-gray-700 text-white hover:bg-gray-100 hover:border-gray-700 hover:text-gray-700 font-semibold py-2 px-8 text-sm border border-gray-300 rounded shadow-lg" type="submit" @click.prevent="validateBon">Valider</button>
					</div>
				</div>

				<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.3/purify.min.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
				<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.3/xlsx.full.min.js"></script>
				<script>
					function entries() {
						return {
							items: [],
							equipe1 :[],
							equipe2 :[],
							stocks:[],
							invoiceDate: {{ bill.dateInv }},
							invoiceDueDate:{{bill.datecloture}},
							openPreview:false,
							netTotal: 0,
							Inventrepot:{{bill.entrepot.name}},
							item: {
								id: '',
								name: '',
								ref:'',
								qty: 0,
								rate: 0,
								total: 0,					
							},
							products1: [],
							products2: [],
							products3: [],
							products_real:[],

							GenerateConclusion(){
								if(this.Inventrepot == ""){
									alert("Veuillez Spécifier l'entrepot");
									return;
								}
								this.stocks = []; // Initialize stocks array

								dataObj = {
								nomEnt: this.Inventrepot,
								};

								axios
								.post('fetchStock/', dataObj, {
									headers: {
									'Content-Type': '',
									'X-CSRFToken': getCookie('csrftoken'),
									},
								})
								.then((response) => {
									itemsData = response.data.stocks;

									for (const itemData of itemsData) {
									const item = {
										ref: itemData.reference,
										name: itemData.product_name,
										qty: itemData.quantity,
									};
									this.stocks.push(item);
									}

									const quantityMap = new Map();

									// Process stocks and store quantityreal
									for (const item of this.stocks) {
									quantityMap.set(item.ref, {
										ref: item.ref,
										name: item.name,
										quantityreal: item.qty,
									});
									}

									// Process this.products1 and update the quantity map
									for (const product of this.products1) {
									const key = String(product.reference);
									if (quantityMap.has(key)) {
										quantityMap.get(key).quantity1 = product.quantity || 0;
									} else {
										quantityMap.set(key, {
										ref: product.reference,
										name: product.name,
										quantity1: product.quantity || 0,
										});
									}
									}

									// Process this.products2 and update the quantity map
									for (const product of this.products2) {
									const key = String(product.reference);
									if (quantityMap.has(key)) {
										quantityMap.get(key).quantity2 = product.quantity || 0;
									} else {
										quantityMap.set(key, {
										ref: product.reference,
										name: product.name,
										quantity2: product.quantity || 0,
										});
									}
									}

									// Create the result array
									const resultArray = Array.from(quantityMap.values()).map(
									({ ref, name, quantity1, quantity2, quantityreal }) => ({
										ref,
										name,
										quantity1,
										quantity2,
										quantityreal,
									})
									);
									console.log(resultArray);
									this.products_real = resultArray;
								})
								.catch((error) => {
									alert(error);
								});
							},
								filemodel(){
									// Create an empty array with headers
									const emptyData = [
										{ reference: '', designation: '', quantity: '' }
									];

									// Create worksheet
									const ws = XLSX.utils.json_to_sheet(emptyData);

									// Create workbook
									const wb = XLSX.utils.book_new();
									XLSX.utils.book_append_sheet(wb, ws, 'Products');

									// Download the file
									XLSX.writeFile(wb, `fichier_modele.xlsx`); 
								},

								handleFileChange1(event) {
									const file = event.target.files[0];
									if (file) {
										const reader = new FileReader();
										reader.onload = (e) => {
											const data = new Uint8Array(e.target.result);
											const workbook = XLSX.read(data, { type: 'array' });
											const worksheet = workbook.Sheets[workbook.SheetNames[0]];
											const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
											for (let i = 1; i < jsonData.length; i++) {
											if (jsonData[i].some(cell => cell !== '')) { // Check if any cell in the row is not empty
												this.products1.push({
													reference: jsonData[i][0],
													name: jsonData[i][1],
													quantity: parseFloat(jsonData[i][2]),
												});                   
											
											}
												}
										};
										reader.readAsArrayBuffer(file);
										this.$refs.fileInput.value = '';
										
									}
								},

								handleFileChange2(event) {
									const file = event.target.files[0];
									if (file) {
										const reader = new FileReader();
										reader.onload = (e) => {
											const data = new Uint8Array(e.target.result);
											const workbook = XLSX.read(data, { type: 'array' });
											const worksheet = workbook.Sheets[workbook.SheetNames[0]];
											const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
											for (let i = 1; i < jsonData.length; i++) {
											if (jsonData[i].some(cell => cell !== '')) { // Check if any cell in the row is not empty
												this.products2.push({
													reference: jsonData[i][0],
													name: jsonData[i][1],
													quantity: parseFloat(jsonData[i][2]),
												}); 
											
											}
												}
										};
										reader.readAsArrayBuffer(file);
										this.$refs.fileInput.value = '';
										
									}
								},
								getStockItem(entrepotStock){
									this.stocks=[]
									dataObj={
										nomEnt : entrepotStock,						 
									}
									console.log('fetching the stock  ...',dataObj);
									axios.post('fetchStock/', dataObj, {
									headers: {
										'Content-Type': '',
										'X-CSRFToken': getCookie('csrftoken'),
									}
									})
									.then((response) => {
											console.log(response.data.stocks) 
											itemsData=response.data.stocks;
											for (const itemData of itemsData) {		
												console.log(itemData.entrepot)						 
												const item = {										
													ref: itemData.reference,
													name: itemData.product_name,
												};
												this.stocks.push(item);
											}	
											const ws = XLSX.utils.json_to_sheet(this.stocks);
											const wb = XLSX.utils.book_new();
											XLSX.utils.book_append_sheet(wb, ws, 'Products');
											XLSX.writeFile(wb, `fichier_produits_en_${this.billing.name}.xlsx`);					 
									})
									.catch((error) => {
										alert(error)				
									});
								},

								printExcelFile(entrepotStock){
									this.stocks=[]
									dataObj={
										nomEnt : entrepotStock,						 
									}
									console.log('fetching the stock  ...',dataObj);
									axios.post('fetchStock/', dataObj, {
									headers: {
										'Content-Type': '',
										'X-CSRFToken': getCookie('csrftoken'),
									}
									})
									.then((response) => {
											console.log(response.data.stocks);
											itemsData=response.data.stocks;
											for (const itemData of itemsData) {								 
												const item = {										
													ref: itemData.reference,
													name: itemData.product_name,
													qty: itemData.quantity,
													ent:itemData.entrepot,
													prixrevient: itemData.prix_achat,
													montant:itemData.quantity * itemData.prix_achat
												};					
												this.stocks.push(item);
											}	
											const ws = XLSX.utils.json_to_sheet(this.stocks);
											const wb = XLSX.utils.book_new();
											XLSX.utils.book_append_sheet(wb, ws, 'Products');
											XLSX.writeFile(wb, `fichier_produits_en_${entrepotStock}.xlsx`);					 
									})
									.catch((error) => {
										console.log(error);				
									});
								},

								printPDFFile(entrepotStock) {
									this.stocks = [];
									dataObj = {
										nomEnt: entrepotStock,
									};
									axios.post('fetchStock/', dataObj, {
										headers: {
											'Content-Type': '',
											'X-CSRFToken': getCookie('csrftoken'),
										}
									})
									.then((response) => {
										itemsData = response.data.stocks;
										for (const itemData of itemsData) {
											const item = {
												ref: itemData.reference,
												name: itemData.product_name,
												qty: itemData.quantity,
												ent: itemData.entrepot,
												prixrevient: itemData.prix_achat,
												montant: itemData.quantity * itemData.prix_achat
											};
											this.stocks.push(item);
										}

										const tableHeaders = ['Reference', 'Product Name', 'Quantity', 'Prix Revient', 'Montant'];
										// Ensure that the data in each cell is defined or provide a default value (e.g., '-')
										const tableData = this.stocks.map(item => [
											item.ref || '-',           // Check for empty 'ref'
											item.name || '-',          // Check for empty 'name'
											item.qty !== undefined ? item.qty : '-', // Check for empty 'qty' and handle undefined
											item.prixrevient !== undefined ? item.prixrevient : '-', // Check for empty 'prixrevient' and handle undefined
											item.montant !== undefined ? item.montant : '-' // Check for empty 'montant' and handle undefined
										]);

										const docDefinition = {
											content: [
												{ text: `Liste des produits en ${entrepotStock}`, style: 'header' },
												{
													table: {
														headerRows: 1,
														widths: ['auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
														body: [tableHeaders, ...tableData]
													}
												}
											],
											styles: {
												header: {
													fontSize: 16,
													bold: true
												}
											}
											};
											// Create a PDFMake document and save the PDF
											const pdfDoc = pdfMake.createPdf(docDefinition);
											pdfDoc.download('stock_data.pdf');
											})
											.catch((error) => {
											console.log(error);
											});
								},

									filterProduct: '',
									showProduct: false,
									selectedProduct: null,
									closeProduct() { 
											this.showProduct = false;
											this.filterProduct = this.selectedProductName();
											this.item.name = this.selectedProductName();
											this.item.ref= this.selectedProduct.ref;
											this.focusedOptionIndex = this.selected ? this.focusedOptionIndex : null;
									},
									openProduct(){
										this.showProduct = true; 
										this.filterProduct = '';
									},
									toggleProduct() { 
										if (this.showProduct) {
											this.closeProduct();
										}
										else {
											this.openProduct()
										}
									},
									isProductsOpen() { return this.showProduct === true },
									selectedProductName() { return this.selectedProduct ? this.selectedProduct.name : this.filterProduct; },
									filteredStock() {
													return this.stocks
														? this.stocks.filter(option => {
															return (option.name.toLowerCase().indexOf(this.filterProduct) > -1) 
																|| (option.ref.toLowerCase().indexOf(this.filterProduct) > -1)
															})
															: {}
									},
									onProductClick(index) {
										this.focusedOptionIndex = index;
										this.selectProduct();
									},	

									selectProduct() {
										if (!this.isProductsOpen()) {
										return;
										}
										this.focusedOptionIndex = this.focusedOptionIndex ?? 0;
										const selected = this.filteredStock()[this.focusedOptionIndex]								
										if (this.selectedProduct && this.selectedProduct.name == selected.name) {
												this.filterProduct = '';
												this.selectedProduct = null;
										}
										else {
											this.selectedProduct = selected;
											this.filterProduct = this.selectedProductName();
											// Find the stock item with the matching reference
											const matchingStockItem = this.stocks.find(stockItem => stockItem.ref === selected.ref);

											if (matchingStockItem) {
												// Update the item data with the matching stock item
												console.log(matchingStockItem.ref)
												this.item.ref = matchingStockItem.ref;
												this.item.name = matchingStockItem.name;
												this.item.rate = matchingStockItem.rate;
												this.selectedProductQuantity = matchingStockItem.qty;
												this.showQuantity = true;
												setTimeout(() => {
													document.getElementById('price').value = matchingStockItem.prix;               						
												}, 50); // Adjust the delay as needed
												console.log(this.item.ref)
											}
										}
										this.closeProduct();
									},
					
									billing: {
										name: '',
										address: '',
										extra: '',
										phone:''
									},
									from: {
										name: '',
										address: '',
										extra: ''
									},
					
									showTooltip: false,
									showTooltip2: false,
									openModal: false,
									showQuantity:false,
					
									showModal(){
										document.getElementById('myForm').reset(); 						
										this.openModal =true;
									},
					
									addItem() {
										this.items.push({
											id: this.generateUUID(),
											name: this.item.name,
											qty: this.item.qty,
											rate: this.item.rate,
											ref: this.item.ref,
											//gst: this.calculateGST(this.item.gst, this.item.rate),
											total: this.item.qty * this.item.rate
										})
										console.log(this.item.rate)
										this.itemTotal();
										this.itemTotalGST();
					
										this.item.id = '';
										this.item.name = '';
										this.item.fournisseur='';
										this.item.qty = 0;
										this.item.rate = 0;
										//this.item.gst = 18;
										this.item.total = 0;
										document.getElementById('myForm').reset(); 
							
									
									},
					
									deleteItem(uuid) {
										this.items = this.items.filter(item => uuid !== item.id);
					
										this.itemTotal();
										//this.itemTotalGST();
									},
					
									itemTotal() {
										this.netTotal = this.numberFormat(this.items.length > 0 ? this.items.reduce((result, item) => {
											return result + item.total;
										}, 0) : 0);
									},
					
									generateUUID() {
										return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
											var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
											return v.toString(16);
										});
									},
					
									generateInvoiceNumber(minimum, maximum) {
										const randomNumber = Math.floor(Math.random() * (maximum - minimum)) + minimum;
										this.invoiceNumber = '#BE-'+ randomNumber;
									},
					
									numberFormat(amount) {
										return amount.toLocaleString("fr-FR", {
											style: "currency",
											currency: "DZD"
										});
									},
					
									printInvoice() {
										var printContents = this.$refs.printTemplate.innerHTML;
										var originalContents = document.body.innerHTML;
										document.body.innerHTML = printContents;
										window.print();
										window.location.reload();
										console.log(originalContents)
										document.body.innerHTML = originalContents;
					
										this.items=[];
									},

									validateBon(){
										const dataObj = {
											equipe1: this.equipe1,
											equipe2: this.equipe2,
											invoiceDate: this.invoiceDate,
											invoiceDueDate: this.invoiceDueDate,
											Inventrepot: this.Inventrepot,
											products1: this.products1,
											products2:this.products2,
											products_real: this.products_real,										
										};
										axios.post('', {
												formData: dataObj
											}, {
												headers: {
													'Content-Type': '',
													'X-CSRFToken': getCookie('csrftoken'),
												}
											})
											.then((response) => {
												data= response.data
												if(data.error){
													alert(data.error);
												}else{
													alert("Inventaire Annuel Created!");
												}		  
											})
											.catch((error) => {
												alert(error)
											});				
											
									},
							
						}
					}
					function getCookie(name) {
						var cookieValue = null;
						if (document.cookie && document.cookie !== '') {
							var cookies = document.cookie.split(';');
							for (var i = 0; i < cookies.length; i++) {
								var cookie = cookies[i].trim();
								// Does this cookie string begin with the name we want?
								if (cookie.substring(0, name.length + 1) === (name + '=')) {
									cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
									break;
								}
							}
						}
						return cookieValue;
					}
				</script>
    </body>	
	<!-- end Main content  -->
  </div>
</div>
</div>
</div>

{% endblock content %}
