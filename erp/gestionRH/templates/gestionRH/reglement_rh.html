{% extends "base.html" %}
{% load static heroicons %}

{% block body_class %}{% endblock %}
{% block content %}
  
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' %}
 {% include 'tabs.html' with active_tab="rh" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_grh.html" %}
  <div class="h-full w-full">
	<main class="block w-full px-2 h-full overflow-hidden" x-data="pointssells()" x-init="init()">
		<!-- Main content header -->
		<div class="flex flex-col items-start justify-between space-y-4 border-b lg:items-center lg:space-y-0 lg:flex-row"  >                                                                                                                                                    
		  <h1 class="text-2xl font-semibold whitespace-nowrap pt-4">Etat Règlement Salaire</h1>          
		</div>

            <div class="mb-2 py-2 flex border-b">  
                <div class="relative mr-4 inline-block">
					 <div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip = true" @mouseleave="showTooltip = false" @click="printInvoice()">
						 <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-printer" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
							 <rect x="0" y="0" width="24" height="24" stroke="none"></rect>
							 <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" />
							 <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" />
							 <rect x="7" y="13" width="10" height="8" rx="2" />
						 </svg>				  
					 </div>
					 <div x-show.transition="showTooltip" class="z-40 shadow-lg text-center w-32 block absolute left-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
						 Imprimer Etat Paie!
					 </div>
				 </div>
                <div class="relative mr-4 inline-block">
					 <div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip1 = true" @mouseleave="showTooltip1 = false" @click="exportExcelDiva">
						<svg id='file-spreadsheet_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
                            <g transform="matrix(1 0 0 1 12 12)" >
                            <g style="" >
                            <g transform="matrix(1 0 0 1 0 0)" >
                            <path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 4 -7)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-16.5, -5.5)" d="M 14 3 L 14 7 C 14 7.552284749830793 14.447715250169207 8 15 8 L 19 8" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -0.5 -0.5)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 17 21 L 7 21 C 5.8954305003384135 21 5 20.104569499661586 5 19 L 5 5 C 5 3.895430500338413 5.8954305003384135 3 7 3 L 14 3 L 19 8 L 19 19 C 19 20.104569499661586 18.104569499661586 21 17 21 z" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -0.5 2)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -14.5)" d="M 8 11 L 16 11 L 16 18 L 8 18 z" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -0.5 2.5)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -15)" d="M 8 15 L 16 15" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -1.5 2)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-11, -14.5)" d="M 11 11 L 11 18" stroke-linecap="round" />
                            </g>
                            </g>
                            </g>
                        </svg>			  
					 </div>
					 <div x-show.transition="showTooltip1" class="z-40 shadow-lg text-center w-32 block absolute left-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
						Exporter Ficher Etat Paie!
					 </div>
				</div>
                <div class="flex items-center space-x-2 "> 
           		    <select class="text-black/70 bg-gray-50 px-3 py-2 transition-all cursor-pointer hover:border-gray-700 border border-gray-200 rounded-lg outline-gray-700  invalid:text-black/30 w-64"
                      x-model="Period">
                      <option value="" selected>Période</option>
                      <option value="1">Janvier</option>
                      <option value="2">Février</option>
                      <option value="3">Mars</option>
                      <option value="4">Avril</option>
                      <option value="5">Mai</option>
                      <option value="6">Juin</option>
                      <option value="7">Juillet</option>
                      <option value="8">Août</option>
                      <option value="9">Séptembre</option>
                      <option value="10">Octobre</option>
                      <option value="11">Novembre</option>
                      <option value="12">Décembre</option>
                    </select>
                  </div>
          </div>  
              <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8 hidden" id="paie-print-template" x-ref="printTemplate">
                <h2 class="text-3xl text-center border-b font-bold mb-6 pb-2 tracking-wider uppercase">Informations Des Règlements Des Salariées</h2>
                <div class="overflow-hidden border-b border-gray-200 rounded-md ">
                  <table class="min-w-full overflow-x-auto divide-y divide-gray-200"  >
                       <thead class="bg-gray-50 border">
                            <tr>
                                <th class="px-2 py-3 text-xs border font-medium  text-center text-black  uppercase">
                                    Nom Salarié 
                                </th>
                                <th class="px-2 py-3 text-xs border font-medium  text-center text-black  uppercase">
                                    Numéro CCP/ Compte Bancaire
                                </th>
                                
                                <th class="px-2 py-3 border text-xs font-medium  text-left  text-black uppercase">							   
                                    Salaire
                                </th>					 
                                <th class="px-2 py-3 border text-xs font-medium  text-left  text-black uppercase">							   
                                    Evaluation Mensuelle
                                </th>					 
                                <th class="px-2 py-3 border text-xs tdgreen font-medium text-left bg-green-500 text-black uppercase">							   
                                    Salaire Virement
                                </th>					 
                                <th class="px-2 py-3 border text-xs tdred font-medium  text-left bg-red-500 text-black uppercase">							   
                                     Prime Panier + Transport
                                </th>					 
                                <th class="px-2 py-3 border text-xs tdred font-medium  text-left  text-black uppercase">							   
                                     Signature
                                </th>					 
                            </tr>
					    </thead>
                       <tbody>
                            <template x-for="cloture in liste_clotures" >                          
                                <tr  class="transition-all border" x-show="cloture.month == Period">
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.nom"></td>
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.association +' - '+ cloture.ccp"></td>
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.salaire"></td>                            
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.espece"></td>                            
                                    <td class="px-4 py-2 text-sm border font-medium text-center tdgreen bg-green-500 text-black " x-text="(cloture.salaireCalculated).toFixed(0)"></td>
                                    <td class="px-4 py-2 text-sm border font-medium text-center tdred bg-red-500 text-black " x-text="(cloture.especeCalculated).toFixed(0)  "></td>    
                                    <td class="px-4 py-2 text-sm border font-medium text-center   text-black " x-text="'.'  "></td>                            
                                </tr>
                            </template> 
                       </tbody>
                  </table>
                </div>
              </div>

		<div class="min-w-full py-2 align-middle sm:px-6 lg:px-8" >
            <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
              <div class="overflow-hidden border-b border-gray-200 rounded-md shadow-md">
                  <table class="min-w-full overflow-x-auto divide-y divide-gray-200"  >
                       <thead class="bg-gray-50 border">
                            <tr>
                                <th class="px-6 py-3 text-xs border font-medium tracking-wider text-center text-black  uppercase">
                                    Nom Salarié 
                                </th>
                                <th class="px-6 py-3 text-xs border font-medium tracking-wider text-center text-black  uppercase">
                                    CCP
                                </th>
                                <th class="px-6 py-3 border text-xs font-medium tracking-wider text-left  text-black uppercase">							   
                                    Salaire
                                </th>					 
                                <th class="px-6 py-3 border text-xs font-medium tracking-wider text-left  text-black uppercase">							   
                                    Evaluation Mensuelle
                                </th>					 
                                <th class="px-6 py-3 border text-xs font-medium tracking-wider text-left bg-green-500 text-black uppercase">							   
                                    Salaire Virement
                                </th>					 
                                <th class="px-6 py-3 border text-xs font-medium tracking-wider text-left bg-red-500 text-black uppercase">							   
                                     Prime Panier + Transport
                                </th>					 
                            </tr>
					    </thead>
                       <tbody>
                            <template x-for="cloture in liste_clotures" >                          
                                <tr  class="transition-all hover:shadow-lg border" x-show="cloture.month == Period">
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.nom"></td>
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.association +' - '+ cloture.ccp"></td>
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.salaire"></td>                            
                                    <td class="px-4 py-2 text-sm border font-medium text-center text-black " x-text="cloture.espece"></td>                            
                                   <td class="px-4 py-2 text-sm border font-medium text-center tdgreen bg-green-500 text-black " x-text="(cloture.salaireCalculated).toFixed(0)"></td>
                                    <td class="px-4 py-2 text-sm border font-medium text-center tdred bg-red-500 text-black " x-text="(cloture.especeCalculated).toFixed(0)  "></td>   
                                </tr>
                            </template> 
                       </tbody>
                  </table>
                </div>  
    
            </div>
        </div> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
	<script>
		function pointssells(){
			return {
				openModal:false,
				showModal:false,
				openCollection:false,
				liste_clotures: {{liste_paie | safe}},
				cloture_id:'',
				montant :'',
				date:new Date().toISOString().slice(0, 10),	
				verifying:false,
				user_now:'{{request.user.username}}',
				success:false,
				Period:new Date().getMonth() + 1,
                showTooltip:false,
                showTooltip1:false,
				password:'',
				operation:'add',
				search: '',
				selectedFamily: '',
				products: [],
				currentPage: 1,
				showModal:false,
				selectedFournisseur:'',
				productReference: '',
				pageSize: 10,
                printInvoice() {
					 var printContents = this.$refs.printTemplate.innerHTML;
					 var originalContents = document.body.innerHTML;
					 document.body.innerHTML = printContents;
					 window.print();
				     window.location.reload();
					 document.body.innerHTML = originalContents;
					 this.items=[];
				 },
				get totalPages() {
					return Math.max(1, Math.ceil(this.filteredProducts.length / this.pageSize));
				},
				
				datedeb: '',
				datefin:'',

                products_import:[],

                handleFileChange(event) {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const jsonData = JSON.parse(e.target.result); // Parse the JSON data directly

                                for (let i = 0; i < jsonData.length; i++) {
                                    // Assuming jsonData is an array of objects with the required properties
                                    const product = jsonData[i];
                                    // Check if the reference is not empty
                                    if (product.user_name && product.user_name.trim() !== '') {
                                        this.products_import.push({
                                            date: product.date,
                                            name: product.user_name,
                                            tems_depart: product.going_time,
                                            tems_arrive: product.coming_time,

                                        });
                                    }
                                    console.log(this.products_import);
                                }

                                const dataObj = {
                                    pointage: this.products_import,
                                };

                                axios.post('importPointage/', dataObj, {
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCookie('csrftoken'),
                                    }
                                })
                                    .then(response => {
                                        // Check if the import was successful
                                        if (response.data.Message) {
                                            showModal = false;
                                            alert(response.data.Message);
                                            window.location.reload();
                                        } else {
                                            alert(response.data.Message);
                                        }
                                    })
                                    .catch(error => {
                                        // Handle request errors
                                        alert(error);
                                    });
                        };

                        reader.readAsText(file); // Read the file as text
                        this.$refs.fileInput.value = '';
                    }
                },

                exportExcelDiva() {
						const array_print = []

							this.filteredProducts.forEach(product => {
								array_print.push({
									Salarié: product.nom,
									CoutHoraire: product.cout_heure,
									HeureSupplémentaire: product.nombreHeureSup,
									PrimeHeureSupplémentaire: product.prime_sup,
									MinuteEnretard: product.nombreMinuteRetard,
									NombreJourRetard: product.nombreJourR,
									MontantRetard: product.montant_retard,
									NombreJourAbsence: product.jourabsent,
                                    MontantAbsence: product.montantabsence,
									AvanceSalaire: product.avance,
									PrixSocial: product.social,
									salaire: product.salaire,
									espece: product.espece,
                                    salaireVirement: (product.salaire - product.avance - product.social).toFixed(0) ,
                                    PrimeEspece: (product.espece - product.montantabsence - product.montant_retard + product.prime_sup).toFixed(0)
								});
							});
						const ws = XLSX.utils.json_to_sheet(array_print);
						const wb = XLSX.utils.book_new();
						XLSX.utils.book_append_sheet(wb, ws, 'Products');
						XLSX.writeFile(wb, 'fichiers_etat_Paie.xlsx');
				},
				get filteredProducts() {
					return this.liste_clotures;
				},
				get filteredAndPaginatedProducts() {
					const start = (this.currentPage - 1) * this.pageSize;
					const end = start + this.pageSize;
					return this.filteredProducts.slice(start, end);
				},
				prevPage() {
					if (this.currentPage > 1) {
					this.currentPage -= 1;
					}
				},
				nextPage() {
					if (this.currentPage < this.totalPages) {
						this.currentPage += 1;
					}
				},
				productMatches(search, productName, productReference) {
					return (
						productName.toLowerCase().includes(search.toLowerCase()) ||
						productReference.toLowerCase().includes(search.toLowerCase())
					);
				},
				init(){
						const currentDate = new Date();
						const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      
                      // Add one day to the first day
                      const nextDay = new Date(firstDay);
                      nextDay.setDate(firstDay.getDate() + 1);
                
                      const firstDayOfMonth = nextDay.toISOString().split('T')[0];
      				
      					const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

						this.datedeb = nextDay.toISOString().split('T')[0];
						this.datefin = lastDayOfMonth.toISOString().split('T')[0];	
				},
				verifyPassword(){
                      this.verifying = true;                 
                      dataObj ={
                          password : this.password,
                          cloture_id: this.cloture_id
                      }
                      axios.post('verify-password-collection/', dataObj, {
                        headers: {
                          'Content-Type': '',
                          'X-CSRFToken': getCookie('csrftoken'),
                        }
                      })
                        .then(response => {
                          if (response.data.success) {
                            this.success=true;
                            this.openModal = false;
                            this.password=""
                            for (const reglement of this.liste_clotures) {
                              if (reglement.id === this.cloture_id) {
                                  reglement.collected = 'True';
								  this.openCollection = false;
                            	 this.password=""
                                  break; // No need to continue searching once found
                              }
                          }
                              // Set a timeout to reset this.success after a certain time
                            setTimeout(() => {
                              this.success = false;
                            }, 1000);
                          } else {
                            alert("false")
                            this.verifying = false;
                            this.openCollection = false;
                            this.password=""
                          }
                        })
                        .catch(error => {
                         // Handle any errors that occur during the AJAX request
                         alert(error);
                         this.verifying = false;
                      
                        });
                },
				addpoint(){
				    const hasDuplicateDate = this.liste_clotures.some(cloture => cloture.date === this.date && cloture.utilisateur === this.user_now);
                    if (hasDuplicateDate) {
                        alert(" Vous avez déjà introduit une clôture aujourd'hui ! ");
                        return;
                    }
                    if (this.montant == '') {
                        alert(" Veuillez Introduire une valeur de montant ! ");
                        return;
                    }
					dataObj={
        				montant : this.montant,
						date : this.date,					
       				}
     
       				axios.post('', {
       					 formData: dataObj
       				}, {
      				 headers: {
       					'Content-Type': '',
       					'X-CSRFToken': getCookie('csrftoken'),
       				 }
      				})
     				.then((response) => {
       					data = response.data
			 			if(data.error){
								alert(data.error.error);
						}else{
								alert("Clôture Introduit!");
						}		  
       					window.location.reload()            
     				})
    				 .catch((error) => {
       					alert(error)       
     				});	
				},
				confirmerSuppression() {
			          dataObj ={
                          user_id: this.cloture_id,                        
                      }
      		         axios.post('supprimerCloture/',dataObj, {
                        headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': getCookie('csrftoken'),
                        }
                      })
        		   .then(response => {
         			 // Check if the deletion was successful
          			if (response.data.message) {            			
            			showModal = false;
						alert(response.data.message);
						window.location.reload();
         			 } else {
            			alert(response.data.error);
         			 }
        		 })
        		 .catch(error => {
          			// Handle request errors
         			 alert(error);
       			 });
      				this.showModal = false;
      				this.cloture_id = '';
    			},
				annulerSuppression() {
      				// Réinitialiser les variables
     				this.showModal = false;
      				this.cloture_id = '';
    			},
				modifierFournisseur(){					
					 dataObj={
        				montant : this.montant,
						date : this.date,	
						user_id: this.cloture_id, 				
       				}
			 		axios.post('modifierCloture/', dataObj, {
			 		headers: {
			  		 'Content-Type': '',
			 		 'X-CSRFToken': getCookie('csrftoken'),
			 		}
			 		})
		 			.then((response) => {
		     			data = response.data
			    			if( data.error){
                  			alert(data.error);
              			}else{
                  			alert("Clôture Modifié!");
              			}
						window.location.reload()            
		  	  		})
	   				.catch((error) => {
		  				alert(error)
		  			
	   				});
			   		var form = document.getElementById('myForm');
  						form.reset();
				},
			}
		}
		function getCookie(name) {
      		var cookieValue = null;
      		if (document.cookie && document.cookie !== '') {
        		var cookies = document.cookie.split(';');
        		for (var i = 0; i < cookies.length; i++) {
          		  var cookie = cookies[i].trim();
          		  // Does this cookie string begin with the name we want?
          		  if (cookie.substring(0, name.length + 1) === (name + '=')) {
           			 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            			break;
          		  }
        		}
            }
           return cookieValue;
        }
	</script>
	</main>	
  </div>
</div>
</div>
</div>

{% endblock content %}