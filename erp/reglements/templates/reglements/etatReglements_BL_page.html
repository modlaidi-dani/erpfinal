{% extends "base.html" %}
{% load static heroicons %}

{% block body_class %}{% endblock %}
{% block content %}
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' %}
 {% include 'tabs.html' with active_tab="reglements" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_reglements.html" %}
  <div class="h-full w-full">
	<!-- Main content header -->
	<main class="block w-full h-full px-2 " x-data="products()" x-init="init()">
		<div class="flex flex-col items-start justify-between space-y-4 border-b lg:items-center lg:space-y-0 lg:flex-row py-2"  >                                                                                                                                                    
			<h1 class="text-2xl font-semibold whitespace-nowrap pt-4">Etat Règlements Bon Clients - Bons de Livraison -</h1>          
		</div>
		<div class="flex flex-wrap justify-start border-b  py-2">
		   <div class="flex flex-wrap justify-start space-x-2 border-r  px-2 py-2">
		   	<div class=" py-2 ">
				<input type="search" x-model="search"
     			 class="form-input rounded-md bg-gray-50 text-sm text-black  py-2 pl-4 border-transparent border-none outline-none focus:ring-0 focus:text-black transition-all duration-300 ease-in-out focus:w-72 w-60"
      				placeholder="Rechercher Par Nom Client...">
			</div>
			
			<div class="py-2">
				<select class="text-black/70 bg-gray-50 px-3 py-2 transition-all cursor-pointer hover:border-gray-700 border border-gray-200 rounded-lg outline-gray-700  invalid:text-black/30 w-64"
				x-model="regle"   x-on:change="filteredProducts">
				<option value="">Etat Règlement</option>
				<option value="true">Règlé</option>
				<option value="false">Non-Règlé</option>
				</select>
			</div>
		  </div>
		  
		</div>
		 <div class="-mb-2 py-2 flex border-b">  
                <div class="relative mr-4 inline-block">
					 <div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip1 = true" @mouseleave="showTooltip1 = false" @click="exportExcelDiva">
						<svg id='file-spreadsheet_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
                            <g transform="matrix(1 0 0 1 12 12)" >
                            <g style="" >
                            <g transform="matrix(1 0 0 1 0 0)" >
                            <path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 4 -7)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-16.5, -5.5)" d="M 14 3 L 14 7 C 14 7.552284749830793 14.447715250169207 8 15 8 L 19 8" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -0.5 -0.5)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 17 21 L 7 21 C 5.8954305003384135 21 5 20.104569499661586 5 19 L 5 5 C 5 3.895430500338413 5.8954305003384135 3 7 3 L 14 3 L 19 8 L 19 19 C 19 20.104569499661586 18.104569499661586 21 17 21 z" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -0.5 2)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -14.5)" d="M 8 11 L 16 11 L 16 18 L 8 18 z" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -0.5 2.5)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -15)" d="M 8 15 L 16 15" stroke-linecap="round" />
                            </g>
                            <g transform="matrix(1 0 0 1 -1.5 2)" >
                            <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-11, -14.5)" d="M 11 11 L 11 18" stroke-linecap="round" />
                            </g>
                            </g>
                            </g>
                        </svg>			  
					 </div>
					 <div x-show.transition="showTooltip1" class="z-40 shadow-lg text-center w-32 block absolute left-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
						Exporter Ficher Etat Reglement!
					 </div>
				 </div>
            
          </div>  
          <div class="-mb-2 py-2 flex justify-between border-b">  
            <div>
            </div>          
            <div class="inline-block  border text-sm leading-5 font-medium rounded-md text-black  ">
                <table class="min-w-full overflow-x-scroll divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th
                          scope="col"
                          class="px-6 py-3 border-r text-sm font-bold tracking-wider text-left text-gray-500 uppercase"
                        >
                          Montant Total Des Bons
                        </th>
                        <th
                          scope="col"
                          class="px-6 py-3 border-r text-sm font-bold tracking-wider text-left text-gray-500 uppercase"
                        >
                          Montant Total Réglé
                        </th>
                        <th
                          scope="col"
                          class="px-6 py-3 border-r text-sm font-bold tracking-wider text-left text-gray-500 uppercase"
                        >
                          Montant Total Annulé
                        </th>
                        <th
                          scope="col"
                          class="px-6 py-3 border-r text-sm font-bold tracking-wider text-center text-red-500  font-bold uppercase"
                        >
                          SOLDE TOTAL
                        </th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr class="transition-all bg-gray-100 hover:shadow-lg"
                         >
                          <td class="px-6 py-4 border-r text-center whitespace-nowrap">
                            <span class="inline-flex px-2 text-lg tracking-wide font-semibold leading-5 rounded-full" x-text="SumTotalReglement() +' DA'"></span>
                          </td>
                          <td class="px-6 py-4 border-r text-center whitespace-nowrap">
                            <span class="inline-flex px-2 text-lg tracking-wide font-semibold leading-5 rounded-full" x-text="SumTotalReglementRegle() +' DA'"></span>
                          </td>
                          <td class="px-6 py-4 border-r text-center whitespace-nowrap">
                            <span class="inline-flex px-2 text-lg tracking-wide font-semibold leading-5 rounded-full" x-text="SumTotalReglementAnnule() +' DA'"></span>
                          </td>
                          <td class="px-6 py-4 border-r text-center whitespace-nowrap">
                            <span class="inline-flex px-2 text-lg tracking-wide text-red-500  font-bold leading-5 rounded-full" x-text="SumTotalSolde() +' DA'"></span>
                          </td>
                        </tr>            
                    </tbody>
                </table>
            </div>
          </div> 
		<div class="flex flex-wrap justify-between border-b py-2">
  
    
 
	<div class="w-full mx-auto p-4">
 <div class="">
  <div class="bg-gray-50">
    <div class="grid grid-cols-10">
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Client</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">N° Telephone</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Email</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Montant</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Annulé</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Réglé</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Remboursé</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Solde</div>
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-500 uppercase">Solde Initial</div>
      <div class="px-6 py-3">Commercial</div>
    </div>
  </div>
  
  <div class="bg-white divide-y divide-gray-200">
    <template x-for="product in filteredAndPaginatedProducts" >
      <div class="transition-all hover:shadow-lg" x-bind:class="{'bg-green-500': product.montantrestant == 0, 'bg-red-500': product.montantrestant > 0, 'bg-orange-500': product.montantrestant < 0}">
        <div class="grid grid-cols-10">
          <div class="px-6 text-center py-2">
            <div  class="inline-flex px-2 text-sm font-semibold leading-5" x-text="product.idBon"></div>
          </div>
          <div class="px-6 text-center py-2">
            <div  class="inline-flex px-2 text-sm font-semibold leading-5" x-text="product.num_telephone"></div>
          </div>
            <div class="px-6 text-center py-2">
            <div  class="inline-flex px-2 text-sm font-semibold leading-5" x-text="product.email"></div>
          </div>
          <div class=" text-center py-2">
            <div class="inline-flex text-sm font-semibold leading-5" x-text="product.dateBon"></div>
          </div>
		  <div class="px-6 text-center py-2">
            <div class="inline-flex px-2 text-sm font-semibold leading-5" x-text="product.annule"></div>
          </div>
		  <div class="px-6 text-center py-2">
            <div class="inline-flex px-2 text-sm font-semibold leading-5" x-text="product.client"></div>
          </div>
          <div class="px-6 text-center py-2">
            <div class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="product.user"></div>
          </div>         
          <div class="px-6 text-center py-2">
            <div class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="product.montantrestant" ></div>
          </div>                        
          <div class="px-6 text-center py-2">
            <div class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="product.soldeinit" ></div>
          </div>                        
         
          <div class="px-6 flex items-center text-center py-2 text-sm ">
              <div class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="product.commercial" ></div>
             <button x-show="product.variants.length > 0" class="font-bold text-lg " @click="product.showVariants = !product.showVariants"> 
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>					
            </button>    
          </div>

        </div>
        <!-- Variant Structure -->
        <template  class="px-2" x-if="product.showVariants">
        <table class="min-w-full bg-gray-50 divide-y divide-gray-200">
		      <thead class="bg-gray-50">
                  <tr>
                        <th class="px-4">Bon Sortie</th>
                        <th class="px-4">Montant</th>
                        <th class="px-4">date Bon</th>
                        <th class="px-4">Annulé</th>
                        <th class="px-4">Réglé</th>
                        <th class="px-4">Date Réglement</th>                                          
                        <th class="px-4">Montant Récupérer</th>                                          
                  </tr>
         </thead>
         <tbody>		
          <template x-for="variant in product.variants">
            <tr class="transition-all border-b ">
			  <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5" x-text="variant.name"></div>
              </td>
              <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="variant.reference"></div>
              </td>
              <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="variant.dateBon"></div>
              </td>
              <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="(parseFloat(variant.annule)).toFixed(2)"></div>
              </td>
              <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="variant.totalpaid"></div>
              </td>
              <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="variant.datereg"></div>
              </td>
              <td class="text-center">
                <div  class="inline-flex px-2 text-sm font-semibold leading-5"  x-text="variant.montantSource + '-' + variant.datereg "></div>
              </td>
                                                        
            </tr>
          </template>
         </tbody>
        </table>
    </template>
      </div>
    </template>
  </div>
</div>
							 	
<div class="flex justify-end mt-4">
  <button
	  x-bind:disabled="currentPage === 1"
	  @click="prevPage"
  >
  <svg id='chevrons-left_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
		<g transform="matrix(1 0 0 1 12 12)" >
		<g style="" >
		<g transform="matrix(1 0 0 1 0 0)" >
		<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
		</g>
		<g transform="matrix(1 0 0 1 -3.75 -0.25)" >
		<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="2.5,-5 -2.5,0 2.5,5 " />
		</g>
		<g transform="matrix(1 0 0 1 2.25 -0.25)" >
		<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="2.5,-5 -2.5,0 2.5,5 " />
		</g>
		</g>
		</g>
  </svg>
  </button>
  <p class=" text-lg px-2" x-text="currentPage"></p> /<p id="total-pages" class=" text-lg px-2" x-text="totalPages"></p>
  <button
	  x-bind:disabled="currentPage === totalPages"
	  @click="nextPage"
  >
	  <svg id='chevrons-right_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
			<g transform="matrix(1 0 0 1 12 12)" >
			<g style="" >
			<g transform="matrix(1 0 0 1 0 0)" >
			<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
			</g>
			<g transform="matrix(1 0 0 1 -2.75 -0.25)" >
			<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="-2.5,-5 2.5,0 -2.5,5 " />
			</g>
			<g transform="matrix(1 0 0 1 3.25 -0.25)" >
			<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="-2.5,-5 2.5,0 -2.5,5 " />
			</g>
			</g>
			</g>
	  </svg>
  </button>
</div>
</div>
</div>



</div>
<!-- Modal de confirmation -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.3/purify.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>

		<script>
  			/* setup */
  			const { jsPDF } = window.jspdf;
  

		</script>		
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
	   <script>
				function products(){
				  return{
					search: '',				
					products: [],
					currentPage: 1,
					showModal:false,
					regle:'',
					productReference: '',
					pageSize: 10,
					bonComptoir:'',
					client:'',
					monantintroduit:'',  
					montanttopay:'',
					TotalPay:'',
					TotalRemise:'',
					TotalToPay:'',
					amountverse:'',
					invoiceDate:'',
					boncomptoir:'',
					selectedFournisseur:'',
					selectedFamily:'',
					datedeb:'',
					datefinal:'',
					get totalPages() {
  						return Math.max(1, Math.ceil(this.filteredProducts.length / this.pageSize));
  					},
  					SumTotalReglement(){
    					const sum = this.filteredProducts
                            .reduce((accumulator, currentItem) => {
                                return accumulator + parseFloat(currentItem.dateBon);
                            }, 0);
                        return (sum).toFixed(0);	
    				},
    				SumTotalReglementRegle(){
    					const sum = this.filteredProducts
                            .reduce((accumulator, currentItem) => {
                                return accumulator + parseFloat(currentItem.client);
                            }, 0);
                        return (sum).toFixed(0);	
    				},
    				SumTotalReglementAnnule(){
    					const sum = this.filteredProducts
                            .reduce((accumulator, currentItem) => {
                                return accumulator + parseFloat(currentItem.annule);
                            }, 0);
                        return (sum).toFixed(0);	
    				},
    				SumTotalSolde(){
    					const sum = this.filteredProducts
                            .reduce((accumulator, currentItem) => {
                                return accumulator + parseFloat(currentItem.montantrestant);
                            }, 0);
                        return (sum).toFixed(0);	
    				},
					printPDFFile() {
            
						const tableHeaders = ['Client', 'Montant', 'Regle',  'Solde'];
						// Ensure that the data in each cell is defined or provide a default value (e.g., '-')
						const tableData = this.products.map(item => [			
							item.idBon !== undefined ? item.idBon : '-',           // Check for empty 'ref'
							item.dateBon !== undefined ? item.dateBon : '-',          // Check for empty 'name'
							item.client !== undefined ? item.client : '-', // Check for empty 'qty' and handle undefined
							item.client !== undefined ? item.client : '-', // Check for empty 'prixrevient' and handle undefined
							item.montantrestant !== undefined ? item.montantrestant : '-' // Check for empty 'montant' and handle undefined
						]);

				const docDefinition = {
					content: [
						{ text: 'Stock Data', style: 'header' },
						{
							table: {
								headerRows: 1,
								widths: ['auto', 'auto', 'auto', 'auto', 'auto', 'auto'],
								body: [tableHeaders, ...tableData]
							}
						}
					],
					styles: {
						header: {
							fontSize: 16,
							bold: true
						}
					}
				};
				// Create a PDFMake document and save the PDF
				const pdfDoc = pdfMake.createPdf(docDefinition);
				pdfDoc.download('stock_data.pdf');

          },
		  exportExcelDiva() {
						const array_print = []

							this.filteredProducts.forEach(product => {
								// Add the product itself
								array_print.push({
									Client: product.idBon,
									montant:		product.dateBon,
									annule:		product.annule, 
									regle:		product.client,
									Solde:		product.montantrestant
									
								});
							});
						const ws = XLSX.utils.json_to_sheet(array_print);
						const wb = XLSX.utils.book_new();
						XLSX.utils.book_append_sheet(wb, ws, 'Products');
						XLSX.writeFile(wb, 'fichiers_etat_Reglement.xlsx');
				},
					  get filteredProducts() {
						return this.products.filter((product) => {
						const nameMatch = product.idBon.toLowerCase().includes(this.search.toLowerCase());
                        const blmatch = product.variants.some(variant =>
                            variant.name.toLowerCase().includes(this.search.toLowerCase())
                        ) || this.search.toLowerCase() == '' ;
						if (this.regle === 'true') {
							// If regle is 'true', filter products where montantrestant is 0
							return nameMatch  && parseFloat(product.montantrestant) === 0;
						} else if (this.regle === 'false') {
							// If regle is 'false', filter products where montantrestant is not 0
							return (blmatch || nameMatch) &&  parseFloat(product.montantrestant) > 0;
						} else {
							// If regle is not 'true' or 'false', return all products without regle filter
							return (blmatch || nameMatch) ;
						}
						});
          			},
	  				get filteredAndPaginatedProducts() {
		  				const start = (this.currentPage - 1) * this.pageSize;
		  				const end = start + this.pageSize;
		  				return this.filteredProducts.slice(start, end);
	  				},
					prevPage() {
					  if (this.currentPage > 1) {
					   this.currentPage -= 1;
					  }
					},
					nextPage() {
					  if (this.currentPage < this.totalPages) {
						  this.currentPage += 1;
					  }
					},
				

					renderInformation(name, reference, idBon){
						toprint_bill = this.products.find((product) => product.idBon == idBon)
						invoiceDate = name;
						boncomptoir = toprint_bill.idBon; 
						TotalPay = toprint_bill.totalprice,
						TotalRemise = toprint_bill.remise,
						TotalToPay = toprint_bill.montantBon,
						amountverse = reference,
						this.printInvoice();
					},
					printInvoice() {
						var printContents = this.$refs.printTemplate.innerHTML;
						document.body.innerHTML = printContents;
						setTimeout(() => {
							window.print();
							window.location.reload();
							this.items = [];
						}, 50); // Delay for 1 second (adjust as needed)      			
					},
					exportExcel() {
						const array_print = []
						const ws = XLSX.utils.json_to_sheet(this.filteredProducts);
						const wb = XLSX.utils.book_new();
						XLSX.utils.book_append_sheet(wb, ws, 'Products');
						XLSX.writeFile(wb, 'fichier_produits.xlsx');
					},

       			 updateQte(){      
					dataObj={
					  bonComptoir : this.bonComptoir,
					  monantintroduit : this.monantintroduit,
					}

							axios.post('', {
							formData: dataObj
							}, {
							headers: {
								'Content-Type': '',
								'X-CSRFToken': getCookie('csrftoken'),
							}
							})
					.then((response) => {
					data = response.data
						if(data.error){
							alert(data.error);
						}else{
							alert("Règlement Mis A Jour !");
						}		  
					window.location.reload()            
					})
					.catch((error) => {
					alert(error)      
					});
						
				},
				generateUUID() {
						  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
							  var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
							  return v.toString(16);
						  });
				},
				init() {
					var products = [];
						{% for bon in clients %}                      
							var productData = {
								idBon: "{{ bon.name }}",
								dateBon: ({{ bon.total_amount }}).toFixed(0),
								client:({{bon.total_paid_amount}}).toFixed(0),
								user: {{bon.total_rembourse}},
								commercial: "{{bon.user.username}}",
								num_telephone: "{{bon.phone}}",
								email: "{{bon.email}}",
								soldeinit : {{bon.solde}},
								montantrestant:({{bon.remaining_amount}}).toFixed(0),
								annule:({{bon.total_annule}}).toFixed(0),		
								variants:[],
									};
										{% for verssement in bon.client_bonS.all %}	
											{% with verssement.bonS_reglements.all|first as first_reg %}							 			
												var variantData ={
													id:this.generateUUID(),
													name: "{{ verssement.idBon }}",
													annule:"{{ verssement.price_annule }}",
													dateBon:"{{verssement.dateBon}}",
													datereg: "{{first_reg.dateReglement}}",
													montantSource: "{{first_reg.montantSourceRamasse}}",
													reference: ((parseFloat("{{verssement.get_total_price }}") - parseFloat("{{verssement.Remise }}") )*1.19  ).toFixed(0) ,
													totalpaid: "{{verssement.total_paid_amount }}",
													price:"{{ produit.total_remaining_amount }}",
												}
												if (!variantData.name.startsWith('BECH')) {
													productData.variants.push(variantData)
												}
											{% endwith %}
										{% endfor %}			
						// Check if the product already exists in the products array
						var exists = products.some(function(existingProduct) {
							return existingProduct.idBon === productData.idBon;
						});
						if (!exists) {
							products.push(productData);
						}
						{% endfor %}
						console.log(products);
						// Now, assign the filtered products array to this.products
						this.products = products;
						const currentDate = new Date();
      					const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      					const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

						this.datedeb = firstDayOfMonth.toISOString().split('T')[0];
						this.datefin = lastDayOfMonth.toISOString().split('T')[0];	
				},
				
				  }
				}
				function getCookie(name) {
				  var cookieValue = null;
	  			  if (document.cookie && document.cookie !== '') {
		  			var cookies = document.cookie.split(';');
		  			for (var i = 0; i < cookies.length; i++) {
			  			var cookie = cookies[i].trim();
			  		// Does this cookie string begin with the name we want?
			  			if (cookie.substring(0, name.length + 1) === (name + '=')) {
				  			cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
				  			break;
			  			}
		  			}
	  			 }
	  				return cookieValue;
  				}
			   </script> 
				
			  </div>
			</div>
		  </div>
		</div>
</main>
	<!-- end Main content  -->

  </div>
</div>
</div>
</div>

{% endblock content %}
