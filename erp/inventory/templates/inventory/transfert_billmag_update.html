{% extends "base.html" %}
{% load static %}

{% block body_class %}{% endblock %}

{% block content %}
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' %}
 {% include 'tabs.html' with active_tab="stock" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_stock.html" %}
  <div class="h-full w-full">
	<!-- Main content header -->
	<body class="antialiased sans-serif">						
		<div class="h-2"></div>
		<div 
			class="container mx-auto py-6 px-4"
			x-data="entries()"
			x-init="initItems()"
			x-cloak
		 >
			<div class="flex justify-between">
			   <div class="flex space-x-4 mb-6">
					<h2 class="text-2xl font-bold tracking-wider uppercase"> Bon de transfert </h2>
					<div class="relative inline-flex space-x-2">
					 <template x-if="automatiquement == 'True'">
					    <div>
                                <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium cursor-pointer text-green-700 ring-1 ring-inset ring-green-700"  @mouseenter="showTooltip3 = true" @mouseleave="showTooltip3 = false">Automatiquement </span>
								<div x-show.transition="showTooltip3" class="z-40 shadow-lg text-center w-64 block absolute right-0 top-0 p-2 mt-8 rounded-lg bg-gray-700 text-white text-xs">
									Ce Bon de transfert a été créer automatiquement, lors de la création du bon de livraison !
								</div>
					    </div>
                     </template>
                    <template x-if="automatiquement == 'True' && !valide">
                             <div class="flex space-x-2">
                              <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium cursor-pointer text-red-700 ring-1 ring-inset ring-red-700"  @mouseenter="showTooltip4 = true" @mouseleave="showTooltip4 = false">Non-validé</span>
							  <div x-show.transition="showTooltip4" class="z-40 shadow-lg text-center w-64 block absolute right-0 top-0 p-2 mt-8 rounded-lg bg-gray-700 text-white text-xs">
									Ce Bon de transfert n'est pas encore validé par le responsable d'entrepôt!
							  </div>
							   {% if request.session.username in bill.entrepot_depart.get_responsables %} 
                               		<span x-on:click="openModalValide = true" class="underline rounded cursor-pointer">Valider</span>

							   {% endif %}
                            </div>                            
                     </template>
					 <div x-show="openModalValide" @click.away="openModalValide = false" class="fixed inset-0 z-40 w-full flex items-center justify-center bg-black bg-opacity-50">
                		<div class="bg-white p-6 rounded shadow-md">
                  			<h3 class="text-lg font-semibold mb-2">Confirm</h3>
                  			<p class="mb-4">Please enter your password to confirm the bill:</p>
                  			<input x-model="password" type="password" class="border rounded px-2 py-1 mb-2">
                  			<button @click="verifyPassword()" class="btn btn-primary">
                    			<span x-show="!verifying">Confirm</span>
                    			<span x-show="verifying">Verifying...</span>
                  			</button>
                  			<button @click="openModalValide = false" class="btn btn-secondary">Cancel</button>
                		</div>
              		</div>						 
                     <template x-if="valide">
                            <div>
                              <span class="inline-flex items-center rounded-md bg-white px-2 py-1 text-xs font-medium cursor-pointer text-green-700 ring-1 ring-inset ring-green-700"  @mouseenter="showTooltip4 = true" @mouseleave="showTooltip4 = false">validé</span>
							  <div x-show.transition="showTooltip4" class="z-40 shadow-lg text-center w-64 block absolute right-0 top-0 p-2 mt-8 rounded-lg bg-gray-700 text-white text-xs">
									Ce Bon de transfert est validé !
							  </div>

                            </div>                           
                     </template>						 
					</div>
			   	</div>
				<div>
					<div class="relative mr-4 inline-block">
						<div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip = true" @mouseleave="showTooltip = false" @click="printInvoice()">
							<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-printer" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
								<rect x="0" y="0" width="24" height="24" stroke="none"></rect>
								<path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" />
								<path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" />
								<rect x="7" y="13" width="10" height="8" rx="2" />
							</svg>				  
						</div>
						<div x-show.transition="showTooltip" class="z-40 shadow-lg text-center w-32 block absolute right-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
							Print this invoice!
						</div>
					</div>
					<div class="relative inline-block">
						<div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip2 = true" @mouseleave="showTooltip2 = false" @click="openPreview=true">
							<svg id='eye_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
									<g transform="matrix(1 0 0 1 12 12)" >
									<g style="" >
									<g transform="matrix(1 0 0 1 0 0)" >
									<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.25 -0.25)" >
									<circle style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" cx="0" cy="0" r="2" />
									</g>
									<g transform="matrix(1 0 0 1 -0.25 -0.25)" >
									<path style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 22 12 C 19.333 16.667 16 19 12 19 C 8 19 4.667 16.667 2 12 C 4.667 7.333 8 5 12 5 C 16 5 19.333 7.333 22 12" stroke-linecap="round" />
									</g>
									</g>
									</g>
							</svg>		  
						</div>
						<div x-show.transition="showTooltip2" class="z-40 shadow-lg text-center w-32 block absolute right-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
							Preview
						</div>
					</div>
				</div>
			</div>
			<!-- /Print Template -->
		   		<div id="js-print-template" x-ref="printTemplateBL" class="hidden">
					<div class="py-4 border-b border-stone-500">
									<img src="{% static 'media/divatech-logo.png' %}" alt="">
					</div>
		  			<h2 class="text-3xl text-center font-bold border-b mb-6 pb-2 tracking-wider uppercase">Facture</h2>
					<div class="flex justify-between space-x-3 mb-2">
						<div class="w-1/2 border border-black">
							<div class="px-4 py-3 ">		
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Numéro de Bon</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="'FA2404-00621'"></div>
							</div>				
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Date de Bon</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="invoiceDate"></div>
							</div>
						</div>
						</div>
						<div class="w-1/2 border border-black">
							<div class="px-4 py-3 ">
								<div class="mb-1 flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide"> Client </label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="'Gaming Setif Informatique'"></div>
								</div>
								<div class="flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Adresse </label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="'Setif, Cite Berrarma a coté Lycée Kateb Yacine de 1014'"></div>
								</div>
								<div class="flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">N°= téléphone </label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="'+213554058158'"></div>
								</div>

								<div class="flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">N°= Rg:</label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="billing.num_registre"></div>
								</div>
								<div class="flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">NIF </label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="billing.nif"></div>
								</div>
								<div class="flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">N°= AI </label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="billing.nai"></div>
								</div>
								<div class="flex items-center">
									<label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">NIS </label>
									<span class="mr-4 inline-block">:</span>
									<div x-text="billing.nis"></div>
								</div>	
							</div>
						</div>
					</div>
					<table class="w-full border-collapse border border-black">
						<thead>
							<tr class="bg-gray-100">
								<th class="border border-black px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Reference</th>
								<th class="border border-black px-1 py-2 text-black uppercase print-td tracking-wide text-sm font-bold">Designation</th>
								<th class="border border-black px-1 py-2 w-32 text-center text-black uppercase tracking-wide text-sm font-bold">PVU HT</th>								
								<th class="border border-black px-1 py-2 w-32 text-center text-black uppercase tracking-wide text-sm font-bold">Quantité</th>								
								<th class="border border-black px-1 py-2 w-32 text-center text-black uppercase tracking-wide text-sm font-bold">Total HT</th>								
							</tr>
						</thead>
						<tbody>
							<template x-for="invoice in items" >
								<tr class="border border-black">
									<td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.ref"></td>
									<td class="border border-black px-1 py-2 text-black print-td text-xs" x-text="invoice.name"></td>
									<td class="border border-black px-1 py-2 text-black text-center text-xs" x-text="invoice.rate"></td>
									<td class="border border-black px-1 py-2 w-32 text-center text-black text-xs" x-text="invoice.qty"></td>
									<td class="border border-black px-1 py-2 w-32 text-center text-black text-xs" x-text="invoice.total"></td>
								</tr>
							</template>
						</tbody>
					</table>
					<div class="w-full flex mt-1  space-x-3 ">
						<table class="w-1/3 table-auto  border-collapse border border-black">
							<thead>
								<tr class="bg-gray-100">
									<th class="border border-gray-700 px-4 ">TVA</th>
									<th class="border border-gray-700 px-4 ">Total TVA</th>                     
								</tr>
							</thead>
							<tbody>
								<!-- Sample data rows -->
								<tr class="border border-gray-700">
									{% if request.session.store == "1"  %}
										<td class="border border-gray-700 px-4 "> 19 %</td>
									{% else %}
										<td class="border border-gray-700 px-4 "> 0 %</td>
									{% endif %}
									<td class="border border-gray-700 px-4 "x-text="parseFloat(totalTVA)"></td> 
								</tr>
								<!-- Add more rows as needed -->
							</tbody>
						</table>
						<table class="w-2/3 h-fit table-auto border-collapse border border-black">
							<thead>
								<tr class="bg-gray-100">
									<!--<th class="border border-gray-700 px-4 ">Total HT</th>-->
									<th class="border border-gray-700 px-4 ">Total HT </th>
									<th class="border border-gray-700 px-4 ">Total Remise</th>
									<th class="border border-gray-700 px-4 ">Sous Total TTC </th>
                                    <th class="border border-gray-700 px-4 ">Net à Payer</th>
								</tr>
							</thead>
							<tbody>
								<!-- Sample data rows -->
								<tr class="border border-gray-700">
									<!--<td class="border border-gray-700 px-4" x-text="frais"></td>-->
									<td class="border border-gray-700 px-4" x-text="totalHt"></td>
									<td class="border border-gray-700 px-4" x-text="'0.00'"></td>
									<td class="border border-gray-700 px-4" x-text="parseFloat(totalHt) * 1.19"></td>
                                    <td class="border border-gray-700 px-4" x-text="parseFloat(totalTTC)" ></td>
								
								</tr>
								<tr>
									<td class="border border-gray-700 px-4 py-2" colspan="5">
										<div class="flex space-x-1 items-center">
										<p class="text-center">
											Condition de règlement : <p  class="font-bold uppercase" > VIREMENT BANCAIRE </p>
										</p>
							
										</div>
									</td>
								</tr>
								<!-- Add more rows as needed -->
							</tbody>
						</table>
					</div>
					<div class=" flex justify-between mt-2 mr-0">
						<div></div>
						<div class="font-bold">
						Cachet et Signature
						</div>
					</div>
			    </div>
			    <!-- /Print Template -->
			<div class="flex mb-8 justify-between">
				<div class="w-2/4">
					<div class="mb-2 md:mb-1 md:flex items-center">
						<label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Numéro de Bon</label>
						<span class="mr-4 inline-block  md:block">:</span>
						<div class="flex-1">
						<input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="inline-full-name" type="text" placeholder="eg. #BON-100001" x-model="invoiceNumber">
						</div>
					</div>
	
					<div class="mb-2 md:mb-1 md:flex items-center">
						<label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Date de Bon</label>
						<span class="mr-4 inline-block  md:block">:</span>
						<div class="flex-1">
						<input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500 " type="date"   x-model="invoiceDate" {% if request.session.role != 'manager' %}disabled{% endif %}>
						</div>
					</div>
				</div>				
			</div>
	
			<div class="flex flex-wrap justify-between mb-8">
				<div class="w-full md:w-1/3 mb-2 md:mb-0">
				  <div class="mb-4 flex">
					 <label class="text-gray-800 block font-bold text-sm  uppercase tracking-wide appearance-none">Entrepot de Départ :</label>
					 <select
							class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white"
							id="entrepotDep"
							name="entrepotDep"
							x-model="billing.name"
							x-on:change="
					 		 billing.name =$event.target.value
					  		 billing.address = $event.target.selectedOptions[0].dataset.address
							 getStockItem($event.target.value)
							"
							required  
				 		>
				 		<option value="" disabled selected>Selectionez entrepot de départ</option>
				 		{% for entrepot in entrepots %}
							<option value="{{ entrepot.store_name }}-{{ entrepot.entrepot_name}}" data-address="{{entrepot.adresse}}">
								{{ entrepot.store_name }}  - {{ entrepot.entrepot_name}}
							</option>
				 		{% endfor %}
				     </select>
				  </div>
				  <div class="mb-4 flex">
				    <label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide appearance-none">Entrepôt d'arrivée :</label>
					<select
							class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white"
							id="entrepotArr"
							name="entrepotArr"
							x-model="from.name"
							x-on:change="
					  		from.name=$event.target.value;
					  		from.address = $event.target.selectedOptions[0].dataset.address
					  		console.log(from.address)
							"
							required  
				 		>
				 		<option value="" disabled selected>Selectionez entrepot d'arrivée</option>
				 		{% for entrepot in entrepots %}
							<option value="{{ entrepot.store_name }}-{{ entrepot.entrepot_name}}" data-address="{{entrepot.adresse}}"  >
								{{ entrepot.store_name }}  - {{ entrepot.entrepot_name}}
							</option>
				 		{% endfor %}
				    </select>
				  </div>
				</div>
			</div>						
			<div class="flex -mx-1 border-b py-2 items-start">
				<div class="flex-1 px-1">
					<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Référence</p>
				</div>
				<div class="flex-1 px-1">
					<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Designation</p>
				</div>
				<div class="px-1 w-20 text-right">
					<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Units</p>
				</div>
				<div class="px-1 w-20 text-center">
				</div>
			</div>
		
			<template x-for="invoice in items" :key="invoice.id">
    <div class="flex -mx-1 py-2 border-b">
        <div class="flex-1 px-1">
            <p class="text-gray-800" x-text="invoice.ref"></p>
        </div>
        <div class="flex-1 px-1">
            <p class="text-gray-800" x-text="invoice.name"></p>
        </div>
        <div class="px-1 w-20 text-right">
            <p class="text-gray-800" x-text="invoice.qty"></p>
        </div>
        <div class="px-1 w-20 text-right">
            <input type="checkbox" x-model="invoice.selected" class="mr-2" />
        </div>
    </div>
</template>
{% if request.session.role == 'manager' or 'inventory.can_edit_bs' in request.session.permissions %} 
<div class="flex justify-between mt-4">
	<div></div>
    <button @click="deleteSelectedItems" class="bg-red-500 text-white px-4 py-2 rounded-md" x-show="items.length > 0">
    Supprimer sélectioner
</button>

</div>
{% endif %}	
		    {% if request.session.role == 'manager' or 'inventory.can_edit_bs' in request.session.permissions %} 
			<button class="mt-6 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 text-sm border border-gray-300 rounded shadow-sm" x-on:click="showModal">
				Add Items
			</button>
			<div class="block py-2">
					   		<input type="file" id="excelFileInput" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChange">
							<span class="">
								<a href="#" class="text-red-500 hover:text-red-600 text-sm font-semibold" @click.prevent="items = []">Réinitialiser</a>																	
							</span>
			</div>
			
			<div class="py-2 ml-auto mt-5 w-full sm:w-2/4 lg:w-1/4">								
				<div class="flex justify-between">
					<div></div>
					<button class="mt-6 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 text-sm border border-gray-300 rounded shadow-sm" type="submit" x-on:click="validateBon">Valider le Bon & imprimer</button>
			    </div>
			</div>
			{% endif %}
			<div style=" background-color: rgba(0, 0, 0, 0.8)" class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full py-8" x-show.transition.opacity="openPreview">	
				<div class="shadow absolute -right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
						x-on:click="openPreview = !openPreview">
						<svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
							<path
								d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
						</svg>
				</div>
			   <div class="p-4 w-1/3 mx-auto relative left-0 right-0 overflow-hidden  bg-white h-full "  x-on:click.away="openPreview = !openPreview">
				 <div class="h-full">
				   <div class="py-4 border-b border-stone-500">
						<img src="{% static 'media/divatech-logo.png' %}" alt="">
					</div>
					<h2 class="text-3xl text-center py-1 border-b font-bold mb-6 pb-2 tracking-wider uppercase">Bon de transfert du stock</h2>
					<div class="flex justify-between space-x-3 mb-10">
						<div class="w-full border border-black">
							<div class="px-4 py-3 ">		
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Numéro de Bon.</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="invoiceNumber"></div>
							</div>				
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Date de Bon</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="invoiceDate"></div>
							</div>

							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Entrepôt d'arrivé</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text=" from.name"></div>
							</div>		
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Entrepôt de Départ</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="billing.name"></div>
							</div>		
						</div>
						</div>
						
					</div>
		
					<table class="w-full border-collapse border border-black">
            		<thead>
                		<tr class="bg-gray-100 rounded-lg">
                    		<th class=" px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Reference</th>
                    		<th class=" px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Designation</th>
                    		<th class=" px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">Quantité</th>
                        </tr>
            		</thead>
            		<tbody>
                		<template x-for="invoice in items" :key="invoice.id">
                  			<tr class="border border-black">
                      			<td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.ref"></td>
                     		    <td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.name"></td>
                      			<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="invoice.qty"></td>
                  			</tr>
                		</template>
            		</tbody>
           			</table>
          			 <div class=" flex justify-between mt-12 mr-0">
              		<div></div>
              		<div class="font-bold">
                		Cachet et Signature
              		</div>
           		  </div>		   
				 </div>
			  </div>				
			</div>	
	
			
			<!-- Print Template -->
			<div id="js-print-template" x-ref="printTemplate" class="hidden">
				    <div class="py-4 border-b border-stone-500">
						<!--<img src="{% static 'media/divatech-logo.png' %}" alt="">-->
					</div>			
					<h2 class="text-3xl text-center py-1 border-b font-bold mb-6 pb-2 tracking-wider uppercase">Bon de transfert du stock</h2>
					<div class="flex justify-between space-x-3 mb-10">
						<div class="w-full border border-black">
							<div class="px-4 py-3 ">		
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Numéro de Bon.</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="invoiceNumber"></div>
							</div>				
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Date de Bon</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="invoiceDate"></div>
							</div>

							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Entrepôt d'arrivé</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text=" from.name"></div>
							</div>		
							<div class="mb-1 flex items-center">
								<label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Entrepôt de Départ</label>
								<span class="mr-4 inline-block">:</span>
								<div x-text="billing.name"></div>
							</div>		
						</div>
						</div>
						
					</div>
		
					<table class="w-full border-collapse border border-black">
            		<thead>
                		<tr class="bg-gray-100 rounded-lg">
                    		<th class=" px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Reference</th>
                    		<th class=" px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Designation</th>
                    		<th class=" px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">Quantité</th>
                        </tr>
            		</thead>
            		<tbody>
                		<template x-for="invoice in items" :key="invoice.id">
                  			<tr class="border border-black">
                      			<td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.ref"></td>
                     		    <td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.name"></td>
                      			<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="invoice.qty"></td>
                  			</tr>
                		</template>
            		</tbody>
           			</table>

					
          			 <div class=" flex justify-between mt-12 mr-0">
              		<div></div>
              		<div class="font-bold">
                		Cachet et Signature
              		</div>
           		  </div>
		   			<script>
						
					</script>
		
			</div>
			<!-- /Print Template -->
			
			<!-- Modal -->
			<div style=" background-color: rgba(0, 0, 0, 0.8)" class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full" x-show.transition.opacity="openModal">
				<div class="p-4 max-w-xl mx-auto relative left-0 right-0 overflow-hidden mt-24">
					<div class="shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
						x-on:click="openModal = !openModal">
						<svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
							<path
								d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
						</svg>
					</div>
					<form action="" id="myForm">
						<div class="shadow w-full rounded-lg bg-white overflow-hidden block p-8">		
							<h2 class="font-bold text-2xl mb-6 text-gray-800 border-b pb-2">Ajouter des produits au bon</h2>
								<div class="mb-4 w-full ">			
													<label class="block text-gray-700 font-semibold mb-2" for="price">
														Produit :
													</label>
													<div class="relative">
														<input type="hidden" :value="selected.value">
														<input type="text" x-model="search" class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline bg-gray-50 text-gray-600 font-medium"
															placeholder="Cliquer pour rechercher ..." @click="optionsVisible = !optionsVisible">
														<div class="absolute bg-white shadow-lg w-full overflow-y-scroll z-40" style="max-height:200px;" x-show="optionsVisible">
															<template x-for="option in filteredOptions()">
																<a class="cursor-pointer border-b py-2 px-2 text-left hover:bg-gray-100" 
																	@click.prevent="
																		item.ref = option.ref;
																		item.name = option.name;
																		showQuantity = true;
																		availableQuantity = option.qty;																		
																		selected = option;
																		optionsVisible = false;
																		search='';

																		"
																	x-text="option.name"
																	style="display: block;"></a>
															</template>
														</div>
														
													</div>
												
									
											<select
												class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
												id="product"
												name="product"
												x-model="item.ref"
												x-on:change="
    												item.ref = $event.target.value;
    												item.name=$event.target.selectedOptions[0].dataset.name;
    												item.rate = $event.target.selectedOptions[0].dataset.price;					
    												item.quantity = $event.target.selectedOptions[0].dataset.quantity;
    												item.livraison_prix = $event.target.selectedOptions[0].dataset.livraison;
    												item.rateLiv =  (parseFloat($event.target.selectedOptions[0].dataset.price) + parseFloat($event.target.selectedOptions[0].dataset.livraison)).toFixed(2);
    												showQuantity = true;
    												availableQuantity =$event.target.selectedOptions[0].dataset.quantity;
												"
												required
												disabled  
											 >
												<option value="" disabled selected>Select product</option>
												<template x-for="stock_item in stocks">
													<option
														x-bind:value="stock_item.ref"
														x-bind:data-name="stock_item.name"
														x-bind:data-price="stock_item.prix"
														x-bind:data-quantity="stock_item.qty"
														x-bind:data-livraison ="stock_item.livraison_prix"
														x-text="stock_item.name"
													>

													</option>
												</template>
											</select>
								</div>
						
								<div class="mb-4">
									<label class="block text-gray-700 font-semibold mb-2" for="quantity">
										Quantity:
										<div class="mb-4" id="productQuantityDiv" style="display: none;" x-show="showQuantity">
											<label class="block text-primary font-medium text-sm mb-2">
												Available Quantity: <span id="productQuantity" x-text="item.qtyAv"></span>
											</label>
										</div>
									</label>
									<input
										class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
										type="number"
										id="quantity"
										name="quantity"
										placeholder="La quantité à transférer ..."
										min="1"
										max="5"
										required
										x-model="item.qty"
									>
								</div>
												
								<div class="mt-8 text-right">
									<button type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded shadow-sm mr-2" @click="openModal = !openModal">
										Cancel
									</button>	
									<button type="button" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-4 border border-gray-700 rounded shadow-sm" @click="addItem()">
										Ajouter Des Produits
									</button>	
								</div>
							</div> 
						</div>
					</form>
				</div>
			</div>
			<!-- /Modal -->
	
		<script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
		<script>															 				
		    function entries() {
				return {
					items:[],
					invoiceNumber:'{{bill.idBon}}',
					invoiceDate: '{{bill.dateBon}}',
					entrepots: [], 
					stocks:[],
					openPreview: false,
					automatiquement:'{{bill.automatiquement}}',
					valide :'{{bill.valide}}' == 'True' ? true : false,
					deleteSelectedItems() {
        				// Filter out the selected invoices and delete them
        				this.items = this.items.filter(invoice => !invoice.selected);
   					 },
					item: {
						id: '',
						name: '',
						ref:'',
						fournisseur:'',
						qtyAV:0,
						qty: 0,
						rate: 0,
						total: 0,					
					},
					totalHt(){
					  return this.items.reduce((total, item) => total + item.total, 0);
					},
					optionsVisible: false,
					availableQuantity:0,
					search: "",
					filteredOptions() {
						return this.stocks.filter((option) => {
							return (option.name.toLowerCase().includes(this.search.toLowerCase()));
						});
					},
					totalTTC(){
					    if (!Array.isArray(this.items) || this.items.length === 0) {
							return 0; // Or whatever default value you prefer
						}

						// Ensure that each item has a numeric total property
						const isValidItem = this.items.every(item => typeof item.total === 'number' && !isNaN(item.total));

						if (!isValidItem) {
							return 0; // Or handle the error appropriately
						}

						const totalhorstax = this.items.reduce((total, item) => total + item.total, 0);
						const floated = 1.19;

						// Check if totalhorstax is a valid number
						if (isNaN(totalhorstax)) {
							return 0; // Or handle the error appropriately
						}

						const result = totalhorstax * floated;

						// Check if the result is a valid number
						if (isNaN(result)) {
							return 0; // Or handle the error appropriately
						}

						return result;
					},
					totalTVA(){
					  return parseFloat(this.items.reduce((total, item) => total + item.total, 0))  * parseFloat(1.19);
					},
					initItems(){
						items= {{items | safe}}
						console.log(items)
						for (const item of items) {					  
					     const item_obj = {	
						   id: this.generateUUID(),			
						   name: item.name,
						   ref: item.ref,
						   rate:item.rate,
						   qty: item.qty,						
						   total:  item.rate * item.qty,
					     };
					     this.items.push(item_obj);
					   }
					   itemsData={{stocks | safe}};
						for (const itemData of itemsData) {		
							console.log(itemData.entrepot)						 
							const item = {
								id: this.generateUUID(),
								name: itemData.product_name,
								ref: itemData.reference,
								ent:itemData.entrepot,
								qty: itemData.quantity,
								prix: itemData.price
							};
							console.log(item.ent)
							this.stocks.push(item);
						}		
					},
					handleFileChange(event) {
										const file = event.target.files[0];
                						if (file) {
                    						const reader = new FileReader();
                    						reader.onload = (e) => {
                        						const data = new Uint8Array(e.target.result);
                        						const workbook = XLSX.read(data, { type: 'array' });
                        						const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        						const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        						console.log(jsonData);
												for (let i = 1; i < jsonData.length; i++) {
        										if (jsonData[i].some(cell => cell !== '')) { // Check if any cell in the row is not empty
            										this.items.push({
                										id: this.generateUUID(),
                										ref: jsonData[i][0],
                										name: jsonData[i][1],
                										qty: parseFloat(jsonData[i][2]),
                										rate: parseFloat(jsonData[i][3]),
                										total: parseFloat(jsonData[i][3]) * parseFloat(jsonData[i][2])
            										});
												
        										}
   												 }
													this.itemTotal();
											this.itemTotalGST();
                    						};
                    						reader.readAsArrayBuffer(file);
											this.$refs.fileInput.value = '';
                						}
					},
					editItem(invoiceData) {
				   		// Set the 'item' data to the selected invoiceData
					  this.showQuantity = true;
					  this.item = {
					    id: invoiceData.id,
					    name: invoiceData.name,
					    ref: invoiceData.ref,
					    qty: invoiceData.qty,
					    rate: invoiceData.rate,
					    total: invoiceData.total,					   
					  };
					 
					 // Open the modal
					 this.operationType = 'update';
					 this.openModal = true;
				    },

					updateItem(){
					 const index = this.items.findIndex((item) => item.id === this.item.id);
					 console.log(items);
					 if (index !== -1) {						
						 this.items[index].total=this.item.qty * this.item.rate;
						this.items[index] = this.item;
					 }
					   // Close the modal after successful update
					 this.openModal = false;
					 
				 	},

					billing: {
						name: '{{bill.store_depart.name}}-{{bill.entrepot_depart.name}}',
						address: '',
						extra: '',
						phone:''
					},
				  
					from: {
						name: '{{bill.store_arrive.name}}-{{bill.entrepot_arrive.name}}',
						address: '',
						extra: ''
					},
	


					showTooltip: false,
					showTooltip2: false,
					showTooltip3: false,
					showTooltip4: false,
					openModal: false,
					showQuantity:false,
	
					showModal(){
						document.getElementById('myForm').reset(); 											
						this.openModal =true;
					},

					getStockItem(entrepotStock){
						this.stocks=[]
						dataObj={
							 nomEnt : entrepotStock,						 
						}
						console.log('fetching the stock  ...',dataObj);
						axios.post('fetchStock', dataObj, {
						headers: {
							'Content-Type': '',
							'X-CSRFToken': getCookie('csrftoken'),
						}
						})
						.then((response) => {
								console.log(response.data.stocks) 
								itemsData=response.data.stocks;
								for (const itemData of itemsData) {		
									console.log(itemData.entrepot)						 
									const item = {
										id: this.generateUUID(),
										name: itemData.product_name,
										ref: itemData.reference,
										ent:itemData.entrepot,
										qty: itemData.quantity,
										prix: itemData.price
									};
									console.log(item.ent)
									this.stocks.push(item);
								}						 
						})
						.catch((error) => {
							alert(error)				
						});
					},
	
					addItem() {
						this.items.push({
							id: this.generateUUID(),
							name: this.item.name,
							qty: this.item.qty,
							rate: this.item.rate,
							total: this.item.qty * this.item.rate,
							ref: this.item.ref,
							fournisseur: this.item.fournisseur,
						
						})

	
						this.item.id = '';
						this.item.name = '';
						this.item.fournisseur='';
						this.item.qty = 0;
						
						document.getElementById('myForm').reset(); 
			
					 
					},
	
					deleteItem(uuid) {
						this.items = this.items.filter(item => uuid !== item.id);				
					
					},
	
	
					generateUUID() {
						return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
							var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
							return v.toString(16);
						});
					},
	
					generateInvoiceNumber(minimum, maximum) {
						const randomNumber = Math.floor(Math.random() * (maximum - minimum)) + minimum;
						this.invoiceNumber = '#BT-'+ randomNumber;
					},
	
					numberFormat(amount) {
						return amount.toLocaleString("fr-FR", {
							style: "currency",
							currency: "DZD"
						});
					},
	
					printInvoice() {
						var printContents = this.$refs.printTemplate.innerHTML;
						var originalContents = document.body.innerHTML;
						document.body.innerHTML = printContents;
						window.print();
						this.printInvoiceBl();
					},
					printInvoiceBl() {
					 var printContents = this.$refs.printTemplateBL.innerHTML;
					 var originalContents = document.body.innerHTML;
					 document.body.innerHTML = printContents;
					 window.print();
					 window.location.reload();
					 document.body.innerHTML = originalContents;
					 this.items=[];
				 },

					validateBon(){
						const dataObj = {
							IdBon : this.invoiceNumber,
							dateBp:this.invoiceDate,
							ent_dep:this.billing,
							ent_arr:this.from,
							produits:this.items,
							
						};

						 axios.post('', {
								formData: dataObj
							}, {
								headers: {
									'Content-Type': '',
									'X-CSRFToken': getCookie('csrftoken'),
								}
							})
							.then((response) => {
								data= response.data
					  			if(data.error){
									alert(data.error);
					 			}else{
									alert("Bon Validé");
					  			}		  
					 		})
							.catch((error) => {
					  			alert(error)
					 		});		
							
					},
					verifying:false,
                    openModalValide: false,
                    success:false,
                    password:'',
					verifyPassword(){
                      		// Set the verifying flag to true to show the loading message
                     		 this.verifying = true;                 
                      		// Make an AJAX request to verify the password
                      		dataObj ={
                          		password : this.password,
                          		idBon: this.invoiceNumber
                      	}
                      axios.post('/verify-password-validation/', dataObj, {
                        headers: {
                          'Content-Type': '',
                          'X-CSRFToken': getCookie('csrftoken'),
                        }
                      })
                        .then(response => {
                          if (response.data.success) {
                            this.success=true;
                            this.openModal = false;
                            this.password=""
                            this.valide=true;
                          
                              // Set a timeout to reset this.success after a certain time
                            setTimeout(() => {
                              this.success = false;
                            }, 1000);
                          } else {
                            alert("false")
                            this.verifying = false;
                            this.openModal = false;
                            this.password=""
                          }
                        })
                        .catch(error => {
                         // Handle any errors that occur during the AJAX request
                         alert(error);
                         this.verifying = false;
                      
                        });
                    }, 
				}
			}
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie !== '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = cookies[i].trim();
						// Does this cookie string begin with the name we want?
						if (cookie.substring(0, name.length + 1) === (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}
		</script>
    </body>	
	<!-- end Main content  -->

  </div>
</div>
</div>
</div>

{% endblock content %}
