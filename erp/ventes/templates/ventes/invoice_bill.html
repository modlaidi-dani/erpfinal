{% extends "base.html" %}
{% load static heroicons %}

{% block body_class %}{% endblock %}

{% block content %}
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' with active_tab="vente" %}
 {% include 'tabs.html' with active_tab="vente" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_ventes.html" %}
   <div class="h-full w-full">
	  <!-- Main content header -->
	  <body class="antialiased sans-serif" x-data="invoices()"
	  x-init="initData()"
	  x-cloak>
		  <div class="h-2"></div> 
			 <div class="container mx-auto py-6 px-4">
			   <div class="flex justify-between">
				  <h2 class="text-2xl font-bold mb-6 pb-2 tracking-wider uppercase">Bon de Livraison PC - CONFIGURATEUR - </h2>
				  <div>				  
			          <div class="relative inline-block">
						<div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip2 = true" @mouseleave="showTooltip2 = false" @click="openPreview=true">
							<svg id='eye_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
									<g transform="matrix(1 0 0 1 12 12)" >
									<g style="" >
									<g transform="matrix(1 0 0 1 0 0)" >
									<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.25 -0.25)" >
									<circle style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" cx="0" cy="0" r="2" />
									</g>
									<g transform="matrix(1 0 0 1 -0.25 -0.25)" >
									<path style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 22 12 C 19.333 16.667 16 19 12 19 C 8 19 4.667 16.667 2 12 C 4.667 7.333 8 5 12 5 C 16 5 19.333 7.333 22 12" stroke-linecap="round" />
									</g>
									</g>
									</g>
							</svg>		  
						</div>
						<div x-show.transition="showTooltip2" class="z-40 shadow-lg text-center w-32 block absolute right-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
							Preview
						</div>
					  </div>
				  </div>
			   </div>
	  
			   <div class="flex mb-8 justify-between">
				  <div class="w-2/4">
					   <div class="mb-2 md:mb-1 md:flex items-center">
						   <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Numéro de Bon</label>
						   <span class="mr-4 inline-block  md:block">:</span>
						   <div class="flex-1">
							  <input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700" id="inline-full-name" type="text" placeholder="eg. #BON-100001" x-model="invoiceNumber">
						   </div>
					   </div>
	  
					   <div class="mb-2 md:mb-1 md:flex items-center">
						   <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Date de Bon</label>
						   <span class="mr-4 inline-block  md:block">:</span>
						   <div class="flex-1">
								<input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700 " type="date" x-model="invoiceDate" {% if request.session.role != 'manager' and request.session.username != 'younes_facturation' %}disabled{% endif %}>
						   </div>
					   </div>
					   
					   <div class="mb-2 md:mb-1 md:flex items-center">
						  <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Bon Commande Associé </label>
						  <span class="mr-4 hidden md:block">:</span>
						  <div class="flex-1">
							  <select
										  class="appearance-none border rounded w-48 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
										  id="echReg"
										  name="echReg"
										  x-on:change="getProducts($event.target.value)
										  item.ent= $event.target.value
										  "
										  required  
									   >
									   <option value="" disabled selected>Aucun</option>
									   {% for bon in bons_commandes %}
										   <option value="{{ bon.idBon}}"  data-products="{{bon.get_produits_json}}"> 
											  {{ bon.idBon}}
										   </option>
									   {% endfor %}
							  </select>
						  </div>
					  </div>
					   <div class="mb-2 md:mb-1 md:flex items-center">
						   <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Entrepot</label>
						   <span class="mr-4 inline-block  md:block">:</span>
						   <div class="flex-1">
									<select
									class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700"
									id="entrepot"
									name="entrepot"
									x-on:change="
										BonEntrepot = $event.target.value;
										getStock($event.target.value);
										item.ent=$event.target.value;
									"
									:disabled="!billing.name"
									required  
								>
								<option value="" disabled selected>Select entrepot</option>
								{% for entrepot in entrepots %}
									<option value="{{ entrepot.name }}" data-stock="{{entrepot.get_stocks}}">
										{{ entrepot.name }} 
									</option>
									{% endfor %}
								</select>
								<p class="text-red-500 font-semibold text-sm">
									Veuillez Spécifier le client Avant de choisir l'entrepot
								</p>
						   </div>
					   </div>
				  </div>
			   </div>
			    <div x-data="{ tab: 1 }" x-cloak class="my-10 antialiased ">
				  <div class="relative flex flex-col rounded-lg shadow-xs overflow-hidden">         
					  <div class="flex space-x-8 bg-white border-b border-gray-200 ">
						  <button
							  type="button"
							  class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
							  x-on:click="tab = 1"
							  :class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 1 }"
						  >
							  Informations Client
						  </button>
						  <button
							  type="button"
							  class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
							  x-on:click="tab = 2"
							  :class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 2 }"
						  >
							  Bon de Livraison
						  </button>
						   <button
							  type="button"
							  class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
							  x-on:click="tab = 4"
							  :class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 4 }"
						  >
						  Modalité de livraison
						  </button>		
						  <button
							  type="button"
							  class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
							  x-on:click="tab = 3"
							  :class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 3 }"
						  >
						  Produits du Bon
						  </button>						  
					  </div>     
					  <div class="">
						  <div x-show="tab === 1">
							  <div class="flex flex-wrap justify-between mb-8 py-4">
									<div class="w-full md:w-1/3 mb-2 md:mb-0">
										<label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Bon Pour :</label>
								   <div class="relative">
														<input type="hidden" :value="selectedClient.value">
														<input type="text" x-model="searchClient" class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline bg-gray-50 text-gray-600 font-medium"
															placeholder="Rechercher client ..." @click="optionsClientVisible = !optionsClientVisible">
														<div class="absolute bg-white shadow-lg w-full overflow-y-scroll z-40" style="max-height:200px;" x-show="optionsClientVisible">
															<template x-for="option in filteredOptionsClients()">
																<a class="cursor-pointer border-b py-2 px-2 text-left hover:bg-gray-100" 
																	@click.prevent="
																		billing.name = option.name;
																		billing.address = option.address;
																		billing.phone = option.phone;
																		billing.solde = option.solde;
																		billing.registreCommerce = option.registreCommerce
																		billing.Nif = option.Nif
																		billing.Nis = option.Nis
																		billing.num_article = option.num_article
																		clientType = option.client_type;
																		selectedClient = option;
																		optionsClientVisible = false;
																		searchClient='';

																	"
																	x-text="option.name"
																	style="display: block;"></a>
															</template>
														</div>
														
													</div>
								   <select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
									  x-model="billing.name"
									  x-on:change="
										billing.name =$event.target.value
										billing.address = $event.target.selectedOptions[0].dataset.address
										billing.phone = $event.target.selectedOptions[0].dataset.phone
										billing.solde = $event.target.selectedOptions[0].dataset.solde
										billing.registreCommerce = $event.target.selectedOptions[0].dataset.registreCommerce
										billing.Nif = $event.target.selectedOptions[0].dataset.Nif
										billing.Nis = $event.target.selectedOptions[0].dataset.Nis
										billing.num_article = $event.target.selectedOptions[0].dataset.num_article
										clientType = $event.target.selectedOptions[0].dataset.typecl
									  ">
												<option value="">Select a client</option>
												<template x-for="client in clients" :key="client.id">
														<option :value="client.name"
														  x-text="client.name" 
														  :data-typecl="client.client_type" 
														  :data-address="client.address" 
														  :data-solde="client.solde" 
														  :data-phone="client.phone"
														  :data-registreCommerce="client.registreCommerce"
														  :data-Nif="client.Nif"
														  :data-Nis="client.Nis"
														  :data-num_article="client.num_article"
														>

														</option>
												</template>
								   </select>
				
										<input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="client-address" type="text" placeholder="Adresse de client" x-model="billing.address">
										<input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="client-phone" type="text" placeholder="Numéro de téléphone" x-model="billing.phone">
										<input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="inline-full-name" type="text" placeholder="Additional info" x-model="billing.extra">
									</div>	
							  </div>
						  </div>     
													   
						  <div x-show="tab === 2">
							  <div class="flex flex-wrap justify-between mb-8 py-4">
							   <div class="w-full md:w-1/3 mb-2 md:mb-0">
								   <div class="mb-4">
									   <label class="block text-gray-700 font-semibold mb-2" for="modReg">
										   Mode de Réglement:
									   </label>
									   <select
										  class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
										  id="modReg"
										  name="modReg"
										  x-on:change="
								  			ModeReglement = $event.target.selectedOptions[0].value;                     
								  			showBanque = $event.target.value == 2;
										  "
										  required  
									   >
									   <option value=""selected > Aucun </option>
									   {% for mode in modeReg %}
										  <option value="{{ mode.id }}" >
											  {{ mode.label }} 
										  </option>
										  {% endfor %}
									   </select>
								   </div>
								   <div class="mb-4">
									  <div >
									  <!-- Show this div when 'cheque' is selected -->
									  <div class="mb-4">
									   <label class="block text-gray-700 font-semibold mb-2" for="banque">
										   Banque :
									   </label>
									   <select
										  class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline cursor-pointer"
										  id="banque"
										  name="banque"														
										  required  
										  x-on:change ="banque = $event.target.selectedOptions[0].value;"
										  >
										  <option value="" disabled selected> Selectionnez  Banque</option>
										  {% for banque in banques  %}
											  <option value="{{banque.pk}}"> {{banque.nom}} </option>
										  {% endfor %}
									   </select>
									</div>
									  <label for="chequeInput" class="block font-bold mt-4"> Numéro de chèque : </label>
									  <input
											  type="text"
											  id="chequeInput"
											  name="chequeInput"
											  x-model="numCheque"
											  class="border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mt-1"
									  	>
									  </div>
								  </div>
								   <div class="mb-4">
									   <label class="block text-gray-700 font-semibold mb-2" for="echReg">
										   Echéance de Réglement	:
									   </label>
									   <select
										  class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
										  id="echReg"
										  name="echReg"
										  x-on:change="
											echeance = $event.target.value
										  "
										  required  
									   >
									   <option value="null" disabled selected>Aucun</option>
									   {% for ech in echeances %}
										  <option value="{{ ech.id }}">
											  {{ ech.label }} 
										  </option>
										  {% endfor %}
									   </select>
								   </div>
								   <label class="block text-gray-700 font-semibold mb-2" for="remise">
									   Remise	:
								   </label>
								   <div class="flex space-x-4 mb-4">
									   {% comment %} <select
										  class="border rounded w-full  px-3 text-gray-700  focus:outline-none focus:shadow-outline"
										  id="echReg"
										  name="echReg"
										  required  
									   >
									   <option value="" disabled selected>Aucune</option>
									   <option value="val" >Valeur</option>
									   <option value="per" >Pourcentage (%)</option>						
									   </select> {% endcomment %}
									   <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white " id="remise" x-model="TotalRemise" type="text" >
								   </div>
								   
								   <div class="mb-4">
									   <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700" id="inline-full-name" type="text" placeholder="Additional info" x-model="billing.extra">
								   </div>
								   {% comment %} <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700" id="client-address" type="text" placeholder="Adresse de client" x-model="billing.address">
								   <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700" id="client-phone" type="text" placeholder="Numéro de téléphone" x-model="billing.phone"> {% endcomment %}			   
							   </div>	
							  </div>					   
						  </div>

						  <div x-show="tab === 4">
                                <div class="flex flex-wrap justify-between mb-8 py-4">
							   <div class="w-full md:w-1/3 mb-2 md:mb-0">
								   <div class="mb-4">
									   <label class="block text-gray-700 font-semibold mb-2" for="modReg">
										   Mode de Livraison:
									   </label>
									   <select
										  class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
										  id="modReg"
										  name="modReg"
										  x-on:change="
								  			modeLivraison = $event.target.selectedOptions[0].value;                     
								  		   $event.target.value === 'ext' ? showmodeLivraison =true : showmodeLivraison =false ;
                                            
										  "
										  required  
									   >
									   <option value=""selected > Aucun </option>									   
										<option value="int" > Interne </option>
										<option value="ext" > Externe </option>
									
									   </select>
								   </div>
								   <div class="mb-4">
									 <div x-show="showmodeLivraison">
									   <!-- Show this div when 'cheque' is selected -->
									   <div class="mb-4">
									     <label class="block text-gray-700 font-semibold mb-2" for="banque">
										    Agence de livraison :
									     </label>
									     <input
											  type="text"
											  id="chequeInput"
											  name="chequeInput"
											  x-model="agenceLivraison"
											  class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700"
									      >
									   </div>	
									   <div class="mb-4">
									     <label class="block text-gray-700 font-semibold mb-2" for="banque">
										    Frais de livraison :
									     </label>
									     <input
											  type="text"
											  id="chequeInput"
											  name="chequeInput"
											  x-model="fraisLivraisonExt"
											  class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700"
									      >
								  	   </div>								  
									 </div>
								  </div>
                                  
							   </div>	
							  </div>
                          </div>
						  
						   <div class="w-full" x-show="tab === 3"> 
						   		 <div class="mb-4">
									     <label class="block text-gray-700 font-semibold mb-2" for="banque">
										    Référence PC :
									     </label>
									     <input
											  type="text"
											  id="chequeInput"
											  name="chequeInput"
											  x-model="reference_pc"
											  class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700"
									      >
								</div>	
								
						   		<div class="mb-4">
									     <label class="block text-gray-700 font-semibold mb-2" for="banque">
										    Désignation PC :
									     </label>
									     <input
											  type="text"
											  id="chequeInput"
											  name="chequeInput"
											  x-model="designation_pc"
											  class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700"
									      >
								</div>	
								<template x-for="(item, index) in items_pc" >
									<table class=" mt-2 border-collapse border-l border-r w-full">
										<thead class="border-b  bg-gray-100  border-t  py-4">
											<tr class="border-b py-4">
												<th class="text-center ">
													<p class="text-gray-800 uppercase tracking-wide text-sm py-4 font-bold">Catégorie</p>
												</th>
												<th class="text-center ">
													<p class="text-gray-800 uppercase tracking-wide text-sm py-4 font-bold">Référence</p>
												</th>
												<th class="text-center">
													<p class="text-gray-800 uppercase tracking-wide text-sm  py-4 font-bold">Désignation</p>
												</th>											
												{% if request.session.role == "manager" %}
													<th class="text-center">
														<p class="text-gray-800 uppercase tracking-wide text-sm py-4 font-bold">PVU HT</p>
													</th>
													<th class="text-center">
														<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">P.FR</p>
													</th>
													<th class="text-center">
														<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">TAX</p>
													</th>
												{% endif %}
												<th class="text-center">
													<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">qtT</p>
												</th>
												<th class="text-center">
													<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">pvu ttc</p>
												</th>
												<th class="text-center">
													<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">PVU HT</p>
												</th>
												<th class="text-center">
													<p class="text-gray-800 uppercase tracking-wide text-sm py-4 font-bold">Quantité</p>
												</th>
												<th class="text-center">
													<p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Total HT</p>
												</th>
												<th class="px-1 text-center"></th>
											</tr>
										</thead>
										<tbody>	
											<template x-for="(invoice, index) in item.items" >
												<tr class=" -mx-1 py-2 border-b" x-show="invoice.label.display != 'Extras' && invoice.products.ref != undefined">
													<td class="px-1 text-center">
														<p class="text-gray-800" x-text="invoice.label.display"></p>
													</td>
													<td class="px-1 text-center">
														<p class="text-gray-800" x-text="invoice.products.ref"></p>
													</td>
													<td class="px-1 text-center">
														<p class="text-gray-800" x-text="invoice.products.name"></p>
													</td>
													{% if request.session.role == "manager" %}
														<td class="px-1 text-center">
															<p class="text-gray-800" x-text="numberFormat(invoice.products.rate)"></p>
														</td>
														<td class="px-1 text-center">
															<p class="text-gray-800" x-text="numberFormat(invoice.products.livraison_prix)"></p>
														</td>
														<td class="px-1 text-center">
															<p class="text-gray-800" x-text="numberFormat(invoice.products.tax)"></p>
														</td>
													{% endif %}
													<td class="px-1 text-center">
														<p class="text-gray-800" x-text="(invoice.products.rateLiv) * 1.19"></p>
													</td>
													<td class="px-1 text-center">
														<p class="text-gray-800" x-text="invoice.products.qty"></p>
													</td>
													<td class="px-1 text-center" :rowspan="index === 0 ? item.items.length : 1" x-show="index === 0 ">
														<p class="text-gray-800" x-text="totalPCHt(index)"></p>
													</td>
													<td class="px-1 text-center" :rowspan="index === 0 ? item.items.length   : 1" x-show="index === 0 ">
														<p class="text-gray-800" x-text="item.qty"></p>
													</td>
													<td class="px-1 text-center" :rowspan="index === 0 ? item.items.length   : 1" x-show="index === 0 ">
														<p class="text-gray-800" x-text="totalPCHt(index) * item.qty"></p>
													</td>
													<td class="px-1 flex text-center">
													<a href="#" class="text-green-950 text-sm font-semibold" @click.prevent="referencePCedit = item.reference_pc; editItem(invoice)">{% heroicon_mini "pencil-square" class="transition-transform" %}</a>	
													</td>
												</tr>
										
											</template>
										</tbody>
									</table>   
								</template>
								<div class="flex justify-between ">
									<div></div>
								</div>
							    <button class="mt-6 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 text-sm border border-gray-300 rounded shadow-sm" x-on:click="showModal">
									Ajouter des produits
								</button>

						   </div>
					  </div> 
			      </div> 
				</div> 

	  
			  <div class="py-2 ml-auto mt-5 w-full border-t">
			     <div class="border-b bg-gray-100 p-2 mb-2">
			       {% if request.session.role == "manager" %}
						<div class="flex justify-between mb-3">
							<div class="text-gray-800 text-right flex-1">Total HT [Sans Livraison]</div>
							<div class="text-right w-40">
								<div class="text-gray-800 font-medium" x-html="numberFormat(netTotal)"></div>
							</div>
						</div>
						<div class="flex justify-between mb-3">
						<div class="text-gray-800 text-right flex-1">Total TTC [Sans Livraison]</div>
						<div class="text-right w-40">
							<div class="text-gray-800 font-medium" x-html="numberFormat(netTotal * 1.19)"></div>
						</div>
						</div>
						<div class="flex justify-between mb-4">
							<div class="text-sm text-gray-600 text-right flex-1">Frais Livraison [ INTERNE ]</div>
							<div class="text-right w-40">
								<div class="text-sm text-gray-600" x-html="numberFormat(fraisLivraison)"></div>
							</div>
						</div> 
						<div class="flex justify-between mb-4">
							<div class="text-sm text-gray-600 text-right flex-1">TAX</div>
							<div class="text-right w-40">
								<div class="text-sm text-gray-600" x-html="numberFormat(tax)"></div>
							</div>
						</div> 
				    {% endif %}
				  </div>
			     <div class="flex justify-between mb-3">
				  	  <div class="text-gray-800 text-right flex-1">Total HT</div>
					  <div class="text-right w-40">
						  <div class="text-gray-800 font-medium" x-html="totalHtFinal"></div>
					  </div>
				  </div>
                   <div class="flex justify-between mb-4">
					  <div class="text-sm text-gray-600 text-right flex-1">Remise </div>
					  <div class="text-right w-40">
						  <div class="text-sm text-gray-600" x-text="TotalRemise"></div>
					  </div>
				  </div>   
                   <div class="flex justify-between mb-4">
					  <div class="text-sm text-gray-600 text-right flex-1">Sous Total HT </div>
					  <div class="text-right w-40">
						  <div class="text-sm text-gray-600" x-text="subTotalFinal"></div>
					  </div>
				  </div>   
			      <div class="flex justify-between mb-3">
				  	  <div class="text-gray-800 text-right flex-1">Total TTC</div>
					  <div class="text-right w-40">
						  <div class="text-gray-800 font-medium" x-text="totalTTc"></div>
					  </div>
				  </div>
				 
				  <div class="flex justify-between mb-4">
					  <div class="text-sm text-gray-600 text-right flex-1">Frais Livraison</div>
					  <div class="text-right w-40">
						  <div class="text-sm text-gray-600" x-html="numberFormat(fraisLivraisonExt)"></div>
					  </div>
				  </div>

				 
			  
				  <div class="py-2 border-t border-b">
					  <div class="flex justify-between">
						  <div class="text-xl text-gray-600 text-right flex-1">Net À Payer</div>
						  <div class="text-right w-40">
							  <div class="text-xl text-gray-800 font-bold" x-text="totaltoPay"></div>
						  </div>
					  </div>
				  </div>

				  <div class="flex justify-between">
					  <div></div>
					  <button class="mt-6 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 text-sm border border-gray-300 rounded shadow-sm" type="submit" x-on:click="VerifyBon">Valider le Bon & imprimer</button>
			   		</div>
			   </div>
			  
			  
				<div style=" background-color: rgba(0, 0, 0, 0.8)" class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full py-8" x-show.transition.opacity="openPreview">	
				   <div class="shadow absolute -right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
						x-on:click="openPreview = !openPreview">
						<svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
							<path
								d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
						</svg>
				   </div>
			       <div class="p-4 w-1/3 mx-auto relative left-0 right-0 overflow-hidden  bg-white h-full "  x-on:click.away="openPreview = !openPreview">
				     		  <div class="py-4 border-b border-stone-500">
					             <img src="{% static 'media/divatech-logo.png' %}" alt="">
				   				</div>
		  
				  <h2 class="text-3xl font-bold mb-6 pb-2 tracking-wider uppercase">Bon de Livraison</h2>
				  <div class="flex justify-between space-x-3 mb-10">
					  <div class="w-1/2 border border-black">
						  <div class="px-4 py-3 ">		
						  <div class="mb-1 flex items-center">
							  <label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Numéro de Bon.</label>
							  <span class="mr-4 inline-block">:</span>
							  <div x-text="invoiceNumber"></div>
						  </div>				
						  <div class="mb-1 flex items-center">
							  <label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Date de Bon</label>
							  <span class="mr-4 inline-block">:</span>
							  <div x-text="invoiceDate"></div>
						  </div>
					  </div>
					  </div>
					  <div class="w-1/2 border border-black">
						   <div class="px-4 py-3 ">
							  <div class="mb-1 flex items-center">
								  <label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Client </label>
								  <span class="mr-4 inline-block">:</span>
								  <div x-text="billing.name"></div>
							  </div>
							  <div class="mb-1 flex items-center">
								  <label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Adresse </label>
								  <span class="mr-4 inline-block">:</span>
								  <div x-text="billing.address"></div>
							  </div>
							  <div class="mb-1 flex items-center">
								  <label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Extra </label>
								  <span class="mr-4 inline-block">:</span>
								  <div x-text="billing.extra"></div>
							  </div>								
						   </div>
					  </div>
				  </div>
	  
				 <table class="w-full border-collapse border border-black">
		   		   <thead>
			  		<tr class="bg-gray-100">
				  		<th class="border border-black px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Reference</th>
				  		<th class="border border-black px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Designation</th>
				  		<th class="border border-black px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">Quantité</th>
				  		<th class="border border-black px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">P.U</th>
				  		<th class="border border-black px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">M. HT</th>
			  		</tr>
		   		   </thead>
		   		   <tbody>
			  		<template x-for="invoice in items" >
						<tr class="border border-black">
							<td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.products.ref"></td>
							<td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.products.name"></td>
							<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="invoice.products.qty"></td>
							<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="numberFormat(invoice.products.rate)"></td>
							<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="numberFormat(invoice.products.total)"></td>
						</tr>
			  		</template>
		   		   </tbody>
				 </table>

				 <div class="w-full flex mt-4  space-x-3 ">
		  		  <table class="w-1/3 table-auto  border-collapse border border-black">
					<thead>
						<tr class="bg-gray-100">
							<th class="border border-gray-700 px-4 ">TVA</th>
							<th class="border border-gray-700 px-4 ">Total TVA</th>                     
						</tr>
					</thead>
					<tbody>
					  <tr class="border border-gray-700">
						 <td class="border border-gray-700 px-4 ">19 %</td>
						 <td class="border border-gray-700 px-4 "x-text="totalGST"></td> 
					  </tr>
					</tbody>
		  		  </table>
		          <table class="w-2/3 h-fit table-auto border-collapse border border-black">
			  		<thead>
				  		<tr class="bg-gray-100">
					  		<th class="border border-gray-700 px-4 ">Total Remise</th>
					  		<th class="border border-gray-700 px-4 ">Total HT</th>
					  		<th class="border border-gray-700 px-4 ">Total TTC</th>
					  		<th class="border border-gray-700 px-4 ">Net à Payer</th>
				  		</tr>
			  		</thead>
			  		<tbody>
				     <!-- Sample data rows -->
				  		<tr class="border border-gray-700">
					  		<td class="border border-gray-700 px-4" x-text="(TotalRemise).toFixed(2)"></td>
					  		<td class="border border-gray-700 px-4" x-text="(netTotal).toFixed(2)"></td>
					  		<td class="border border-gray-700 px-4" x-text="(TotalPay).toFixed(2)"></td>
					  		<td class="border border-gray-700 px-4" x-text="(TotalPay).toFixed(2)" ></td>
				  		</tr>
				  		<tr>
							<td class="border border-gray-700 px-4 py-2" colspan="5">
					  		<div class="flex space-x-1 items-center">
								<p class="text-center">
						  		Solde : 
								</p>             
					  		</div>
					 		</td>
				  		</tr>
				        <!-- Add more rows as needed -->
			  		</tbody>
		  		  </table>
		         </div>
		         <div class=" flex justify-between mt-12 mr-0">
					<div></div>
					<div class="font-bold">
			  		Cachet et Signature
					</div>
			     </div>
			     </div>
				</div>
			      				
			     
	  
			  
			   <!-- Print Template -->
			   <div id="js-print-template" x-ref="printTemplate" class="hidden">
				  <div class="py-4 border-b border-stone-500">
					  <img src="{% static 'media/divatech-logo.png' %}" alt="">
				  </div>
				  <h2 class="text-3xl text-center font-bold mb-6 pb-2 tracking-wider uppercase">Bon de Livraison</h2>
				  <div class="flex justify-between space-x-3 mb-10">
					  <div class="w-1/2 border border-black">
						  <div class="px-4 py-3 ">		
						  <div class="mb-1 flex items-center">
							  <label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Numéro de Bon.</label>
							  <span class="mr-4 inline-block">:</span>
							  <div x-text="invoiceNumber"></div>
						  </div>				
						  <div class="mb-1 flex items-center">
							  <label class="w-32 text-gray-800 block font-bold text-xs uppercase tracking-wide">Date de Bon</label>
							  <span class="mr-4 inline-block">:</span>
							  <div x-text="invoiceDate"></div>
						  </div>
					  </div>
					  </div>
					  <div class="w-1/2 border border-black">
						   <div class="px-4 py-3 ">
							  <div class="mb-1 flex items-center">
								  <label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Client </label>
								  <span class="mr-4 inline-block">:</span>
								  <div x-text="billing.name"></div>
							  </div>
							  <div class="mb-1 flex items-center">
								  <label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Adresse </label>
								  <span class="mr-4 inline-block">:</span>
								  <div x-text="billing.address"></div>
							  </div>
							  <div class="mb-1 flex items-center">
								  <label class="w-20 text-gray-800 block font-bold text-xs uppercase tracking-wide">Extra </label>
								  <span class="mr-4 inline-block">:</span>
								  <div x-text="billing.extra"></div>
							  </div>								
						   </div>
					  </div>
				  </div>
	  
				<table class="w-full border-collapse border border-black">
		   		<thead>
			  		<tr class="bg-gray-100">
				  		<th class="border border-black px-1 py-2 text-black uppercase tracking-wide text-sm font-bold">Reference</th>
				  		<th class="border border-black px-1 py-2 text-black uppercase tracking-wide text-sm font-bold" colspan="2">Designation</th>
				  		<th class="border border-black px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">Quantité</th>
				  		<th class="border border-black px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">P.U</th>
				  		<th class="border border-black px-1 py-2 w-32 text-right text-black uppercase tracking-wide text-sm font-bold">M. HT</th>
			  		</tr>
		   		</thead>
		   				<tbody>        
								<template x-for="(item, index) in items_pc">
									<template x-for="(invoice, index) in item.items">
										<tr class=" -mx-1 py-2 " x-show="invoice.products.name != undefined">
											<td class="px-1 border-r border-black  text-center" :rowspan="index === 0 ? item.items.length  : 1" x-show="index === 0 ">
												<p class="text-gray-800" x-text="item.reference_pc"></p>
											</td>
											<td class="px-1 border-r border-black  text-center" colspan="2">
												<p class="text-gray-800 text-left font-bold" x-text="item.designation_pc" x-show="index === 0 "></p>
												<p class="text-gray-800" x-text="'- ' +invoice.products.name"></p>
											</td>
											<td class="px-1 text-center" :rowspan="index === 0 ? item.items.length  : 1" x-show="index === 0 ">
												<p class="text-gray-800" x-text="(item.netTotalLiv /item.qty).toFixed(2)"></p>
											</td>
											<td class="px-1 text-center" :rowspan="index === 0 ? item.items.length   : 1" x-show="index === 0 ">
												<p class="text-gray-800" x-text="item.qty"></p>
											</td>
											<td class="px-1 text-center" :rowspan="index === 0 ? item.items.length   : 1" x-show="index === 0 ">
												<p class="text-gray-800" x-text="(item.netTotalLiv).toFixed(2)"></p>
											</td>									
										</tr>
									</template>
								  </template>	
						</tbody>
				</table>

						<div class="w-full flex mt-4  space-x-3 ">
							<table class="w-1/3 table-auto  border-collapse border border-black">
							<thead>
								<tr class="bg-gray-100">
									<th class="border border-gray-700 px-4 ">TVA</th>
									<th class="border border-gray-700 px-4 ">Total TVA</th>                     
								</tr>
							</thead>
							<tbody>
								<!-- Sample data rows -->
								<tr class="border border-gray-700">
									<td class="border border-gray-700 px-4 ">19 %</td>
									<td class="border border-gray-700 px-4 "x-text="totalGSTLiv"></td> 
								</tr>
								<!-- Add more rows as needed -->
							</tbody>
						</table>
						<table class="w-2/3 h-fit table-auto border-collapse border border-black">
							<thead>
								<tr class="bg-gray-100">
									<th class="border border-gray-700 px-4 ">Total Remise</th>
									<th class="border border-gray-700 px-4 ">Total HT</th>
									<th class="border border-gray-700 px-4 ">Total TTC</th>
									<th class="border border-gray-700 px-4 ">Net à Payer</th>
								</tr>
							</thead>
							<tbody>
								<!-- Sample data rows -->
								<tr class="border border-gray-700">
									<td class="border border-gray-700 px-4" x-text="TotalRemise"></td>
									<td class="border border-gray-700 px-4" x-text="totalnetTotalLiv"></td>
									<td class="border border-gray-700 px-4" x-text="(totalnetTotalLiv * 1.19).toFixed(2)"></td>
									<td class="border border-gray-700 px-4" x-text="(totalnetTotalLiv * 1.19).toFixed(2) - parseFloat(TotalRemise)" ></td>
								</tr>
								<tr>
									<td class="border border-gray-700 px-4 py-2" colspan="5">
									<div class="flex space-x-1 items-center">
										<p class="text-left">
								    	Solde : 
								    	<span class="font-semibold"> 0 DZD </span>
										</p>          
									</div>
									</td>
								</tr>
								<!-- Add more rows as needed -->
							</tbody>
						</table>
						</div>
						<div class=" flex justify-between mt-12 mr-0">
							<div></div>
							<div class="font-bold">
							Cachet et Signature
							</div>
						</div>
							</div>
			   <!-- /Print Template -->
	  
			  <div x-show="showConfirmation" style=" background-color: rgba(0, 0, 0, 0.8);" class="fixed inset-0 z-50 overflow-y-auto ">
				  <div class="flex items-end justify-center min-h-screen px-4 text-center md:items-center sm:block sm:p-0">
						  <div x-cloak x-show="showConfirmation"
								  x-transition:enter="transition ease-out duration-300 transform"
								  x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
								  x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
								  x-transition:leave="transition ease-in duration-200 transform"
								  x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
								  x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
								  class="inline-block  w-1/2 mx-auto p-6 my-10 overflow-hidden text-left transition-all transform bg-white rounded-lg shadow-xl "
						  >
								  <div class="flex items-center justify-between space-x-4">
										  <h1 class="text-xl font-bold text-gray-800 ">Entrepots Différents</h1>
								  </div>
								  <h2 class="text-xl font-bold text-gray-800 ">Il existent des produits avec entrepôt différent d'entrepot du bon.</h2>
								  <p class="mt-2 text-md text-gray-800 ">
									  Voulez Vous Créer un bon de transfert automatiquement ?
							  </p>
								  <button @click="showDetails = !showDetails">show more details</button>
							  <div x-show="showDetails" >
								  <table>
									  <thead>
										  <tr>
											  <th>Reference</th>
											  <th>Entrepot</th>
										  </tr>
									  </thead>
									  <tbody>
										  <template x-for="prdouct in productsdifferent">
											  <tr>
												  <td >
													  <p x-text="product.ref"></p>
												  </td>
												  <td >
													  <p x-text="product.entrepot"></p>
												  </td>
											  </tr>
										  </template>
									  </tbody>
								  </table>
							  </div>
								  
										  <div class="flex justify-end mt-6">
												  <button for="show"
												    @click="showConfirmation = false; validateBon()" type="button" class="mr-2 px-2 py-2 text-sm tracking-wide text-black capitalize transition-colors duration-200 transform border border-gray-700 hover:bg-gray-700 rounded-md shadow-md">
														  Ne pas créer
												  </button>
			 									  <button for="show"
												    @click="showConfirmation = false; creationAutomatique=true; validateBon() " type="button" class="mr-2 px-2 py-2 text-sm tracking-wide text-white capitalize transition-colors duration-200 transform bg-gray-700  rounded-md shadow-md">
														  Confirmer création
												  </button>                                     
										  </div>
								  
						  </div>
				  </div>
			  </div>

			   <!-- Modal -->
			   <div style=" background-color: rgba(0, 0, 0, 0.8); " class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full overflow-y-scroll" x-cloak x-show.transition.opacity="openModal">
				  <div class="p-4 max-w-xl mx-auto relative left-0 right-0 overflow-hidden mt-10">
					  <div class="shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
						  x-on:click="openModal = !openModal">
						  <svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
							  <path
								d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
						  </svg>
					  </div>
					  <form  class="w-full rounded-lg bg-white" action="" id="myForm">
						<div class="shadow w-full rounded-lg bg-white overflow-hidden block p-8">		
							<h2 class="font-bold text-2xl mb-6 text-gray-800 border-b pb-2">Ajouter des produits au bon</h2>
							<div class="mx-auto px-4">			
								<div x-show.transition="Currentstep != 'complete'">	
									<!-- Top Navigation -->
									<div class="border-b-2">
										<div class="flex flex-col md:flex-row md:items-center md:justify-between">
										    <div class="block">
											<div class="uppercase tracking-wide text-xs font-bold text-gray-500 mb-1 leading-tight" x-text="`Etape: ${Currentstep} de ${steps.length}`"></div>
											<template x-for="(step, index) in items" :key="index">
												<div x-show="Currentstep === index + 1">
												<div class="text-lg font-bold text-gray-700 leading-tight" x-text="step.label.display"></div>
												</div>
											</template>
											</div>
											
					
											<div class="flex items-center md:w-64">
												<div class="w-full bg-white rounded-full mr-2">
													<div class="rounded-full bg-green-500 text-xs leading-none h-2 text-center text-white" :style="'width: '+ parseInt(Currentstep / steps.length * 100) +'%'"></div>
												</div>
												<div class="text-xs w-10 text-gray-600" x-text="parseInt(Currentstep / steps.length * 100) +'%'"></div>
											</div>
										</div>
										</div>
									</div>
									<!-- /Top Navigation -->
					
									<!-- Step Content -->
									<div class="py-2">											
											<div x-show.transition.in="Currentstep <= steps.length">
												<div class="mb-4">
													<label class="block text-gray-700 font-semibold mb-2" for="product">
													Entrepot :
													</label>
													<select
													class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
													id="entrepot"
													name="entrepot"
													x-model="item.ent"
													x-on:change="
														getStock($event.target.value)
														item.ent= $event.target.value
													"
													required  
													>
													<option value="" disabled selected>Select entrepot</option>					  
													{% for entrepot in entrepots %}
													<option value="{{ entrepot.name }}" data-stock="{{entrepot.get_stocks}}">
														{{ entrepot.name }} 
													</option>
													{% endfor %}
													</select>
												</div>
												{% if request.session.store != '1' and request.session.store != '2' and request.session.store != '8' %}
													<div>
														<div class=" w-full flex flex-between items-center space-x-4">
															<label
															class="block text-md font-medium leading-6 text-gray-900"
															>Produits à Facturer:</label
															>
															<button @click="showQuantities = !showQuantities" class="text-gray-700 cursor-pointer">
																<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
																	<path  x-show="!showQuantities"  stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
																	<path x-show="showQuantities" stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
																</svg>			
															</button>   
														</div>
														<input type="hidden" :value="selected.value">
														<input type="text" x-model="search" class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline bg-gray-50 text-gray-600 font-medium"
															placeholder="Cliquer pour rechercher ..." @click="optionsVisible = !optionsVisible">
														<div class="w-full overflow-auto" style="max-height: 450px;">                               
															<ul class="border p-4">
																<template x-for="option in filteredToFacture()">
																	<li class="cursor-pointer flex  space-x-2 text-sm font-normal"
																	 @click="
																		item.reference = option.ref;
																		item.name = option.name;
																		showQuantity = true;
																		availableQuantity = option.qty;
																		item.rate = option.prix;
																		item.livraison_prix = option.livraison_prix;
																		item.tax = option.tax;
																		item.rateLiv = parseFloat(option.prix) + parseFloat(option.tax) + parseFloat(option.livraison_prix);
																		item.ent = option.ent;
																		selected = option;
																	">
																	
																		<span x-text="option.name" :class="{ 'text-blue-500': isSelected(option) }"></span><span class="text-red-500 font-bold" x-text="' -> ' + option.qty_facture"></p>
																	</li>
																</template>
															</ul>
															
														</div>	
													</div>

												{% endif %}
												
													<div class="mb-4 w-full ">			
														<label class="block text-gray-700 font-semibold mb-2" for="price">
															Produit :
														</label>
														<div class="relative">
															<input type="hidden" :value="selected.value">
															<input type="text" x-model="search" class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline bg-gray-50 text-gray-600 font-medium"
																placeholder="Cliquer pour rechercher ..." @click="optionsVisible = !optionsVisible">
															<div class="absolute bg-white shadow-lg w-full overflow-y-scroll z-40" style="max-height:200px;" x-show="optionsVisible">
																<template x-for="option in filteredOptions()">
																	<a class="cursor-pointer border-b py-2 px-2 text-left hover:bg-gray-100" 
																		@click.prevent="
																			item.reference = option.ref;
																			item.name = option.name;
																			showQuantity = true;
																			availableQuantity = option.qty;
																			item.rate = option.prix;
																			item.livraison_prix = option.livraison_prix;
																			item.tax = option.tax;
																			item.rateLiv = parseFloat(option.prix) + parseFloat(option.tax) + parseFloat(option.livraison_prix);
																			item.ent = option.ent;
																			selected = option;
																			optionsVisible = false"
																		x-text="option.ref +' - '+ option.name"
																		style="display: block;"></a>
																</template>
															</div>
															<div class="mb-5 py-4">
																<input type="text"
																	x-model="item.reference"
																	x-text="selected.label"
																	class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline border-gray-700 text-gray-600 font-medium"
																	placeholder="Référence Produit"
																	disabled>
															</div>
														</div>
													</div>
												<div class="mb-4">					  			
													<label class="block text-gray-700 font-semibold mb-2" for="quantity">
														Quantity:
														<div class="mb-4" id="productQuantityDiv" style="display: none;" x-show="showQuantity">
														<label class="block text-primary font-medium text-sm mb-2">
															Available Quantity: <span id="productQuantity" x-text="availableQuantity"></span>
														</label>
														</div>
													</label>
													<input
														class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
														type="number"
														id="quantity"
														name="quantity"
														placeholder="Enter quantity"
														min="1"
														max="5"
														required
														x-model="item.qty"
														x-bind:max="selectedProductQuantity"
													>
													<div class="mb-4" x-show="qte_requis > 0">
														<label class="block text-red-700 font-medium text-sm mb-2">
															Quantité Obligatoire : <span id="productQuantity" x-text="qte_requis"></span>
														</label>
													</div>	
												</div>	  
												<div class="mb-4">
													<label class="block text-gray-700 font-semibold mb-2" for="price">
														Prix HT:
													</label>
													<input
														class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
														type="text"
														id="price"
														name="price"
														placeholder="Price will be fetched automatically"
														x-model="item.rateLiv"
													>
													<p class="text-gray-700 font-semibold mb-2"> Prix TTC : <span class="font-bold" x-text="(item.rateLiv * 1.19*item.qty).toFixed(2)"></span></p>
													</div>
													
												</div>
													</div>
													<!-- / Step Content -->
												</div>
							</div>
					
							<!-- Bottom Navigation -->	
							<div class=" bottom-0  left-0 right-0 py-5 shadow-md" x-show="Currentstep != 'complete'">
								<div class=" mx-auto px-4">
									<div class="flex justify-between">
									 	<div class="w-1/2">
											<button
												x-show="Currentstep > 1"
												@click.prevent="goPrevious();"										
												class="w-32 focus:outline-none border border-transparent py-2 px-5 rounded-lg shadow-sm text-center  font-medium" 
											>Précédent</button>
										</div> 
					
										<div class="w-1/2 text-right">
											<button
												x-show="Currentstep < steps.length"
												@click.prevent="addItem(); goNext();"
												:class="{ 'bg-gray-200 text-gray-150 cursor-not-allowed': !checkQuantityConditions() }"										
												:disabled="!checkQuantityConditions()"
												class="w-32 focus:outline-none border border-transparent py-2 px-5 rounded-lg shadow-sm text-center  font-medium" 
											>Suivant</button>
					
											<button
												@click.prevent="addItem(); endPcBuild() "
												x-show="Currentstep === steps.length"
												class="w-32 focus:outline-none border border-transparent py-2 px-5 rounded-lg shadow-sm text-center text-white bg-gray-700 hover:bg-gray-600 font-medium" 
											>Complete</button>
										</div>
									</div>
								</div>
							</div>
							<!-- / Bottom Navigation https://placehold.co/300x300/e2e8f0/cccccc -->	
						</div>
					  </form>
				  </div>
			   </div>
			 
			 	<!-- Modal Modification -->
				<div style=" background-color: rgba(0, 0, 0, 0.8); " class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full overflow-y-scroll" x-cloak x-show.transition.opacity="openModalModification">
					<div class="p-4 max-w-xl mx-auto relative left-0 right-0 overflow-hidden mt-24">
							<div class="shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
								x-on:click="openModalModification = !openModalModification">
								<svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
									<path
										d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
								</svg>
							</div>
							<form action="" id="myForm">
										<div class="shadow w-full rounded-lg bg-white overflow-hidden block p-8">		
										<h2 class="font-bold text-2xl mb-6 text-gray-800 border-b pb-2">Modifier Un produit - <span x-text="referencePCedit"></span> </h2>
										<div class="mb-4 w-full ">			
											<label class="block text-gray-700 font-semibold mb-2" for="price">
												Catégorie :
											</label>
										<select
												class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
												id="product"
												name="product"
												x-model="category"
												x-on:change="
												 currentStep = $event.target.value;
												"
												required
												disabled
												>
												<option value="" disabled selected>Select product</option>
												<template x-for="(item,index) in items" :key="index">
													<option
														x-bind:value="index"
														x-text="item.label.display"
													>
													</option>
												</template>
											</select>
										<div class="mb-4 w-full ">			
											<label class="block text-gray-700 font-semibold mb-2" for="price">
												Produit :
											</label>

											<div class="relative">
												<input type="hidden" :value="selected.value">
												<input type="text" x-model="search" class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline bg-gray-50 text-gray-600 font-medium"
													placeholder="Cliquer pour rechercher ..." @click="optionsVisible = !optionsVisible">
												<div class="absolute bg-white shadow-lg w-full overflow-y-scroll z-40" style="max-height:200px;" x-show="optionsVisible">
													<template x-for="option in filteredOptions()">
														<a class="cursor-pointer border-b py-2 px-2 text-left hover:bg-gray-100" 
															@click.prevent="
																itemedit.ref = option.ref;
																itemedit.name = option.name;
																showQuantity = true;
																availableQuantity = option.qty;
																itemedit.rate = option.prix;
																itemedit.tax = option.tax;
																itemedit.livraison_prix = option.livraison_prix;
																itemedit.rateLiv = (parseFloat(option.prix) + parseFloat(option.livraison_prix) + parseFloat(option.tax)).toFixed(2);
																itemedit.ent = option.ent;
																selected = option;
																optionsVisible = false;
																search='';

															"
															x-text="option.name"
															style="display: block;"></a>
													</template>
												</div>
												
											</div>

											<select
												class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
												id="product"
												name="product"
												x-model="itemedit.ref"
												x-on:change="
													itemedit.ref = $event.target.value;
													itemedit.name=$event.target.selectedOptions[0].dataset.name;
													itemedit.rate = $event.target.selectedOptions[0].dataset.price;					
													itemedit.quantity = $event.target.selectedOptions[0].dataset.quantity;
													itemedit.livraison_prix = $event.target.selectedOptions[0].dataset.livraison;
													itemedit.rateLiv =  (parseFloat($event.target.selectedOptions[0].dataset.price) + parseFloat($event.target.selectedOptions[0].dataset.livraison)).toFixed(2);
													showQuantity = true;
													availableQuantity =$event.target.selectedOptions[0].dataset.quantity;
												"
												required
												disabled  
												>
												<option value="" disabled selected>Select product</option>
												<template x-for="stock_item in stocks">
													<option
														x-bind:value="stock_item.ref"
														x-bind:data-name="stock_item.name"
														x-bind:data-price="stock_item.prix"
														x-bind:data-quantity="stock_item.qty"
														x-bind:data-livraison ="stock_item.livraison_prix"
														x-text="stock_item.name"
													>

													</option>
												</template>
											</select>
										</div>
							
										<div class="mb-4">
											<label class="block text-gray-700 font-semibold mb-2" for="quantity">
												Quantity:
												<div class="mb-4" id="productQuantityDiv" style="display: none;" x-show="showQuantity">
												<label class="block text-primary font-medium text-sm mb-2">
													Available Quantity: <span id="productQuantity" x-text="availableQuantity"></span>
												</label>
												</div>
											</label>
											<input
												class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
												type="number"
												id="quantity"
												name="quantity"
												placeholder="Enter quantity"
												min="1"
												max="5"
												required
												x-model="itemedit.qty"
											>
											<div class="mb-4" id="productQuantityDiv" x-show="quantityRequired > 0" >
												<label class="block text-red-700 font-medium text-sm mb-2">
													Quantité Obligatoire : <span id="productQuantity" x-text="quantityRequired"></span>
												</label>
											</div>
										</div>	 

										<div class="mb-4">
											<label class="block text-gray-700 font-semibold mb-2" for="price">
												Price:
											</label>
											<input
												class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
												type="text"
												id="price"
												name="price"
												placeholder="Price will be fetched automatically"
												x-model="itemedit.rateLiv"
												{% if request.session.role != "manager" %} disabled {% endif %}
											>
										</div>
											
										<div class="mt-8 text-right">
											<button type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded shadow-sm mr-2" @click="openModalModification = !openModalModification">
												Cancel
											</button>	
											<button type="button" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-4 border border-gray-700 rounded shadow-sm"
													x-on:click="validerModification();	">
												<span> Modifier </span>
											</button>		
										</div>
								</div> 				  
								</div>
							</form>
					</div>
				</div>
			    <!-- /Modal Modification -->	
		  </div>
		  
		<script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
		<script>			
			function invoices() {
					return {
							items: [],
							items_pc:[],
							clients:[],
							stocks:[],
							stockFiltered:[],					 
							productsdifferent :[],
							quantityRequired:'',
							invoiceNumber: '{{code}}',
							reference :[],
							designation:[],
							isSelected(item){
								return this.selected.ref == item.ref
							},
							invoiceDate: new Date().toISOString().slice(0, 10),
							invoiceDueDate: '',
							referencePCedit:'',
							reference_pc:'',
							designation_pc:'',
							BonEntrepot:'',
							clientType:'',
							availableQuantity:0,
							qte_requis:0,
							showConfirmation:false,
							totalGST: 0,
							openPreview:false,
							netTotal: 0,
							TotalRemise :0,
							TotalPay:0,
							tax:0,
							showModalConfirmation:false,
							showBanque:false,
							banque:'',
							allProducts:[],
							numCheque: '',
							showDetails:false,
							creationAutomatique :false,
							type: 'pc',
							totalHtFinal(){
								return this.calculateTotalRateLiv() || 0;
							},
							subTotalFinal(){
								const totalRemise = parseFloat(this.TotalRemise) || 0;
								const totalht = parseFloat(this.calculateTotalRateLiv()) || 0;
								return (parseFloat(totalht  - totalRemise)).toFixed(2);
							},
							totalTTc(){
								const totalRemise = parseFloat(this.TotalRemise) || 0;
								const totalht = parseFloat(this.calculateTotalRateLiv()) || 0;
								return (parseFloat(totalht  - totalRemise) * 1.19).toFixed(2);
							},
							totaltoPay(){
								const fraisLivraisonExt = parseFloat(this.fraisLivraisonExt) || 0;
								const totalRemise = parseFloat(this.TotalRemise) || 0;
								const totalht = parseFloat(this.calculateTotalRateLiv()) || 0;
								return ((parseFloat(totalht  - totalRemise) * 1.19) + fraisLivraisonExt).toFixed(2) || 0;;
							
							},
							totalPCHt(index){
								var item = this.items_pc[index-1]
							

								if (item.items && item.items.length > 0) {
									const itemRateLivSum = item.items.reduce((acc, product) => {
										// Check if product has products object and rateLiv property
										if (product.products && typeof product.products.rateLiv === 'number') {
											return acc + product.products.rateLiv;
										} else {
											// Handle missing product or rateLiv (e.g., return 0 or log a warning)
											return acc;
										}
									}, 0);

									return itemRateLivSum;
								}else{
									return 0;
								}
							},
							endPcBuild(){
								this.items_pc.push({	
									'qty':this.qte_requis,
									'netTotal':this.netTotal,
									'netTotalLiv':this.netTotalLiv,
									'fraisLivraison':this.fraisLivraison,
									'tax':this.tax,		
									'reference_pc' : this.reference_pc,
									'designation_pc': this.designation_pc,
									'items':this.items
								});
								this.reference.push(this.reference_pc);
								this.designation.push(this.designation_pc);
								this.Currentstep = 1;
								this.qte_requis = 0;
								this.openModal=false;
								this.netTotal = 0;
								this.netTotalLiv = 0;
								this.generateRandomString();
								this.designation_pc = '';
								this.items = [
									{ label: { value: 'cpu', display: 'Processeur' }, products: '' },
									{ label: { value: 'mb', display: 'Carte mère' }, products: '' },
									{ label: { value: 'ram', display: 'Mémoire RAM' }, products: '' },
									{ label: { value: 'cpuc', display: 'Refroidissement CPU' }, products: '' },
									{ label: { value: 'gpu', display: 'Carte graphique' }, products: '' },
									{ label: { value: 'ssd', display: 'SSD' }, products: '' },
									{ label: { value: 'psu', display: 'Alimentation' }, products: '' },
									{ label: { value: 'case', display: 'Boîtier' }, products: '' },
									{ label: { value: 'moniteur', display: 'Moniteur' }, products: '' },
									{ label: { value: 'claviers', display: 'Clavier' }, products: '' },
									{ label: { value: 'souris', display: 'Souris' }, products: '' },
									{ label: { value: 'extras1', display: 'Extras' }, products: '' },
									{ label: { value: 'extras2', display: 'Extras' }, products: '' },
									{ label: { value: 'extras3', display: 'Extras' }, products: '' },
									{ label: { value: 'extras4', display: 'Extras' }, products: '' },
									{ label: { value: 'extras5', display: 'Extras' }, products: '' },
									{ label: { value: 'extras6', display: 'Extras' }, products: '' },
								];
								
							},

							generateRandomString() {
								  const prefix = 'PC-';
                                  const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                                  const separator = '-';
                                  let productCode = prefix;
                                
                                  for (let i = prefix.length; i < 10; i++) {
                                    if (i > prefix.length && (i - prefix.length) % 2 === 0) {
                                      productCode += separator;
                                    }
                                    const randomIndex = Math.floor(Math.random() * characters.length);
                                    productCode += characters[randomIndex];
                                  }
								this.reference_pc = productCode;
							},

							validerModification(){
								const existingPcIndex = this.items_pc.findIndex(item => item.reference_pc === this.referencePCedit);
								existingPC = this.items_pc[existingPcIndex];
								PcProduct = existingPC.items[this.category];
								existingPC.netTotal -= parseFloat(PcProduct.rate) * existingPC.qty
								existingPC.netTotalLiv -= parseFloat(PcProduct.rateLiv) * existingPC.qty
								existingPC.fraisLivraison -= parseFloat(PcProduct.fraisLivraison)
								existingPC.tax -= parseFloat(PcProduct.tax)		
								const taux_liv = PcProduct.livraison_prix / PcProduct.qty
								this.tax -= PcProduct.tax *  PcProduct.qty
								this.fraisLivraison -= taux_liv * this.itemedit.qty
								this.items_pc[existingPcIndex].items[this.category].name = this.itemedit.name,
								this.items_pc[existingPcIndex].items[this.category].ref= this.itemedit.ref,
								this.items_pc[existingPcIndex].items[this.category].qty= this.itemedit.qty,
								this.items_pc[existingPcIndex].items[this.category].ent= this.itemedit.ent,
								this.items_pc[existingPcIndex].items[this.category].rate= this.itemedit.rate,
								this.items_pc[existingPcIndex].items[this.category].rateLiv= this.itemedit.rateLiv,
								this.items_pc[existingPcIndex].items[this.category].tva= 19,
								this.items_pc[existingPcIndex].items[this.category].gst= this.calculateGST(19, parseFloat(this.itemedit.rate)),
								this.items_pc[existingPcIndex].items[this.category].gstLiv= this.calculateGST(19, parseFloat(this.itemedit.rateLiv)),
								this.items_pc[existingPcIndex].items[this.category].livraison_prix= this.itemedit.livraison_prix * this.itemedit.qty,
								this.items_pc[existingPcIndex].items[this.category].tax=this.itemedit.tax,
								this.items_pc[existingPcIndex].items[this.category].total= this.itemedit.qty * this.itemedit.rate,
								this.items_pc[existingPcIndex].items[this.category].totalLiv= this.itemedit.qty * this.itemedit.rateLiv
								var fr_liv = parseFloat(this.fraisLivraison);
								var livraison_prix = parseFloat(this.itemedit.livraison_prix);
								
								var qty = parseFloat(this.itemedit.qty);

								this.netTotalLiv += this.itemedit.rateLiv;
								netTotal_float = parseFloat(this.netTotal)
								this.netTotal = netTotal_float + parseFloat(this.itemedit.rate);

								this.totalGST = this.netTotal * 0.19
								this.totalGSTLiv = this.netTotalLiv * 0.19
								this.fraisLivraison += isNaN(this.itemedit.livraison_prix) ? 0 : this.itemedit.livraison_prix
								this.tax += isNaN(this.itemedit.tax) ? 0 :parseFloat(this.itemedit.tax)
							
								this.TotalPay = this.netTotal * 1.19;
								this.TotalPayLiv = this.netTotalLiv * 1.19;

								this.itemedit.id = '';
								this.itemedit.name = '';
								this.itemedit.ref = '';
								this.itemedit.qty = 0;
								this.itemedit.rate = 0;
								this.itemedit.rateLiv =0;
								this.itemedit.livraison_prix =0;
								this.itemedit.totalLiv = 0;
								this.itemedit.gst = 0;
								this.itemedit.total = 0;
								this.openModalModification = false;

							},
							steps:['cpu', 'mb','ram','cpuc','gpu','ssd','psu','case','moniteur','claviers','souris','extras','extras','extras','extras','extras','extras','extras','extras','extras','extras','extras','extras','extras','extras'],
							Currentstep: 1,
							category:'',
							TotalPayTotal(){
								const totalPayLiv = parseFloat(this.totalnetTotalLiv) * 1.19 || 0;
								const fraisLivraisonExt = parseFloat(this.fraisLivraisonExt) || 0;
								const totalRemise = parseFloat(this.TotalRemise) || 0;

								// Perform the calculation
								const result = parseFloat((totalPayLiv + fraisLivraisonExt) - totalRemise);

								return result;
							},
							
							items: [
								{ label: { value: 'cpu', display: 'Processeur' }, products: '' },
								{ label: { value: 'mb', display: 'Carte mère' }, products: '' },
								{ label: { value: 'ram', display: 'Mémoire RAM' }, products: '' },
								{ label: { value: 'cpuc', display: 'Refroidissement CPU' }, products: '' },
								{ label: { value: 'gpu', display: 'Carte graphique' }, products: '' },
								{ label: { value: 'ssd', display: 'SSD' }, products: '' },
								{ label: { value: 'psu', display: 'Alimentation' }, products: '' },
								{ label: { value: 'case', display: 'Boîtier' }, products: '' },
								{ label: { value: 'moniteur', display: 'Moniteur' }, products: '' },
								{ label: { value: 'claviers', display: 'Clavier' }, products: '' },
								{ label: { value: 'souris', display: 'Souris' }, products: '' },
								{ label: { value: 'extras1', display: 'Extras' }, products: '' },
								{ label: { value: 'extras2', display: 'Extras' }, products: '' },
								{ label: { value: 'extras3', display: 'Extras' }, products: '' },
								{ label: { value: 'extras4', display: 'Extras' }, products: '' },
								{ label: { value: 'extras5', display: 'Extras' }, products: '' },
								{ label: { value: 'extras6', display: 'Extras' }, products: '' },
							],

							stepObject:{
								label:'',
								products:[]
							},

							checkQuantityConditions() {
								switch (this.steps[this.Currentstep - 1]) {
									case 'cpu': return true;	

									case 'mb':
										const requiredQuantitymb = this.items.find(item => item.label.value === 'cpu').products.qty;
										this.qte_requis = requiredQuantitymb;
										return this.items.some(product => product.label.value === 'mb' && this.item.qty === requiredQuantitymb) ;

									case 'case':
										const requiredQuantitycase = this.items.find(item => item.label.value === 'cpu').products.qty;
										
										return this.items.some(product => product.label.value === 'case' && this.item.qty === requiredQuantitycase) ;

									case 'psu':
										const requiredQuantitypsu = this.items.find(item => item.label.value === 'cpu').products.qty;
										
										return this.items.some(product => product.label.value === 'psu' && this.item.qty === requiredQuantitypsu) ;

									case 'ram' :
										const requiredQuantityram = this.items.find(item => item.label.value === 'cpu').products.qty;
										
										
										return (
											this.items.some(product => product.label.value === 'ram' && this.item.qty <= 4 * parseFloat(requiredQuantityram)) &&
											this.items.some(product => product.label.value === 'ram' && this.item.qty >= parseFloat(requiredQuantityram))
										);

									case 'ssd' :
										const requiredQuantityssd = this.items.find(item => item.label.value === 'cpu').products.qty;
										
									
										return (
											this.items.some(product => product.label.value === 'ssd' && this.item.qty <= 4 * parseFloat(requiredQuantityssd)) &&
											this.items.some(product => product.label.value === 'ssd' && this.item.qty >= parseFloat(requiredQuantityssd))
										);

									// Add conditions for other steps as needed
									default:
										return true; // Default to true for steps without specific conditions
								}
							},

							deleteSelectedItems() {
								this.items.forEach(item => {
													if (item.selected) {
													delete item.products;
												}
								});
								const sumPrixLivraison = this.items.reduce((total, item) => total + item.products[0].livraison_prix, 0);

								// Assign the sum to this.fraislivraison
								this.fraisLivraison = sumPrixLivraison;
								const sumTax = this.items.reduce((total, item) => total + item.products[0].tax, 0);

								// Assign the sum to this.fraislivraison
								this.tax = sumTax;
								this.itemTotal();
								this.itemTotalGST();
								this.itemTotalLiv();
								this.itemTotalGSTLiv();

								const netTotal = parseFloat(this.netTotal.replace(/[^\d.,]/g, "").replace(",", "."));
								const totalGST = parseFloat(this.totalGST.replace(/[^\d.,]/g, "").replace(",", "."));
								const netTotalLiv = parseFloat(this.netTotalLiv.replace(/[^\d.,]/g, "").replace(",", "."));
								const totalGSTLiv = parseFloat(this.totalGSTLiv.replace(/[^\d.,]/g, "").replace(",", "."));

								
								this.TotalPay = netTotal * 1.19;
								this.TotalPayLiv = netTotalLiv * 1.19;
								this.totalGST = netTotal * 0.19;
								this.totalGSTLiv = netTotalLiv * 0.19;
							},
						
							getPreviousStepProducts() {
								if (this.Currentstep > 1) {
								// Retrieve products for the previous step
								return this.items[this.Currentstep - 2].products;
								}
								return {};
							},

							getNextStepProducts() {
								const nextStepIndex = this.Currentstep;
								// Ensure we are not exceeding the total number of steps
								if (nextStepIndex >= 1 && nextStepIndex < this.steps.length) {
									const nextStepProducts = this.items[nextStepIndex].products;
									// Assuming the first product is relevant, you can adjust this based on your specific logic
									const nextProduct = nextStepProducts !=''  ? nextStepProducts : {};
									return nextProduct;
								}
								return {};
							},

							goNext() {
								// Retrieve products for the next step
								const nextStepProducts = this.getNextStepProducts();
								// Update your form fields based on the retrieved products
								if (nextStepProducts !== '') {
									// Assuming the first product is relevant, you can adjust this based on your specific logic
									const nextProduct = nextStepProducts;
									// Update your form fields with the values from the next product
									this.item.reference = nextProduct.ref;
									this.item.name = nextProduct.name;
									this.item.qty = nextProduct.qty;
									this.item.rate = nextProduct.rate;
									this.item.rateLiv = nextProduct.rateLiv;
								}

								// Move to the next step
								this.Currentstep++;
							},

							goPrevious() {
								// Retrieve products for the previous step
								const previousStepProducts = this.getPreviousStepProducts();
								// Update your form fields based on the retrieved products
								if (previousStepProducts !='') {
									// Assuming the first product is relevant, you can adjust this based on your specific logic
									const previousProduct = previousStepProducts;

									// Update your form fields with the values from the previous product
									this.item.reference = previousProduct.ref;
									this.item.name = previousProduct.name;
									this.item.qty = previousProduct.qty;
									this.item.rateLiv = previousProduct.rateLiv;
								}

								// Move to the previous step
								this.Currentstep--;
							},

							modeLivraison:'',
							showmodeLivraison:false,
							agenceLivraison:'',
							fraisLivraison:0,
							fraisLivraisonExt:0,
							netTotalLiv :0,
							totalGSTLiv:0,

							item: {
								id: '',
								category: '',
								name: '',
								ref:'',
								ent:'',
								qty: 0,
								rate: 0,
								rateLiv: 0,
								livraison_prix:0,
								total: 0,
								gst: 0,
							},
							selectedClient:'',
							searchClient:'',
							optionsClientVisible:false,
							filteredOptionsClients() {
										return this.clients.filter((option) => {
											
											return (option.name.toLowerCase().includes(this.searchClient.toLowerCase()));
										});
							},
							filteredToFacture() {
								return this.stocks.filter((option) => {							
									
									return ((parseFloat(option.qty_facture) > 0) && (option.categorie === this.steps[this.Currentstep - 1]) && (option.ref.toLowerCase().includes(this.search.toLowerCase())) ) || ((parseFloat(option.qty_facture) > 0) && (option.categorie === this.steps[this.Currentstep - 1]) && (option.name.toLowerCase().includes(this.search.toLowerCase())) ) ;
								});								
							},
							optionsVisible: false,
							search: "",

							selected: {
								label: "",
								value: ""
							},

							filteredOptions() {
								return this.stocks.filter((option) => {		
															
									return ((option.ref.toLowerCase().includes(this.search.toLowerCase())) && (option.categorie === this.steps[this.Currentstep - 1])) || ((option.name.toLowerCase().includes(this.search.toLowerCase())) && (option.categorie === this.steps[this.Currentstep - 1])) ;
								});
							},

							item: {
								id: '',
								category: '',
								name: '',
								ref:'',
								ent:'',
								qty: 0,
								rate: 0,
								total: 0,
								gst: 0,
							},
		
							billing: {
								name: '',
								address: '',
								registreCommerce:'',
								Nif:'',
								Nis:'',
								num_article:'',
								extra: '',
								type:'',
								phone:''
							},

							from: {
								name: '{{selected_store.name}}',
								address: '{{selected_store.location}}',
								user:'{{request.user.username}}',
								extra: ''
							},
			
							showTooltip: false,
							showTooltip2: false,
							openModal: false,
							showQuantity:false,
							TotalPayLiv:0,
							ModeReglement:'',
							showModal(){
								if (this.designation_pc ==''){
									alert('Veuillez Remplir la désignation de PC');
									return;
								}
								this.showQuantity = false; 
								this.openModal =true;
							},

							filterProduct(category){
								this.stockFiltered = this.stocks.filter(item => item.categorie === category);
								
							},

							itemedit:{
								ref: '',
								name: '',
								rate: '',
								tax: '',
								livraison_prix: '',
								rateLiv: '',
								ent: '',
							},

							openModalModification : false,
							editItem(invoiceCategory) {
								const index = this.items.findIndex(item => item.label.value === invoiceCategory.label.value);
								this.Currentstep = index +1;
								this.category = index;		
								this.itemedit.ref  = invoiceCategory.products.ref;
								this.itemedit.name = invoiceCategory.products.name;
								this.itemedit.rate = invoiceCategory.products.rate;
								this.itemedit.tax = invoiceCategory.products.tax;
								this.itemedit.livraison_prix = invoiceCategory.products.livraison_prix;
								this.itemedit.rateLiv = invoiceCategory.products.rateLiv;
								this.itemedit.ent	 = invoiceCategory.products.ent;		
								this.openModalModification = true ;
								console.log(this.itemedit);
							},

							getStock(entrepotStock){
								this.stocks=[]
								console.log("fetching stock..."+ this.clientType);
								dataObj={
									nomEnt: entrepotStock,			
									typeclient: this.clientType,		
									type: this.type			 
								}
								axios.post('fetchStock', dataObj, {
									headers: {
									'Content-Type': '',
									'X-CSRFToken': getCookie('csrftoken'),
									}
								})
								.then((response) => {
									itemsData=response.data.stocks;
									for (const itemData of itemsData) {							 
										const item = {
											id: this.generateUUID(),
											name: itemData.product_name,
											ref: itemData.reference,
											ent:itemData.entrepot,
											categorie: itemData.categorie,
											qty: itemData.quantity,
											qty_facture: itemData.quantity_facturer,
											prix: itemData.price,
											tax: itemData.tax,
											livraison_prix: itemData.prix_livraison,
								  			rateLiv: parseFloat(itemData.price) +  parseFloat(itemData.prix_livraison) +  parseFloat(itemData.tax)
										};
										
										this.stocks.push(item);
									}
									console.log(this.stocks);						 
								})
								.catch((error) => {
									alert(error)
							
								});
							},

							get totalnetTotal(){
								const sumneTotals = this.items_pc.reduce((total, item) => total + (item.netTotal * item.qty), 0);	
								return sumneTotals;
							},

							get totalnetTotalLiv(){
								const sumneTotals = this.items_pc.reduce((total, item) => total + (item.netTotalLiv * item.qty) , 0);	
								return sumneTotals;
							},
				
							initData() {
								clientsData={{ clients|safe }}		
								for (const client of clientsData) {					  
									const client_info = {	
										id: this.generateUUID(),			
										name: client.client_name,
										address: client.client_address,
										phone: client.client_phone,
										client_type: client.client_type,	
										solde:client.client_solde,
										registreCommerce: client.registreCommerce,
										Nif: client.Nif,
										Nis: client.Nis,
										num_article: client.num_article
									};
									this.clients.push(client_info);
								}							
								this.generateRandomString()
							},

							verifyQty(){
								if (this.items.length == 0) {
									this.quantityRequired = this.item.qty;
									this.addItem()
								}else{
									if (this.item.qty != this.quantityRequired) {
										this.showModalConfirmation = true;
									}else{
										this.addItem()
									}
								}
							},
							calculateTotalRateLiv() {
							let sumItems = 0;
							let sumProducts = 0;

							this.items_pc.forEach(item => {
								// Check if items have products array and calculate sum if it exists
								if (item.items && item.items.length > 0) {
									const itemRateLivSum = item.items.reduce((acc, product) => {
										// Check if product has products object and rateLiv property
										if (product.products && typeof product.products.rateLiv === 'number') {
										return acc + product.products.rateLiv;
										} else {
										// Handle missing product or rateLiv (e.g., return 0 or log a warning)
										return acc;
										}
									}, 0);
									sumItems += ( itemRateLivSum * item.qty);
								}

								
							});

							return sumItems + (this.calculateTotalProductsRateLiv());
							},

							calculateTotalProductsRateLiv() {
								var qty_required = this.items[0].products.qty || 0;
								if (this.items && this.items.length > 0) {
								const sum = this.items.reduce((acc, product) => {
									if (product.products && typeof product.products.rateLiv === 'number') {
									return acc + product.products.rateLiv;
									} else {
									// Handle missing product or rateLiv (consider logging or throwing an error)
									console.warn('Missing product or rateLiv property');
									return acc;
									}
								}, 0);

								// Assuming qty_required represents a valid quantity
								return sum * qty_required;
								} else {
								// Handle case where this.items is empty or missing
								return 0;
								}
							},
							addItem() {
							 console.log(this.totalTTc())
							 if (this.item.reference){
								   const newItem = {
									   id: this.generateUUID(),
									   ref: this.item.reference,
									   name: this.item.name,
									   qty: this.item.qty,
									   ent:this.item.ent,
									   rate: this.item.rate,
									   rateLiv: this.item.rateLiv,
									   tax:this.item.tax,
									   gst: this.calculateGST(19, this.item.rate),
									   gstLiv: this.calculateGST(19, this.item.rateLiv),
									   livraison_prix: this.item.livraison_prix * this.item.qty,
									   total: this.item.qty * this.item.rate,
									   totalLiv: this.item.qty * this.item.rateLiv
								   };
								   
								   this.item.id = '';
								   this.item.name = '';
								   this.item.reference = '';
								   this.item.qty = 0;
								   this.item.tax=0;
								   this.item.rate = 0;
								   this.item.gst = 0;
								   this.item.total = 0;
   
								   // Check if the step object for the current step already exists
								   const currentStepObject = this.items.find(item => item.label.value === this.steps[this.Currentstep - 1]);
   
								   if (currentStepObject) {
									   // If the step object exists, add the new item to its products array
									   currentStepObject.products = newItem;
								   } else {
									   // If the step object doesn't exist, create a new one
									   const newStepObject = {
										   label: this.steps[this.Currentstep - 1],
										   products: newItem
									   };
									   // Add the new step object to the items array
									   this.items.push(newStepObject);
								   }
								   this.netTotalLiv += newItem.totalLiv;
								   netTotal_float = parseFloat(this.netTotal)
								   this.netTotal = netTotal_float + parseFloat(newItem.total);
								   
								   this.totalGST = this.netTotal * 0.19
								   this.totalGSTLiv = this.netTotalLiv * 0.19
								   this.fraisLivraison += isNaN(newItem.livraison_prix) ? 0 : newItem.livraison_prix
								   this.totalnetTotal +=  parseFloat(newItem.rate);
								   this.totalnetTotalLiv += parseFloat(newItem.rateLiv);
								   this.tax += isNaN(newItem.tax) ? 0 :parseFloat(newItem.tax)
							   
								   this.TotalPay = this.netTotal * 1.19;
								   this.TotalPayLiv = this.netTotalLiv * 1.19;
							   }else{
									return;
							   }
								
							},
			
							deleteItem(uuid) {
								this.items = this.items.filter(item => uuid !== item.id);
			
								this.itemTotal();
								this.itemTotalGST();
							},
		
							itemTotal() {
								const allProducts = this.items_pc.map(item => item.items);
								const itemsProducts = allProducts.map(item => item.products);
								this.netTotal = allProducts.length > 0 ? allProducts.reduce((result, item) => {
									const productTotal = isNaN(item.total) ? 0 : item.total;
									return result + productTotal;
								}, 0) : 0
							},

							itemTotalLiv() {
								const allProducts = this.items_pc.map(item => item.items);
								const itemsProducts = allProducts.map(item => item.products);
								console.log(itemsProducts);
								this.netTotalLiv = allProducts.length > 0 ? allProducts.reduce((result, item) => {
									const productTotal = isNaN(item.totalLiv) ? 0 : item.totalLiv;
									return result + productTotal;
								}, 0) : 0
							},

							itemTotalGST() {
								const allProducts = this.items.map(item => item.products);
								this.totalGST = this.numberFormat(allProducts.length > 0 ? allProducts.reduce((result, item) => {
									// Check if either item.gst or item.qty is NaN and replace with 0
									const gst = isNaN(item.gst) ? 0 : item.gst;
									const qty = isNaN(item.qty) ? 0 : item.qty;

									return result + (gst * qty);
								}, 0) : 0);
							},

							itemTotalGSTLiv() {
								const allProducts = this.items.map(item => item.products);
								this.totalGSTLiv = this.numberFormat(allProducts.length > 0 ? allProducts.reduce((result, item) => {
									// Check if either item.gst or item.qty is NaN and replace with 0
									const gst = isNaN(item.gstLiv) ? 0 : item.gstLiv;
									const qty = isNaN(item.qty) ? 0 : item.qty;

									return result + (gst * qty);
								}, 0) : 0);
							},
			
							calculateGST(GSTPercentage, itemRate) {	
								return this.numberFormat((itemRate * GSTPercentage/100).toFixed(2));
							},
			
							generateUUID() {
								return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
									var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
									return v.toString(16);
								});
							},
			
							generateInvoiceNumber(minimum, maximum) {
								const randomNumber = Math.floor(Math.random() * (maximum - minimum)) + minimum;
								this.invoiceNumber = 'PCBL-'+ randomNumber;
							},
			
							numberFormat(amount) {
								return amount.toLocaleString("fr-FR", {
									style: "currency",
									currency: "DZD"
								});
							},
				
							printInvoice() {
								var printContents = this.$refs.printTemplate.innerHTML;
								var originalContents = document.body.innerHTML;
								document.body.innerHTML = printContents;
								window.print();
								document.body.innerHTML = originalContents;
								this.items=[];
							},

							VerifyBon(){
								this.validateBon()
								const allProducts = this.items.map(item => item.products);	
								allProducts.forEach(item => {
									if (item.ent != this.BonEntrepot) {
										// Push the product details to the array
										product_obj ={
											reference: item.ref,
											entrepot: item.ent,
											quantity: item.qty,
										}
										this.productsdifferent.push(product_obj);
									}									
								});
						
							},

							validateBon(){	
								// Now 'allProducts' contains an array of all products from the nested structure
								let allProducts = [];

								// Iterate over each item in the items_pc array
								for (let i = 0; i < this.items_pc.length; i++) {
									let currentItem = this.items_pc[i];
									console.log(currentItem)
									// Iterate over each item in the 'items' array of the current item
									for (let j = 0; j < currentItem.items.length; j++) {
										let currentSubItem = currentItem.items[j];
										console.log(currentSubItem);
										// Check if the 'products' property exists and is not empty
										if (currentSubItem.products && currentSubItem.products !== '') {
											allProducts.push(currentSubItem.products );
										}
									}
								}
								console.log(allProducts);
								const dataObj = {
									IdBon : this.invoiceNumber,
									dateBp:this.invoiceDate,
									clientInfo:this.billing,
									reference_pc: this.reference,
									designation_pc: this.designation,
									entrepotBon : this.BonEntrepot,
									total:this.totalnetTotal,
									ModeReglement:this.ModeReglement,
									remise:this.TotalRemise,
									banque: this.banque,
							   		numCheque: this.numCheque,
									produits:allProducts,
									creationAutomatique :this.creationAutomatique,
									productsdifferent :this.productsdifferent,
								};
								axios.post('', {
								formData: dataObj
								}, {
									headers: {
									'Content-Type': '',
									'X-CSRFToken': getCookie('csrftoken'),
									}
									})
									.then((response) => {
										data= response.data
										if(data.error){
											alert(data.error);
										}else{
											alert("Bon Enregistré! En attente de Validation");
											window.location.href="/ventes/pc-sell-bills";
										}		  
									})
									.catch((error) => {
										alert(error)
									});							  
							},
					}
			}
			function getCookie(name) {
					var cookieValue = null;
					if (document.cookie && document.cookie !== '') {
						var cookies = document.cookie.split(';');
						for (var i = 0; i < cookies.length; i++) {
							var cookie = cookies[i].trim();
							// Does this cookie string begin with the name we want?
							if (cookie.substring(0, name.length + 1) === (name + '=')) {
								cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
								break;
							}
						}
					}
					return cookieValue;
			}
		</script>
	  </body>
   </div>
 </div>
</div>
</div>
{% endblock content %}
