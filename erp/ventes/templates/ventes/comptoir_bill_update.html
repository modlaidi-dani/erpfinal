{% extends "base.html" %}
{% load static heroicons %}

{% block body_class %}{% endblock %}

{% block content %}
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' with active_tab="vente" %}
 {% include 'tabs.html' with active_tab="vente" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_ventes.html" %}
  <div class="h-full w-full">
		<!-- Main content header -->
	<body class="antialiased sans-serif">		  
			 <div class="h-2"></div> 
			 <div 
			   class="container mx-auto py-6 px-4"
			   x-data="invoices()"
			   x-init="initData()"
			   x-cloak
			 >
			   <div class="flex justify-between">
				  <h2 class="text-2xl font-bold mb-6 pb-2 tracking-wider uppercase">Bon de Vente au Comptoir</h2>
				  <div>
					  <div class="relative mr-4 inline-block">
						  <div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip = true" @mouseleave="showTooltip = false" @click="printInvoice()">
							  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-printer" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
								  <rect x="0" y="0" width="24" height="24" stroke="none"></rect>
								  <path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" />
								  <path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" />
								  <rect x="7" y="13" width="10" height="8" rx="2" />
							  </svg>				  
						  </div>
						  <div x-show.transition="showTooltip" class="z-40 shadow-lg text-center w-32 block absolute right-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
							  Print this invoice!
						  </div>
					  </div>
			          <div class="relative inline-block">
						<div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip2 = true" @mouseleave="showTooltip2 = false" @click="openPreview=true">
							<svg id='eye_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
									<g transform="matrix(1 0 0 1 12 12)" >
									<g style="" >
									<g transform="matrix(1 0 0 1 0 0)" >
									<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
									</g>
									<g transform="matrix(1 0 0 1 -0.25 -0.25)" >
									<circle style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" cx="0" cy="0" r="2" />
									</g>
									<g transform="matrix(1 0 0 1 -0.25 -0.25)" >
									<path style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 22 12 C 19.333 16.667 16 19 12 19 C 8 19 4.667 16.667 2 12 C 4.667 7.333 8 5 12 5 C 16 5 19.333 7.333 22 12" stroke-linecap="round" />
									</g>
									</g>
									</g>
							</svg>		  
						</div>
						<div x-show.transition="showTooltip2" class="z-40 shadow-lg text-center w-32 block absolute right-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
							Preview
						</div>
					</div>
				  </div>
			   </div>
	  
			   <div class="flex mb-8 justify-between">
				  <div class="w-2/4">
					   <div class="mb-2 md:mb-1 md:flex items-center">
						   <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Numéro de Bon</label>
						   <span class="mr-4 inline-block  md:block">:</span>
						   <div class="flex-1">
							  <input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700" id="inline-full-name" type="text" placeholder="eg. #BON-100001" x-model="invoiceNumber">
						   </div>
					   </div>
	  
					   <div class="mb-2 md:mb-1 md:flex items-center">
						   <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Date de Bon</label>
						   <span class="mr-4 inline-block  md:block">:</span>
						   <div class="flex-1">
							<input class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700 " type="date" x-model="invoiceDate" {% if request.session.role != 'manager' %}disabled{% endif %}>
						   </div>
					   </div>
					   <div class="mb-2 md:mb-1 md:flex items-center">
						  <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Bon Commande Associé </label>
						  <span class="mr-4 hidden md:block">:</span>
						  <div class="flex-1">
							  <select
										  class="appearance-none border rounded w-48 py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
										  id="echReg"
										  name="echReg"
										  x-on:change="getProducts($event.target.value)
										  item.ent= $event.target.value
										  "
										  required  
									   >
									   <option value="" disabled selected>Aucun</option>
									   {% for bon in bons_commandes %}
										   <option value="{{ bon.idBon}}"  data-products="{{bon.get_produits_json}}"> 
											  {{ bon.idBon}}
										   </option>
									   {% endfor %}
							  </select>
						  </div>
					  </div>
					   <div class="mb-2 md:mb-1 md:flex items-center">
						   <label class="w-32 text-gray-800 block font-bold text-sm uppercase tracking-wide">Entrepot</label>
						   <span class="mr-4 inline-block  md:block">:</span>
						   <div class="flex-1">
							  <select
							  class="bg-gray-200 appearance-none border-2 border-gray-200 rounded w-48 py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-gray-700"
							  id="entrepot"
							  name="entrepot"
							  x-model="BonEntrepot"
							  x-on:change="
							   BonEntrepot = $event.target.value
							  "
							  required  
							  disabled
						   >
						   <option value="" disabled selected>Select entrepot</option>
						   {% for entrepot in entrepots %}
							  <option value="{{ entrepot.name }}" data-stock="{{entrepot.get_stocks}}">
								  {{ entrepot.name }} 
							  </option>
							  {% endfor %}
						   </select>
						   </div>
					   </div>
				  </div>

			   </div>
			    <div x-data="{ tab: 1 }" x-cloak class="my-10 antialiased ">
				  <div class="relative flex flex-col rounded-lg shadow-xs overflow-hidden">         
					  <div class="flex space-x-8 bg-white border-b border-gray-200 ">
						  <button
							  type="button"
							  class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
							  x-on:click="tab = 1"
							  :class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 1 }"
						  >
							  Informations Client
						  </button>
						 
						  <button
							  type="button"
							  class="focus:outline-none text-black py-2 px-1 border-t-2 text-md tracking-wide font-semibold border-transparent"
							  x-on:click="tab = 3"
							  :class="{ 'text-white  border-gray-700 rounded-t-lg bg-gray-700': tab === 3 }"
						  >
						  Produits du Bon
						  </button>						  
					  </div>     
					  <div class="">
						  <div x-show="tab === 1">
							  <div class="flex flex-wrap justify-between mb-8 py-4">
							   <div class="w-full md:w-1/3 mb-2 md:mb-0">
								   <label class="text-gray-800 block mb-1 font-bold text-sm uppercase tracking-wide">Bon Pour :</label>
								   <select class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none  focus:bg-white" id="clients"					
									 x-model="billing.name"
								   	 x-on:change="
									  	billing.name =$event.target.value
									  	billing.address = $event.target.selectedOptions[0].dataset.address
									  	billing.phone = $event.target.selectedOptions[0].dataset.phone
									  "
									>
									    {% for client in clients  %}
										 <option value="{{client.name}}" data-address="{{client.adresse}}" data-phone="{{client.phone}}">
											{{client.name}}
										</option>
										{% endfor %}
											
									</select>
		   
								   <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="client-address" type="text" placeholder="Adresse de client" x-model="billing.address">
								   <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="client-phone" type="text" placeholder="Numéro de téléphone" x-model="billing.phone">
								  <input class="mb-1 bg-gray-200 appearance-none border-2 border-gray-200 rounded w-full py-2 px-4 text-gray-700 leading-tight focus:outline-none focus:bg-white focus:border-blue-500" id="inline-full-name" type="text" placeholder="Additional info" x-model="billing.extra">
							   </div>	
							  </div>
						  </div>     													   
					
						  <div class="w-full" x-show="tab === 3">    
							  <div class="flex  border-b py-2 items-start">
							  
							   <div class="flex-1 px-1">
								   <p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Référence</p>
							   </div>
		   
							   <div class="flex-1 px-1">
								   <p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Désignation</p>
							   </div>
							   <div class="px-1 w-20 text-right">
								   <p class="text-gray-800 uppercase tracking-wide text-sm font-bold">Quantité</p>
							   </div>
				   
							   <div class="px-1 w-32 text-right">
								   <p class="leading-none">
									   <span class="block uppercase tracking-wide text-sm font-bold text-gray-800">PVU</span>
									   {% comment %} <span class="font-medium text-xs text-gray-500">(Incl. GST)</span> {% endcomment %}
								   </p>
							   </div>
				   
							   <div class="px-1 w-32 text-right">
								   <p class="leading-none">
									   <span class="block uppercase tracking-wide text-sm font-bold text-gray-800">Total</span>
									   {% comment %} <span class="font-medium text-xs text-gray-500">(Incl. GST)</span> {% endcomment %}
								   </p>
							   </div>
				   
							   <div class="px-1 w-20 text-center">
							   </div>
							  </div>
					   
							  <template  x-for="invoice in items" :key="invoice.id">
								<div class="flex no-worap -mx-1 py-2 border-b" >			 
								  
								   <div class="flex-1 px-1" >
									   <p class="text-gray-800" x-text="invoice.ref"></p>
								   </div>
		   
								   <div class="flex-1 px-1" >
									   <p class="text-gray-800" x-text="invoice.name"></p>
								   </div>

				   
								   <div class="px-1 w-20 text-right">
									   <p class="text-gray-800" x-text="invoice.qty"></p>
								   </div>
				   
								   <div class="px-1 w-32 text-right">
									   <p class="text-gray-800" x-text="numberFormat(invoice.rate)"></p>
								   </div>
				   
								   <div class="px-1 w-32 text-right">
									   <p class="text-gray-800" x-text="numberFormat(invoice.total)"></p>
								   </div>
								   {% if request.session.role == 'manager' or request.session.role == "DIRECTEUR EXECUTIF" %}    
								   <div class="px-1 w-20 text-right flex justify-end">
									<a href="#" class="text-sm font-semibold" @click.prevent="editItem(invoice.category)">
										{% heroicon_mini "pencil-square" class="transition-transform" %}
									</a>
									<input type="checkbox" x-model="invoice.selected" class="mr-2" />
								   </div>
								    {% endif %} 
								   
								</div>
							  </template>
							  {% if request.session.role == 'manager' or request.session.role == "DIRECTEUR EXECUTIF" %}  
							  <div class="flex justify-between ">
								<div>

								</div>
								
								<button @click="deleteSelectedItems" class="bg-red-500 text-white px-4 py-2 rounded-md" x-show="items.length > 0">
									Supprimer sélectioner
								</button>
							</div>	
							{% endif %} 
				            {% if request.session.role == 'manager' or request.session.role == "DIRECTEUR EXECUTIF" %}
							  <button class="mt-6 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 text-sm border border-gray-300 rounded shadow-sm" x-on:click="showModal">
							   Ajouter des produits
							  </button>
							 {% endif %} 
						  </div>
					  </div> 
			      </div> 
				</div> 

	  
			   <div class="py-2 ml-auto mt-5 w-full sm:w-2/4 lg:w-1/4">
			   <div class="flex justify-between mb-3">
					  <div class="text-gray-800 text-right flex-1">Total</div>
					  <div class="text-right w-40">
						  <div class="text-gray-800 font-medium" x-html="netTotal"></div>
					  </div>
				  </div>
				  <div class="flex justify-between mb-4">
					  <div class="text-sm text-gray-600 text-right flex-1">Total Remise</div>
					  <div class="text-right w-40">
						  <div class="text-sm text-gray-600" x-html="TotalRemise"></div>
					  </div>
				  </div> 
			  
				  <div class="py-2 border-t border-b">
					  <div class="flex justify-between">
						  <div class="text-xl text-gray-600 text-right flex-1">Net À Payer</div>
						  <div class="text-right w-40">
							  <div class="text-xl text-gray-800 font-bold" x-html="TotalPayAffiché"></div>
						  </div>
					  </div>
				  </div>
				  {% if request.session.role == 'manager' or request.session.role == "DIRECTEUR EXECUTIF" %}
				  <div class="flex justify-between">
					  <div></div>
					  <button class="mt-6 bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 text-sm border border-gray-300 rounded shadow-sm" type="submit" x-on:click="validateBon">Valider le Bon & imprimer</button>
			      </div>
			      {% endif %} 
			   </div>
			  
				 <!-- Preview  -->
				 <div style="background-color: rgba(0, 0, 0, 0.8)" class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full py-8" x-show.transition.opacity="openPreview">	
					<div class="shadow absolute -right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
						x-on:click="openPreview = !openPreview">
						<svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
							<path
								d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
						</svg>
					</div>
			   		<div class="p-4 w-3/4 mx-auto relative left-0 right-0 overflow-hidden  bg-white h-full "  x-on:click.away="openPreview = !openPreview">
						 <div class="h-full">
						   <body class="bg-gray-100 font-sans">
  							<div class="container mx-auto p-4">
    							<div class="">
      							  <div class="text-center">
        							<h1 class="text-2xl font-bold">Bon de vente au comptoir</h1>
        							<p x-text="invoiceDate"></p>
        							<p x-text="invoiceNumber"></p>
      							  </div>
      							  <div class="mt-4">
        						    <table class="w-full">
          							<thead>
            							<tr>
              							{% comment %} <th class="border px-4 py-2">Réference du Produit</th> {% endcomment %}
              							<th class="border px-4 py-2">Désignation du Produit</th>
              							<th class="border px-4 py-2">Quantité</th>
              							<th class="border px-4 py-2">Prix</th>
              							<th class="border px-4 py-2">Total</th>
            							</tr>
          							</thead>
          						    <tbody>
           							<template x-for="invoice in items" :key="invoice.id">
                  						<tr class="border border-black">
                      						{% comment %} <td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.ref"></td> {% endcomment %}
                     		    			<td class="border border-black px-1 py-2 text-black text-xs" x-text="invoice.name"></td>
                      						<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="invoice.qty"></td>
                      						<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="invoice.rate"></td>
                      						<td class="border border-black px-1 py-2 w-32 text-right text-black text-xs" x-text="invoice.total"></td>
                  						</tr>
                					</template>
          						    </tbody>
       							    </table>
      							  </div>
      							  <div class="mt-4 text-right">
        							<p class="font-bold text-xl" x-text="'Total à Payer :'+' '+TotalPayAffiché"></p>
      							  </div>
    						    </div>
  				            </div>
						   </body>		   
						 </div>
			  		</div>				
				 </div>
			     <!-- /Preview -->

				 <!-- Print Template -->
				 <div id="js-print-template" x-ref="printTemplate" class="hidden">		
						  <body class="bg-gray-100 font-sans mx-auto">
  							<div class="container mx-auto ">
  							    <div class=" w-1/2 mx-auto border-b-2 border-black  border-dashed">
									<img src="data:image/png;base64,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" alt="Your Logo" class="mx-auto h-32">
								</div>
    							<div class="">
      							  <div class="text-center">
        							<h1 class="text-xl font-bold">Bon de vente au comptoir</h1>
        							<p x-text="'Date Bon :'+' '+invoiceDate"></p>
        							<p x-text="'Code Bon :'+' '+invoiceNumber"></p>
      							  </div>
      							  <div class="mt-4">
        						    <table class="w-3/4 mx-auto">
          							<thead>
            							<tr>
              							<th class="border px-4 py-2">Désignation</th>
              							<th class="border px-4 py-2">Quantité</th>
              							<th class="border px-4 py-2">Prix</th>
              							<th class="border px-4 py-2">Total</th>
            							</tr>
          							</thead>
          						    <tbody>
           							<template x-for="invoice in items" :key="invoice.id">
                  						<tr class="border ">
                     		    			<td class="border  px-1 py-2 text-black text-xs" x-text="invoice.name"></td>
                      						<td class="border  px-1 py-2  text-right text-black text-xs" x-text="invoice.qty"></td>
                      						<td class="border  px-1 py-2  text-right text-black text-xs" x-text="invoice.rate"></td>
                      						<td class="border  px-1 py-2  text-right text-black text-xs" x-text="invoice.total"></td>
                  						</tr>
                					</template>
          						    </tbody>
       							    </table>
      							  </div>
      							  <div class="mt-4 text-left w-3/4 mx-auto">
        							<p class="font-bold" x-text="'Total :'+' '+TotalPay"></p>
        							<p class="font-bold" x-text="'Total Remise : '+' '+TotalRemise" ></p>
        							<p class="font-bold text-xl" x-text="'Total à Payer :'+' '+TotalPayAffiché()"></p>
        							 <span class="font-bold text-xl" x-show="verssement == 'true'">
									  	<p class="font-bold text-xl" x-text="'Montant verssé :'+' '+amountverse"></p>
									</span>
      							  </div>
    						    </div>
    						    <div class=" w-full mx-auto mt-2 text-xl font-bold text-center  ">
									<p>Merci pour votre visite!</p>
								</div>
  				            </div>
						   </body>	
				 </div>
				 <!-- /Print Template -->
	  
			 

			   <!-- Modal -->
			   <div style=" background-color: rgba(0, 0, 0, 0.8); " class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full overflow-y-scroll" x-cloak x-show.transition.opacity="openModal">
				  <div class="p-4 max-w-xl mx-auto relative left-0 right-0 overflow-hidden mt-24">
					  <div class="shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
						  x-on:click="openModal = !openModal">
						  <svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
							  <path
								  d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
						  </svg>
					  </div>
				  <form action="" id="myForm">
				    <div class="shadow w-full rounded-lg bg-white overflow-hidden block p-8">		
				    <h2 class="font-bold text-2xl mb-6 text-gray-800 border-b pb-2">Ajouter des produits au bon</h2>
				    
				    <div class="mb-4">
					  <label class="block text-gray-700 font-semibold mb-2" for="product">
						Entrepot :
					  </label>
					  <select
					   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
					   id="entrepot"
					   name="entrepot"
					   x-on:change="getStock($event.target.value)
					   item.ent= $event.target.value
					   "
					   required  
					   >
					  <option value="" disabled selected>Select entrepot</option>					  
					  {% for entrepot in entrepots %}
					   <option value="{{ entrepot.name }}" data-stock="{{entrepot.get_stocks}}">
						   {{ entrepot.name }} 
					   </option>
					 {% endfor %}
					 </select>
				    </div>
				    <div class="relative">
				       <label class="block text-gray-700 font-semibold mb-2" for="product">
						Produit
					  </label>
    					<input type="hidden" :value="selected.value">
    					<input type="text" x-model="search" class="w-full px-4 py-3 rounded-lg shadow-sm focus:outline-none focus:shadow-outline bg-gray-50 text-gray-600 font-medium"
    						placeholder="Cliquer pour rechercher ..." @click="optionsVisible = !optionsVisible">
    					<div class="absolute bg-white shadow-lg w-full overflow-y-scroll z-40" style="max-height:200px;" x-show="optionsVisible">
    						<template x-for="option in filteredOptions()">
    							<a class="cursor-pointer border-b py-2 px-2 text-left hover:bg-gray-100" 
    								@click.prevent="
    							        item.ref = option.ref;
                    					item.name=option.name;
                    					item.rate = option.prix;					
                    					selectedProductQuantity = option.qty;
                    					showQuantity = true;
    									selected = option;
    									optionsVisible = false;
    									search='';
    
    									"
    								x-text="option.name"
    								style="display: block;"></a>
    						</template>
					</div>
				    <div class="mb-4">

					  <select
					   class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
					   id="product"
					   name="product"
                        disabled
					   required  
					   >
					  <option value="" disabled selected>Select product</option>

		  			<template x-for="stock_item in stocks">
		   			<option
						x-bind:value="stock_item.ref"
						x-bind:data-name="stock_item.name"
						x-bind:data-price="stock_item.prix"
						x-bind:data-quantity="stock_item.qty"
						x-text="stock_item.name"
		   			>

		  			</option>
		  			</template>
								</select>
				  			</div>
				
				  			<div class="mb-4">
					  			<label class="block text-gray-700 font-semibold mb-2" for="quantity">
									Quantité:
									<div class="mb-4" id="productQuantityDiv" style="display: none;" x-show="showQuantity">
						  			<label class="block text-primary font-medium text-sm mb-2">
										Quantité Disponible: <span id="productQuantity" x-text="selectedProductQuantity"></span>
						  			</label>
									</div>
					  			</label>
					  			<input
									class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
									type="number"
									id="quantity"
									name="quantity"
									placeholder="Quantité"
									required
									x-model="item.qty"
									x-bind:max="selectedProductQuantity"
					  			>
				  			</div>	  
				  			<div class="mb-4">
					  			<label class="block text-gray-700 font-semibold mb-2" for="price">
									Prix:
					  			</label>
					  			<input
									class="appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
									type="text"
									id="price"
									name="price"
									placeholder="Price will be fetched automatically"
									x-model="item.rate"
					  			>
								</div>
								<div class="mt-8 text-right">
					  			<button type="button" class="bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded shadow-sm mr-2" @click="openModal = !openModal">
									Cancel
					  			</button>	
					  			<button type="button" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-4 border border-gray-700 rounded shadow-sm" @click="addItem()">
									Ajouter
					  			</button>	
					        </div>
				   </div> 				  
				   </div>
				  </form>
				  </div>
			   </div>
			  <!-- /Modal -->
		 
		  </div>
		  
	   <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
	   <script>			
		  window.addEventListener('DOMContentLoaded', function() {
				  // Get the product dropdown element, quantity input element, and price input element
			  const productDropdown = document.getElementById('product');
			  const quantityInput = document.getElementById('quantity');
			  const priceInput = document.getElementById('price');
			  const ClientDropDown =document.getElementById('clients');
			  const addressInput = document.getElementById('client-address');
			  const phoneInput = document.getElementById('client-phone');
			  // Event listener for when the selected product changes
			  productDropdown.addEventListener('change', (event) => {
			  // Get the selected product ID, its associated price, and available quantity from the data attributes
			  const selectedProductId = event.target.value;
			  const selectedProductOption = event.target.selectedOptions[0];
			  const selectedProductPrice = selectedProductOption.dataset.price;
			  const availableQuantity = selectedProductOption.dataset.quantity;
			  // Update the price input with the selected product's price
			  priceInput.value = selectedProductPrice;
			  productQuantityDiv.style.display = 'block';
			  productQuantity.textContent = availableQuantity; 
	  
			});
	     });
	  
		  function invoices() {
				  return {
					  items: [],
					  clients:[],
					  stocks:[],
					  stockFiltered:[],					 
					  productsdifferent :[],
					  selectedProductQuantity:0,
					  invoiceNumber: '{{idBon}}',
					  invoiceDate: new Date().toISOString().slice(0, 10),
					  invoiceDueDate: '',
					  verssement: '{{verssement}}',
					  amountverse: {{amountverse}},
					  BonEntrepot:'{{bill.monentrepot}}',
					  showConfirmation:false,
					  totalGST: 0,
					  openPreview:false,
					  netTotal: 0,
					  TotalRemise :{{bill.totalremise}},
					  TotalPay:0,
					  showBanque:false,
					  banque:'',
					  numCheque: '',
					  showDetails:false,
					  TotalPayAffiché(){
						return parseFloat(this.TotalPay) - parseFloat(this.TotalRemise);
					 },
					 optionsVisible: false,
					search: "",
					filteredOptions() {
							return this.stocks.filter((option) => {
								return (option.name.toLowerCase().includes(this.search.toLowerCase()));
							});
					},
					 deleteSelectedItems() {
        				// Filter out the selected invoices and delete them
        				this.items = this.items.filter(invoice => !invoice.selected);
   					 },
			  		  creationAutomatique :false,
					  item: {
						  id: '',
						  category: '',
						  name: '',
						  ref:'',
						  ent:'',
						  qty: 0,
						  rate: 0,
						  total: 0,
						  gst: 0,
					   },

					  billing: {
						  name: '{{client_name}}',
						  address: '{{client_address}}',
						  extra: '',
					      phone:'{{client_phone}}',
					   },
					  
					  showTooltip: false,
					  showTooltip2: false,
					  openModal: false,
				      showQuantity:false,
	  
				     showModal(){
				      document.getElementById('myForm').reset(); 
				      this.showQuantity = false; 
				      this.openModal =true;
				     },

					 editItem(invoiceCategory) {					
						 this.item = {
							 category:invoiceCategory,
							 ref: '',
							 qty: '',
							 rate: '',
							 total: '',
						 };
						 // Open the modal
						 this.openModal = true;
				     },

				     getStock(entrepotStock){
					   this.stocks=[]
					   dataObj={
					    nomEnt : entrepotStock,						 
					   }
					   axios.post('/ventes/fetchStock', dataObj, {
						  headers: {
						  'Content-Type': '',
						  'X-CSRFToken': getCookie('csrftoken'),
						  }
					   })
					   .then((response) => {
						  itemsData=response.data.stocks;
						  for (const itemData of itemsData) {		
							  const item = {
								  id: this.generateUUID(),
								  name: itemData.product_name,
								  ref: itemData.reference,
								  ent:itemData.entrepot,
								  categorie: itemData.categorie,
								  qty: itemData.quantity,
								  prix: itemData.price
							  };
							  this.stocks.push(item);
						  }						 
					  })
					  .catch((error) => {
						  alert(error)
				  
					  });
				     },

				     initData() {
					  	items= {{items | safe}}
						for (const item of items) {					  
					     const item_obj = {	
						   id: this.generateUUID(),			
						   name: item.produit_name,
						   ref: item.produit_ref,
						   qty: item.produit_qty,
						   rate:item.produit_unitPrice,		
						   gst: this.calculateGST(0,item.produit_unitPrice),
						   categorie:item.produit_category,
						   total: item.produit_qty * item.produit_unitPrice,			
					     };
					     this.items.push(item_obj);
						 this.itemTotal();
						 this.itemTotalGST();
						  const netTotal = parseFloat(this.netTotal.replace(/[^\d.,]/g, "").replace(",", "."));
						  const totalGST = parseFloat(this.totalGST.replace(/[^\d.,]/g, "").replace(",", "."));
					
						  this.TotalPay = netTotal + totalGST;
					   	}
				     },
	  
				     addItem() {
						this.item.rate = document.getElementById('price').value;
						this.items.push({
							  id: this.generateUUID(),
							  categorie: this.item.categorie,
							  name: this.item.name,
							  ref:this.item.ref,
							  qty: this.item.qty,
							  ent:this.item.ent,
							  rate: this.item.rate,
							  gst: this.calculateGST(this.item.gst, this.item.rate),
							  total: this.item.qty * this.item.rate
					       })
						  this.itemTotal();
						  this.itemTotalGST();
						  const netTotal = parseFloat(this.netTotal.replace(/[^\d.,]/g, "").replace(",", "."));
						  const totalGST = parseFloat(this.totalGST.replace(/[^\d.,]/g, "").replace(",", "."));
					
						  // Calculate the sum
						  this.TotalPay = netTotal + totalGST;

						  this.item.id = '';
						  this.item.name = '';
						  this.item.qty = 0;
						  this.item.rate = 0;
						  this.item.gst = 0;
						  this.item.total = 0;
					    document.getElementById('myForm').reset(); 
					    this.showQuantity = false; 
					    this.openModal=false;
				     },
	  
				     deleteItem(uuid) {
						  this.items = this.items.filter(item => uuid !== item.id);
	  
						  this.itemTotal();
						  this.itemTotalGST();
				     },
	  
					  itemTotal() {
						  this.netTotal = this.numberFormat(this.items.length > 0 ? this.items.reduce((result, item) => {
							  return result + item.total;
						  }, 0) : 0);
					  },
	  
					  itemTotalGST() {
						  this.totalGST =  this.numberFormat(this.items.length > 0 ? this.items.reduce((result, item) => {
							  return result + (item.gst * item.qty);
						  }, 0) : 0);
					  },
	  
					  calculateGST(GSTPercentage, itemRate) {	
						  return this.numberFormat((itemRate * GSTPercentage/100).toFixed(2));
					  },
	  
					  generateUUID() {
						  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
							  var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
							  return v.toString(16);
						  });
					  },
	  
					  generateInvoiceNumber(minimum, maximum) {
						  const randomNumber = Math.floor(Math.random() * (maximum - minimum)) + minimum;
						  this.invoiceNumber = '#BL-'+ randomNumber;
					  },
	  
					  numberFormat(amount) {
						  return amount.toLocaleString("fr-FR", {
							  style: "currency",
							  currency: "DZD"
						  });
					  },
	  
					  printInvoice() {
						  var printContents = this.$refs.printTemplate.innerHTML;
						  var originalContents = document.body.innerHTML;
						  document.body.innerHTML = printContents;
						  window.print();
						  window.location.reload();
						  document.body.innerHTML = originalContents;
						  this.items=[];
					  },

					  validateBon(){
						  const numericNetTotal = parseFloat(this.netTotal.replace(/\s|/g, ''));
						  const dataObj = {
							  IdBon : this.invoiceNumber,
							  dateBp: this.invoiceDate,
							  clientInfo: this.billing,
							  entrepotBon : this.BonEntrepot,
							  totalprice: numericNetTotal,
							  totalremise: this.TotalRemise,
							  produits: this.items,
						  };
						  axios.post('', {
					      formData: dataObj
					     }, {
					  		headers: {
						 	  'Content-Type': '',
						 	  'X-CSRFToken': getCookie('csrftoken'),
					  		}
					    	})
				   			.then((response) => {
					  			data= response.data
								if(data.error){
					  			alert(data.error);
								}else{
					  			alert("Bon Validé, you can print it");
								}		  
				   			})
				   			.catch((error) => {
								alert(error)
				   			});
							  
					  },
					  
				  }
		  }
		  function getCookie(name) {
				  var cookieValue = null;
				  if (document.cookie && document.cookie !== '') {
					  var cookies = document.cookie.split(';');
					  for (var i = 0; i < cookies.length; i++) {
						  var cookie = cookies[i].trim();
						  // Does this cookie string begin with the name we want?
						  if (cookie.substring(0, name.length + 1) === (name + '=')) {
							  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							  break;
						  }
					  }
				  }
				  return cookieValue;
		  }
	   </script>
	</body>
  </div>
 </div>
</div>
</div>






{% endblock content %}
