{% extends "base.html" %}
{% load static heroicons %}

{% block body_class %}{% endblock %}
{% block content %}
<div 
x-data="{ 
	menuOpen: false, 
	basicSignInModal: false,
	basicSignUpModal: false,
	advanceSignInModal: false,
	advanceSignUpModal: false,
}" 
class="flex flex-col min-h-screen custom-scrollbar"
>
<!-- start::Black overlay -->
<div :class="menuOpen ? 'block' : 'hidden'" @click="menuOpen = false" class="fixed  inset-0 bg-black opacity-50 transition-opacity lg:hidden"></div>
<!-- end::Black overlay -->
 {% include 'header.html' %}
 {% include 'tabs.html' with active_tab="products" %}
 <div class=" w-full flex flex-row">
	{% include "sidebar_produits.html" %}
  <div class="h-full w-full">
	<!-- Main content header -->
	<main class="block w-full h-full px-2 " x-data="products()" x-init="init()">
		<div class="flex flex-col items-start justify-between space-y-4 border-b lg:items-center lg:space-y-0 lg:flex-row py-2"  >                                                                                                                                                    
			<h1 class="text-2xl font-semibold whitespace-nowrap pt-4">Liste des Produits</h1>          
		  </div>
		<div class="flex flex-col items-start justify-between space-y-4 border-b lg:items-center lg:space-y-0 lg:flex-row py-2"  >  
		    <div class=" flex items-center md:w-1/3 py-2">
    			<input type="search" x-model="search"
     			 class="form-input rounded-md bg-gray-50 text-sm text-black  py-2 pl-4 border-transparent border-none outline-none focus:ring-0 focus:text-black transition-all duration-300 ease-in-out focus:w-72 w-60"
      				placeholder="Rechercher...">
      				{% if request.session.role == 'manager' and request.session.store != "2" and request.session.store != "8" %} 
					  <div class="relative mr-4 inline-block">
						<div class="text-gray-500 cursor-pointer w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-300 inline-flex items-center justify-center" @mouseenter="showTooltip1 = true" @mouseleave="showTooltip1 = false" @click="exportExcelDetailed">
						   <svg id='file-spreadsheet_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
							   <g transform="matrix(1 0 0 1 12 12)" >
							   <g style="" >
							   <g transform="matrix(1 0 0 1 0 0)" >
							   <path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
							   </g>
							   <g transform="matrix(1 0 0 1 4 -7)" >
							   <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-16.5, -5.5)" d="M 14 3 L 14 7 C 14 7.552284749830793 14.447715250169207 8 15 8 L 19 8" stroke-linecap="round" />
							   </g>
							   <g transform="matrix(1 0 0 1 -0.5 -0.5)" >
							   <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 17 21 L 7 21 C 5.8954305003384135 21 5 20.104569499661586 5 19 L 5 5 C 5 3.895430500338413 5.8954305003384135 3 7 3 L 14 3 L 19 8 L 19 19 C 19 20.104569499661586 18.104569499661586 21 17 21 z" stroke-linecap="round" />
							   </g>
							   <g transform="matrix(1 0 0 1 -0.5 2)" >
							   <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -14.5)" d="M 8 11 L 16 11 L 16 18 L 8 18 z" stroke-linecap="round" />
							   </g>
							   <g transform="matrix(1 0 0 1 -0.5 2.5)" >
							   <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -15)" d="M 8 15 L 16 15" stroke-linecap="round" />
							   </g>
							   <g transform="matrix(1 0 0 1 -1.5 2)" >
							   <path style="stroke: rgb(17,156,29); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-11, -14.5)" d="M 11 11 L 11 18" stroke-linecap="round" />
							   </g>
							   </g>
							   </g>
						   </svg>			  
						</div>
						<div x-show.transition="showTooltip1" class="z-40 shadow-lg text-center w-32 block absolute left-0 top-0 p-2 mt-12 rounded-lg bg-gray-800 text-white text-xs">
							Exporter  fichier Produits Détaillé
						</div>
					</div>
					{% endif %}
  			</div>
  			{% if request.session.role == 'manager' and request.session.store == "2"%} 
				<span @click="exportExcel" class=" cursor-pointer font-semibold whitespace-nowrap">
					<svg id='file-export_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
						<g transform="matrix(1 0 0 1 12 12)" >
						<g style="" >
						<g transform="matrix(1 0 0 1 0 0)" >
						<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
						</g>
						<g transform="matrix(1 0 0 1 4 -7)" >
						<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-16.5, -5.5)" d="M 14 3 L 14 7 C 14 7.552284749830793 14.447715250169207 8 15 8 L 19 8" stroke-linecap="round" />
						</g>
						<g transform="matrix(1 0 0 1 0.5 0)" >
						<path style="stroke: rgb(30,41,59); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-13, -12.5)" d="M 11.5 21 L 7 21 C 5.8954305003384135 21 5 20.104569499661586 5 19 L 5 5 C 5 3.895430500338413 5.8954305003384135 3 7 3 L 14 3 L 19 8 L 19 13 M 14 19 L 21 19 M 18 16 L 21 19 L 18 22" stroke-linecap="round" />
						</g>
						</g>
						</g>
					</svg>
					Exporter Un fichier
				</span>   
			{% endif %}
			{% if request.session.role == 'manager' and request.session.store != "2" and request.session.store != "8" %} 
						
				<div class="flex items-center space-x-2 cursor-pointer font-semibold whitespace-nowrap">
					<label class="flex flex-col items-center px-4  bg-white text-blue rounded-lg shadow-lg tracking-wide uppercase border border-blue cursor-pointer hover:bg-gray-700 hover:text-white">
						<svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
							<path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z" />
						</svg>
						<span class="mt-2 text-base leading-normal">Importer Produits</span>
						<input type="file" class="hidden" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChange">
					</label>
					<div>
						<label class="
						flex flex-col items-center px-4 rounded-lg shadow-lg tracking-wide uppercase border border-gray-700 cursor-pointer bg-gray-700 text-white hover:bg-white  hover:text-gray-700">
							<svg class="w-8 h-8 " fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
								<path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z" />
							</svg>
							<span class="mt-2  leading-normal">Modifier Prix</span>
							<input type="file" class="hidden" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChangePrice">
						</label>
						<p class="text-xs  text-red-500" @click.prevent="exportExcelModel">Exporter Fichier modèle</p>
					</div>
				<div>
					<label class="
					flex flex-col items-center px-4 rounded-lg shadow-lg tracking-wide uppercase border border-gray-700 cursor-pointer bg-gray-700 text-white hover:bg-white  hover:text-gray-700">
						<svg class="w-8 h-8 " fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
							<path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z" />
						</svg>
						<span class="mt-2  leading-normal">Modifier Qte/Prix Carton</span>
						<input type="file" class="hidden" accept=".xlsx" x-ref="fileInput" x-on:change="handleFileChangePriceCarton">
					</label>
					<p class="text-xs  text-red-500" @click.prevent="exportExcelModel">Exporter Fichier modèle</p>
				</div>
				</div>
			{% endif %}
		  </div>
		<div class="flex flex-wrap justify-between border-b py-2">
  <div class="py-2">
    <select class="text-black/70 bg-gray-100 px-3 py-2 transition-all cursor-pointer hover:border-gray-700 border border-gray-200 rounded-lg outline-gray-700  invalid:text-black/30 w-64"
      x-model="selectedFamily">
      <option value="">Tous les Familles</option>
      {% for family in product_families %}
      <option value="{{ family.Libellé }}">{{ family.Libellé }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="py-2">

    <select class="text-black/70 bg-gray-100 px-3 py-2 transition-all cursor-pointer hover:border-gray-700 border border-gray-200 rounded-lg outline-gray-700  invalid:text-black/30 w-64"
      x-model="selectedEntrepot">
      <option value="">Quantité Globale</option>
      {% for entrepot in entrepots %}
      <option value="{{ entrepot.name }}">{{ entrepot.name }}</option>
      {% endfor %}
    </select>
    <input type="text" hidden x-model="key">

  </div>
     {% if  request.session.store != "2" and request.session.store != "8" %}
      <div class="py-2">
        <select class="text-black/70 bg-gray-100 px-3 py-2 transition-all cursor-pointer hover:border-gray-700 border border-gray-200 rounded-lg outline-gray-700  invalid:text-black/30 w-64"
          x-model="selectedFournisseur">
          <option value="">Tous les marques</option>
            <option value="asus">Asus</option>
            <option value="marsgaming">Mars Gaming</option>
            <option value="aoc">AOC</option>
            <option value="msi">MSI</option>
            <option value="lexar">Lexar</option>
            <option value="patriot">Patriot</option>
            <option value="teamgroup">Teamgroup</option>
            <option value="twistedminds">TwistedMinds</option>
            <option value="redragon">Redragon</option>
            <option value="glorius">Glorius</option>
            <option value="cougar">COUGAR</option>
            <option value="adata">ADATA</option>
            <option value="antec">ANTEC </option>
            <option value="canyon">CANYON</option>
            <option value="coolermaster">Cooler Master</option>
            <option value="thermalgrizzly">Thermal grizzly</option>
            <option value="lianli">Lian Li</option>
    
        </select>
      </div>
     {% endif %}
 {% if request.session.role == 'manager' or 'produits.can_add_product' in request.session.permissions or request.session.username == 'hanane' %} 
  <div class="py-2">
    <a href="{% url 'new-product' %}"
      class="inline-block px-4 py-2 text-sm leading-5 font-medium rounded-md text-black border border-gray-700 hover:bg-gray-700 hover:text-white focus:outline-none focus:shadow-outline">
     +  Ajouter Nouveau Produit
    </a>
  </div>
</div>
{% endif %}
								 
		<div class="w-full mx-auto">
 <div class="">
  <div class="bg-gray-100">
    <div class="grid {% if request.session.store != '2' and request.session.store != '8'  %} grid-cols-8 {% else %} grid-cols-6 {% endif %}">
      <div class="px-6 py-3 text-sm font-medium text-gray-700 uppercase">Référence</div>
      <div class="px-6 py-3 col-span-2  text-sm font-medium text-gray-700 uppercase">Désignation</div>

      {% if request.session.store != '1' and request.session.store != '2' and request.session.store != '8'  %}
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-700 uppercase">Quantité-Diva</div>
	  {% endif %}
	  
      <div class="px-6 py-3 text-sm text-center font-medium text-gray-700 uppercase cursor-pointer mx-auto flex" @click.prevent="updateKey('qty');">Quantité
       <svg class=""  id='selector_24' width='20' height='20' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
		<g transform="matrix(1 0 0 1 12 12)" >
		<g style="" >
		<g transform="matrix(1 0 0 1 0 0)" >
		<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
		</g>
		<g transform="matrix(1 0 0 1 -0.5 -5.5)" >
		<polyline style="stroke: rgb(0,0,0); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="-4,2 0,-2 4,2 " />
		</g>
		<g transform="matrix(1 0 0 1 -0.5 4.5)" >
		<polyline style="stroke: rgb(0,0,0); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="4,-2 0,2 -4,-2 " />
		</g>
		</g>
		</g>
		</svg>
	  </div>
	  {% if request.session.store == '1' and request.session.role == 'manager'  %}
          <div class="px-6 py-3 text-sm text-center font-medium text-gray-700 uppercase cursor-pointer mx-auto flex" >
              Quantité  Blocké
    	  </div>
	  {% endif %}
      <div class="px-6 py-3 text-sm font-medium text-center text-gray-700 uppercase cursor-pointer mx-auto flex" @click.prevent="updateKey('price');">PV TTC -P- <svg class=""  id='selector_24' width='20' height='20' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
		<g transform="matrix(1 0 0 1 12 12)" >
		<g style="" >
		<g transform="matrix(1 0 0 1 0 0)" >
		<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
		</g>
		<g transform="matrix(1 0 0 1 -0.5 -5.5)" >
		<polyline style="stroke: rgb(0,0,0); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="-4,2 0,-2 4,2 " />
		</g>
		<g transform="matrix(1 0 0 1 -0.5 4.5)" >
		<polyline style="stroke: rgb(0,0,0); stroke-width: 1; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="4,-2 0,2 -4,-2 " />
		</g>
		</g>
		</g>
		</svg>
	  </div>
      {% if request.session.store != '2' and request.session.store != '8' %}
        <div class="px-6 py-3 text-sm font-medium text-center text-gray-700 uppercase">PV TTC - R -</div>
     {% endif %}
      <div class="px-6 py-3"></div>
    </div>
  </div>
  <div class="bg-white divide-y divide-gray-200">
    <template x-for="product in filteredAndPaginatedProducts">
      <div class="transition-all hover:shadow-lg" x-show="productMatches(search, product.name, product.reference)" >
        <div class="grid {% if  request.session.store != '2' and request.session.store != '8'  %} grid-cols-8 {% else %} grid-cols-6 {% endif %}">
          <div class="py-4 flex max-w-sm">
             {% if request.session.role == 'manager' or 'produits.can_delete_product' in request.session.permissions or request.session.store == '8' %}  
		     <input class="align-middle border-l-0 border-r-0 text-sm whitespace-nowrap" type="checkbox" :value="product.reference" x-model="selectedItems" id="target-row">
		     {% endif %}
             <div  class="inline-flex px-2 text-sm max-w-sm font-semibold leading-5" x-text="product.reference"></div>
          </div>
       
          <div class=" col-span-2 py-4">
            <div class="inline-flex text-sm  font-semibold leading-5" x-text="product.name"></div>
          </div>
		  {% if request.session.store != '1' and request.session.store != '2' and request.session.store != "8" %}
		  <div class=" py-4">
  			<div class="mx-auto text-center px-2 text-sm font-semibold leading-5" >
			    <span  x-bind:class="{'text-red-500 mx-auto text-center': qty_diva === 0, 'text-green-500 mx-auto text-center': qty_diva !== 0}" x-text="product.qty_diva"></span>
			</div>
    	  </div>
		  {% endif %}
          <div class=" py-4">
  			<div class="mx-auto text-center px-2 text-sm font-semibold leading-5" >
			    <span  x-bind:class="{'text-red-500 mx-auto text-center': displayQuantities(product) === 0, 'text-green-500 mx-auto text-center': displayQuantities(product) !== 0}" x-text="displayQuantities(product)"></span>
			</div>
    	  </div>
    	  {% if request.session.store == '1' and request.session.role == 'manager'  %}
          <div class=" py-4">
  			<div class="mx-auto text-center px-2 text-sm font-semibold leading-5" >
			    <span  x-bind:class="{'text-red-500 mx-auto text-center': displayQuantitiesBlocked(product) != 0, 'text-green-500 mx-auto text-center': displayQuantitiesBlocked(product) == 0}" x-text="displayQuantitiesBlocked(product)"></span>
			</div>
    	  </div>
    	  {% endif %}
    	  {% if request.session.store != '2' and request.session.store != "8" %}
              <div class="px-6 py-4 text-center">
                <div class="inline-flex px-2 text-sm text-center font-semibold leading-5" x-text="product.price"></div>
              </div>
          {% else %}
              <div class="px-6 py-4 text-center">
                <div class="inline-flex px-2 text-sm text-center font-semibold leading-5" x-text="product.prix_mag"></div>
              </div>
          {% endif %}
           {% if request.session.store != '2' and request.session.store != '8' %}
           <div class="px-6 py-4 text-sm  text-center text-gray-500">
            <div class="inline-flex px-2 text-sm  text-center font-semibold leading-5" x-text="product.prixRevendeur" ></div>
          </div>
         {% endif %}
          
          <div class="py-4  flex mx-auto ">
            {% if  request.session.role == 'manager' %}
    			<a :href="'/produits/modifier-product/' + product.id" class="text-gray-700 cursor-pointer">
    				{% heroicon_mini "pencil-square" class="transition-transform" %}
    			</a>
    			
    			<a x-on:click='showModalBlock=true; referenceblock = product.reference; product_b = product;  id_block = product.id;'" class="text-gray-700 cursor-pointer hover:text-red-500" :class="{'text-red-500 disabled': product.reforme}">
    				{% heroicon_mini "no-symbol"  class="transition-transform  " %}
    			</a>
			{% endif %}
            {% if request.session.store == '2' and request.session.role == 'manager' or  request.session.username == 'hanane' %}
                 <a :href="'/produits/view-product/' + product.id" class="text-gray-700 cursor-pointer">
    				{% heroicon_mini "pencil-square" class="transition-transform" %}
    			</a>
				<button @click="product.showVariants = !product.showVariants" class="text-gray-700 cursor-pointer">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
						<path  x-show="!product.showVariants"  stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
						<path x-show="product.showVariants" stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
					</svg>			
				</button>
			{% endif %}
          </div>
        </div>
        <!-- Variant Structure -->
        <template x-if="product.showVariants">
        <table class="table-auto bg-gray-100 w-full px-8">
         <thead class="bg-gray-100 ">
          <tr class="border-b border-gray-50">
            <th class=" px-4  py-3 text-sm text-left font-medium text-gray-500 uppercase">Référence</th>
            <th class=" px-4   py-3 text-sm text-left font-medium text-gray-500 uppercase">Titre</th>
            <th class=" px-4  py-3 text-sm text-left font-medium text-gray-500 uppercase">Quantité Totale</th>
            <th class=" px-4 py-3 text-sm text-left font-medium text-gray-500 uppercase">Prix Vente</th>
            <!--<th class=" px-4 py-3 text-sm text-left font-medium text-gray-500 uppercase">Prix Revient</th>-->
            
            <th class=" py-3 text-sm text-center font-medium text-gray-500 uppercase"></th>
          </tr>
         </thead>
         <tbody >
          <template x-for="variant in product.variants">
            <tr class="transition-all px-8 border-b border-gray-50 hover:shadow-lg">
              <td class=" px-4 py-4">
                {% if request.session.role == 'manager' or 'produits.can_delete_product' in request.session.permissions %}   
			        <input class=" px-6 align-middle border-l-0 border-r-0 text-sm whitespace-nowrap" type="checkbox" :value="variant.reference" x-model="selectedItems" id="target-row">
                {% endif %}
                <div  class="inline-flex text-center text-sm font-semibold leading-5"  x-text="variant.reference"></div>
              </td>
              <td class=" inline-flex px-2  mx-auto text-center text-sm font-semibold leading-5 py-4" x-text="variant.name">

              </td>
               <td class=" px-4  py-4">
      				<div class="inline-flex px-2  mx-auto text-sm font-semibold leading-5" >
						<span class="text-center" x-text="displayQuantitiesVariant(variant)"></span>
					</div>
    		  </td>
              
              <td class=" px-4  py-4">
                <div class="inline-flex px-2 mx-auto text-center text-sm font-semibold leading-5"  x-text="variant.price"></div>
              </td>
              <!--<td class=" px-4  py-4 text-sm text-gray-500">-->
              <!--  <div  class="inline-flex px-2 text-sm mx-auto text-center font-semibold leading-5" x-text="variant.priceachat"></div>-->
              <!--</td>-->
              
              <td class="  px-4 py-4 text-right flex ">
				<a :href="'/view-product/' + variant.id" class="text-gray-700">{% heroicon_mini "pencil-square" class="transition-transform" %}</a>
              </td>
            </tr>
          </template>
         </tbody>
        </table>
    </template>
      </div>
    </template>
  </div>
</div>
<div class="flex bg-gray-100 justify-between px-4">
	<div class="transition-transform cursor-pointer px-1 py-1 text-red-500 hover:text-red-700" @click="showModal = true;" >
        {% if request.session.role == 'manager' or 'produits.can_delete_product' in request.session.permissions or request.session.store == '8' %} 
             {% heroicon_mini "trash" %}
        {% endif %}
    </div>
	<div class="flex justify-start">
		<button
			x-bind:disabled="currentPage === 1"
			@click="prevPage"
			>
			<svg id='chevrons-left_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
					<g transform="matrix(1 0 0 1 12 12)" >
					<g style="" >
					<g transform="matrix(1 0 0 1 0 0)" >
					<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
					</g>
					<g transform="matrix(1 0 0 1 -3.75 -0.25)" >
					<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="2.5,-5 -2.5,0 2.5,5 " />
					</g>
					<g transform="matrix(1 0 0 1 2.25 -0.25)" >
					<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="2.5,-5 -2.5,0 2.5,5 " />
					</g>
					</g>
					</g>
			</svg>
		</button>
		<p class=" text-lg px-2" x-text="currentPage"></p> /<p id="total-pages" class=" text-lg px-2" x-text="totalPages"></p>
		<button
			x-bind:disabled="currentPage === totalPages"
			@click="nextPage"
		>
		<svg id='chevrons-right_24' width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><rect width='24' height='24' stroke='none' fill='#000000' opacity='0'/>
				<g transform="matrix(1 0 0 1 12 12)" >
				<g style="" >
				<g transform="matrix(1 0 0 1 0 0)" >
				<path style="stroke: none; stroke-width: 2; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" transform=" translate(-12, -12)" d="M 0 0 L 24 0 L 24 24 L 0 24 z" stroke-linecap="round" />
				</g>
				<g transform="matrix(1 0 0 1 -2.75 -0.25)" >
				<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="-2.5,-5 2.5,0 -2.5,5 " />
				</g>
				<g transform="matrix(1 0 0 1 3.25 -0.25)" >
				<polyline style="stroke: rgb(0,0,0); stroke-width: 1.5; stroke-dasharray: none; stroke-linecap: round; stroke-dashoffset: 0; stroke-linejoin: round; stroke-miterlimit: 4; fill: none; fill-rule: nonzero; opacity: 1;" points="-2.5,-5 2.5,0 -2.5,5 " />
				</g>
				</g>
				</g>
		</svg>
		</button>
	</div>
</div>


		  <div style=" background-color: rgba(0, 0, 0, 0.8)" class="fixed z-40 top-0 right-0 left-0 bottom-0 h-full w-full" x-cloak x-show.transition.opacity="showModalBlock">
			<div class="p-4 max-w-xl mx-auto relative absolute left-0 right-0 overflow-hidden mt-24">
				<div class="shadow absolute right-0 top-0 w-10 h-10 rounded-full bg-white text-gray-500 hover:text-gray-800 inline-flex items-center justify-center cursor-pointer"
					x-on:click="showModalBlock = !showModalBlock">
					<svg class="fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
						<path
							d="M16.192 6.344L11.949 10.586 7.707 6.344 6.293 7.758 10.535 12 6.293 16.242 7.707 17.656 11.949 13.414 16.192 17.656 17.606 16.242 13.364 12 17.606 7.758z" />
					</svg>
				</div>
				<div class="shadow w-full rounded-lg bg-white overflow-hidden w-full block p-8">		
					<div class="mb-4">
								<label class="block text-gray-700 font-semibold mb-2" for="status">
								Produit  :
								</label>
								<input
									class=" border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline cursor-pointer"
									type="text"
									x-model="referenceblock"
									disabled
								>
					</div>
					<div class="mb-4">
							<div class="mb-4">
								<label class="block text-gray-700 font-semibold mb-2" for="status">
								Entrepot  :
								</label>
								<select
									class=" border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline cursor-pointer"
									id="status"
									x-model="entrepot_block"
									name="status"	
									x-on:change="selectedEntrepot = $event.target.value;
									qtyblocked = displayQuantitiesBlocked(product_b)"					
									required  
								>
								<option value="">Entrepot</option>
								{% for entrepot in entrepots %}
									<option value="{{ entrepot.name }}">{{ entrepot.name }}</option>
								{% endfor %}
								</select>
							</div>
							<div class="mb-4">
								<label class="block text-gray-700 font-semibold mb-2" for="status">
									Quantité Bloqué  :
								</label>
								<input
									class=" border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline cursor-pointer"
									type="number"
									x-model="qtyblocked"								
								>
								<p class="text-red-500">La quantity Disponible : <span x-text="displayQuantities(product_b)"></span></p>
							</div>
					</div>
					<div class="flex justify-end">
						<button @click="BlockProduct(id_block)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 focus:outline-none mr-2">Confirmer</button>
						<button @click="showModalBlock = false;" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 focus:outline-none">Annuler</button>
					</div>
				</div>
			</div>	
		 </div>

 		 <div x-cloak x-show="showModal" class="fixed inset-0 flex items-center justify-center z-50">
			<div class="modal bg-gray-50 rounded-lg p-4 max-w-md mx-auto shadow-lg">
				<p class="text-gray-700 text-lg mb-4">Voulez-vous vraiment supprimer les éléments sélectionné </p>
				<div class="flex justify-end">
					<button @click="deletedSelected()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 focus:outline-none mr-2">Oui</button>
					<button @click="annulerSuppression()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 focus:outline-none">Annuler</button>
				</div>
			</div>
		  </div>
</div>
<!-- Modal de confirmation -->
				
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
	   <script>
				function products(){
				  return{
					search: '',
					selectedFamily: '',
					selectedEntrepot: '',
					products_import:[],
					products: [],
					entrepots: [],
					currentPage: 1,
					showModal:false,
					selectedFournisseur:'',
					productReference: '',
					entrepot_block:'',
					referenceblock:'',
					product_b:'',
					qtyblocked:'',
					pageSize: 10,
					key: '', 
					direction: 'asc',
					showModalBlock:false,
					id_block: '',
					get totalPages() {
  						return Math.max(1, Math.ceil(this.filteredProducts.length / this.pageSize));
  					},
  					updateKey(keyValue){
						this.key = keyValue;
						if (this.direction =='asc'){
							this.direction = 'dsc';
						}else{
							this.direction = 'asc';
						}
						this.filteredProducts;
					},
                    get filteredProducts() {
                      
						if (!this.key){
							return this.products.filter((product) => {
									const removeSpaces = (str) => str.toLowerCase().replace(/ /g, "");
									const familyMatch = this.selectedFamily === '' || this.selectedFamily == product.family || product.motherfamily.includes(this.selectedFamily);
									const fournisseurMatch = this.selectedFournisseur === '' || removeSpaces(product.name).includes(removeSpaces(this.selectedFournisseur.toLowerCase()));
									const nameMatch =removeSpaces(product.name).includes(removeSpaces(this.search.toLowerCase()));
									const referenceMatch = removeSpaces(product.reference).includes(removeSpaces(this.search.toLowerCase()));
									
								return (familyMatch && fournisseurMatch) && (nameMatch || referenceMatch);
								});
						}
						if (this.key == 'price'){
							if (this.direction == 'asc'){
								return this.products.filter((product) => {
									const removeSpaces = (str) => str.toLowerCase().replace(/ /g, "");
									const familyMatch = this.selectedFamily === '' || this.selectedFamily == product.family || product.motherfamily.includes(this.selectedFamily);
									const fournisseurMatch = this.selectedFournisseur === '' || this.selectedFournisseur == product.fournisseur;
									const nameMatch =removeSpaces(product.name).includes(removeSpaces(this.search.toLowerCase()));
									const referenceMatch = removeSpaces(product.reference).includes(removeSpaces(this.search.toLowerCase()));
									
								return (familyMatch && fournisseurMatch) && (nameMatch || referenceMatch);
								}).sort((a, b) => a.price - b.price);
							}else{
								return this.products.filter((product) => {
									const removeSpaces = (str) => str.toLowerCase().replace(/ /g, "");
									const familyMatch = this.selectedFamily === '' || this.selectedFamily == product.family || product.motherfamily.includes(this.selectedFamily);
									const fournisseurMatch = this.selectedFournisseur === '' || this.selectedFournisseur == product.fournisseur;
									const nameMatch =removeSpaces(product.name).includes(removeSpaces(this.search.toLowerCase()));
									const referenceMatch = removeSpaces(product.reference).includes(removeSpaces(this.search.toLowerCase()));
									
								return (familyMatch && fournisseurMatch) && (nameMatch || referenceMatch);
								}).sort((a, b) => b.price - a.price);
							}	
						}else{
						    if (this.key == 'qty'){
    							if (this.direction == 'asc'){
    								return this.products.filter((product) => {
    									const removeSpaces = (str) => str.toLowerCase().replace(/ /g, "");
    									const familyMatch = this.selectedFamily === '' || this.selectedFamily == product.family || product.motherfamily.includes(this.selectedFamily);
    									const fournisseurMatch = this.selectedFournisseur === '' || this.selectedFournisseur == product.fournisseur;
    									const nameMatch =removeSpaces(product.name).includes(removeSpaces(this.search.toLowerCase()));
    									const referenceMatch = removeSpaces(product.reference).includes(removeSpaces(this.search.toLowerCase()));
    									
    								return (familyMatch && fournisseurMatch) && (nameMatch || referenceMatch);
    								}).sort((a, b) => this.displayQuantities(a) - this.displayQuantities(b));
    							}else{
    								return this.products.filter((product) => {
    									const removeSpaces = (str) => str.toLowerCase().replace(/ /g, "");
    									const familyMatch = this.selectedFamily === '' || this.selectedFamily == product.family || product.motherfamily.includes(this.selectedFamily);
    									const fournisseurMatch = this.selectedFournisseur === '' || this.selectedFournisseur == product.fournisseur;
    									const nameMatch =removeSpaces(product.name).includes(removeSpaces(this.search.toLowerCase()));
    									const referenceMatch = removeSpaces(product.reference).includes(removeSpaces(this.search.toLowerCase()));
    									
    								return (familyMatch && fournisseurMatch) && (nameMatch || referenceMatch);
    								}).sort((a, b) => this.displayQuantities(b) - this.displayQuantities(a));
    							}	
						    }
						}
						
						
  						
					},

					selectedItems: [],
					BlockProduct(id){
						dataObj ={
							id:this.id_block,    
							entrepot:this.entrepot_block,
							qty:this.qtyblocked                    
						}
						axios.post('blockProduct/',dataObj, {
							headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': getCookie('csrftoken'),
							}
						})
							.then(response => {
								alert(response.data.message);
								this.qtyblocked = 0;
								window.location.reload();
								
							})
						.catch(error => {
    						// Handle request errors
    						alert(error);
    						this.qtyblocked = 0;
						});	
					},

					deletedSelected(){
                        if (this.selectedItems.length === 0) {
                            alert("Veuillez Selectionner aumoins un élément pour supprimer!.");
                            return;
                        }
						console.log(this.selectedItems);

						dataObj ={
							liste_ids: this.selectedItems,                        
								}
						axios.post('SupprimerProduit/',dataObj, {
							headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': getCookie('csrftoken'),
							}
						})
							.then(response => {
								// Check if the deletion was successful
								if (response.data.success) {            			
									showModal = false;
									alert(response.data.message);
									window.location.reload();
								} else {
									alert(response.data.message);
								}
							})
						.catch(error => {
						// Handle request errors
						alert(error);
						});
						this.showModal = false;
						this.selectedItems = [];
					},
					
					displayQuantities(product) {
						const quantities = product.entrepot_quantities || {};
						var entrepotName = this.selectedEntrepot;
						if (entrepotName === '' || !quantities) {
							// If no specific entrepot is selected, display the total quantity
							return Object.values(quantities).reduce((total, qty) => total + qty.quantity, 0);
						} else {
							// Display the quantity for the selected entrepot
							return (quantities[entrepotName] && quantities[entrepotName].quantity) || 0;
						}
					},
					displayQuantitiesKit(product) {
						const quantities = product.entrepot_quantities || {};
						var entrepotName = this.selectedEntrepot;
						if (entrepotName === '' || !quantities) {
							// If no specific entrepot is selected, display the total quantity_kit
							return Object.values(quantities).reduce((total, qty) => total + qty.quantity_kit, 0);
						} else {
							// Display the quantity_kit for the selected entrepot
							return (quantities[entrepotName] && quantities[entrepotName].quantity_kit) || 0;
						}
					},
					displayQuantitiesPC(product) {
						const quantities = product.entrepot_quantities || {};
						var entrepotName = this.selectedEntrepot;
						if (entrepotName === '' || !quantities) {
							// If no specific entrepot is selected, display the total quantity_pc
							return Object.values(quantities).reduce((total, qty) => total + qty.quantity_pc, 0);
						} else {
							// Display the quantity_pc for the selected entrepot
							return (quantities[entrepotName] && quantities[entrepotName].quantity_pc) || 0;
						}
					},
					displayQuantitiesBlocked(product) {
						const quantities = product.entrepot_blockedquantities || {};
						var entrepotName = this.selectedEntrepot;
						if (entrepotName === '' || !quantities) {
						// If no specific entrepot is selected, display the total quantity
						return Object.values(quantities).reduce((total, qty) => total + qty, 0);
						} else {
						// Display the quantity for the selected entrepot
						return quantities[entrepotName] || 0;
						}
					},

					displayQuantitiesVariant(product) {
						const quantities = product.quantity_per_ent || {};
						var entrepotName = this.selectedEntrepot;
						if (entrepotName === '' || !quantities) {
						return Object.values(quantities).reduce((total, qty) => total + qty, 0);
						} else {
						return quantities[entrepotName] || 0;
						}
					},


	  				get filteredAndPaginatedProducts() {
		  				const start = (this.currentPage - 1) * this.pageSize;
		  				const end = start + this.pageSize;
		  				return this.filteredProducts.slice(start, end);
	  				},

					prevPage() {
					  if (this.currentPage > 1) {
					   this.currentPage -= 1;
					  }
					},

					nextPage() {
					  if (this.currentPage < this.totalPages) {
						  this.currentPage += 1;
					  }
					},

					productMatches(search, productName, productReference) {
                        const removeSpaces = (str) => str.toLowerCase().replace(/ /g, "");
                        return (
                            removeSpaces(productName).includes(removeSpaces(search)) ||
                            removeSpaces(productReference).includes(removeSpaces(search))
                        );
                    },

					exportExcel() {
						const array_print = []
							this.filteredProducts.forEach(product => {
							// Add the product itself
							/* array_print.push({
								Référence: product.reference,
								Désignation: product.name,
								Quantité: product.quantity,
								Prix: product.price,

							});*/

							// Add its variants
							const optionsArray = [
									{ value: 'rou', text: 'Rouge' },
									{ value: 'ble', text: 'Bleu' },
									{ value: 'ver', text: 'Vert' },
									{ value: 'jau', text: 'Jaune' },
									{ value: 'lim', text: 'Lime' },
									{ value: 'ora', text: 'Orange' },
									{ value: 'vio', text: 'Violet' },
									{ value: 'ros', text: 'Rose' },
									{ value: 'marr', text: 'Marron' },
									{ value: 'gri', text: 'Gris' },
									{ value: 'grs', text: 'Gris souris' },
									{ value: 'grc', text: 'Gris clair' },
									{ value: 'grf', text: 'Gris foncé' },
									{ value: 'noi', text: 'Noir' },
									{ value: 'bla', text: 'Blanc' },
									{ value: 'bei', text: 'Beige' },
									{ value: 'cre', text: 'Creme' },
									{ value: 'cam', text: 'Camel' },
									{ value: 'mou', text: 'Moutarde' },
									{ value: 'bri', text: 'Brique' },
									{ value: 'BLM', text: 'Bleu marine'},
									{ value: 'BLF', text: 'Bleu foncé'},
									{ value: 'BLC', text: 'Bleu claire'},
									{ value: 'BLN', text: 'Bleu nuit' },
									{ value: 'Mix', text: 'Mixte' },
									{ value: 'TUR', text: 'Turquoise' },
									{ value: 'BDR', text: 'bois de rose' }
							];
						
							
							if (product.variants) {
								product.variants.forEach(variant => {
								variantColor = variant.reference.slice(5, 8)
								const matchingColorOption = optionsArray.find(option => option.value === variantColor);
								if (matchingColorOption) {
									variantColor = matchingColorOption.text;
								}

								array_print.push({
									Référence: variant.reference,
									Désignation: variant.name,
									Couleur:variantColor , // Extract the color (3 digits)
									Taille: variant.reference.slice(8),     // Extract the size (remaining characters)
									Quantité: this.displayQuantities(variant),
									Prix: variant.price,

								});
								});
							}
							});
			
		
						const ws = XLSX.utils.json_to_sheet(array_print);
						const wb = XLSX.utils.book_new();
						XLSX.utils.book_append_sheet(wb, ws, 'Products');
						XLSX.writeFile(wb, 'fichier_produits.xlsx');
					},                                 

					exportExcelDetailed() {
						const array_print = []
							this.filteredProducts.forEach(product => {
								// Add the product itself
								array_print.push({
									Référence: product.reference,
									Désignation: product.name,
									fournisseur: product.fournisseur,
									family: product.family,
									Quantité: this.displayQuantities(product),
									PrixAchat: product.prix_a,
									livraison: product.frais_livraison,
									tax: product.tax,
									prixVente: product.price_variants[0],
									prixVenteR: product.price_variants[1],
									prixVenteG: product.price_variants[2],
								});
						});
						const ws = XLSX.utils.json_to_sheet(array_print);
						const wb = XLSX.utils.book_new();
						XLSX.utils.book_append_sheet(wb, ws, 'Products');
						XLSX.writeFile(wb, 'fichier_produits_detailed.xlsx');
					},
					exportExcelModel() {
						const array_print = []
						this.filteredProducts.forEach(product => {
							array_print.push({
								Référence: product.reference,
								QteParCarton:0,
								PrixCFCarton:0,
								PrixRVCarton:0,
								PrixGCarton:0
							});
						});	
						const ws = XLSX.utils.json_to_sheet(array_print);
						const wb = XLSX.utils.book_new();
						XLSX.utils.book_append_sheet(wb, ws, 'Products');
						XLSX.writeFile(wb, 'fichier_produits_exemplaire.xlsx');
					},
				
					annulerSuppression() {
						// Réinitialiser les variables
						this.showModal = false;
						this.productReference = '';
					},

					handleFileChange(event) {
									const file = event.target.files[0];
									if (file) {
										const reader = new FileReader();
										reader.onload = (e) => {
											const data = new Uint8Array(e.target.result);
											const workbook = XLSX.read(data, { type: 'array' });
											const worksheet = workbook.Sheets[workbook.SheetNames[0]];
											const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

											for (let i = 1; i < jsonData.length; i++) {
												// Check if the reference is not empty
												console.log(jsonData[i][0])
												if (jsonData[i][0]) {
													this.products_import.push({
														reference: jsonData[i][0],
														name: jsonData[i][1],
														family: jsonData[i][3],
														Quantité: jsonData[i][4],
														PrixAchat: jsonData[i][5],
														livraison: jsonData[i][6],
														tax: jsonData[i][7],
														prixVente: jsonData[i][8],
														prixVenteR: jsonData[i][9],
														prixVenteRB: jsonData[i][10],
														prixVenteRS: jsonData[i][11],
														prixVenteRG: jsonData[i][12],
														prixVenteRd: jsonData[i][13],
													});
												}
											}
											dataObj ={
											products : this.products_import,                        
										}
										axios.post('importProduct/',dataObj, {
											headers: {
											'Content-Type': 'application/json',
											'X-CSRFToken': getCookie('csrftoken'),
											}
										})
											.then(response => {
												// Check if the deletion was successful
												if (response.data.success) {            			
													showModal = false;
													alert(response.data.message);
													window.location.reload();
												} else {
													alert(response.data.message);
												}
											})
										.catch(error => {
										// Handle request errors
										alert(error);
										});
										};
										
										reader.readAsArrayBuffer(file);
										this.$refs.fileInput.value = '';
										
									}
					},
					handleFileChangePrice(event) {
						const file = event.target.files[0];
						if (file) {
							const reader = new FileReader();
							reader.onload = (e) => {
								const data = new Uint8Array(e.target.result);
								const workbook = XLSX.read(data, { type: 'array' });
								const worksheet = workbook.Sheets[workbook.SheetNames[0]];
								const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });											
								for (let i = 1; i < jsonData.length; i++) {
									// Check if the reference is not empty
									console.log(jsonData[i][0])
									if (jsonData[i][0]) {
										this.products_import.push({
											reference: jsonData[i][0],
											name: jsonData[i][1],														
											PrixAchat: jsonData[i][5],
											livraison: jsonData[i][6],
											tax: jsonData[i][7],
											prixVente: jsonData[i][8],
											prixVenteR: jsonData[i][9],
											prixVenteG: jsonData[i][10],													
										});
									}
								}
								dataObj ={
									products : this.products_import,                        
								}
								axios.post('importProductPrice/',dataObj, {
									headers: {
									'Content-Type': 'application/json',
									'X-CSRFToken': getCookie('csrftoken'),
									}
								}).then(response => {
										// Check if the deletion was successful
										if (response.data.success) {            			
											showModal = false;
											alert(response.data.message);
											window.location.reload();
										} else {
											alert(response.data.message);
										}
									})
									.catch(error => {
									// Handle request errors
									alert(error);
								});
							};										
							reader.readAsArrayBuffer(file);
							this.$refs.fileInput.value = '';										
						}
					},
					handleFileChangePriceCarton(event) {
						const file = event.target.files[0];
						if (file) {
							const reader = new FileReader();
							reader.onload = (e) => {
								const data = new Uint8Array(e.target.result);
								const workbook = XLSX.read(data, { type: 'array' });
								const worksheet = workbook.Sheets[workbook.SheetNames[0]];
								const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });		
								const products_importCarton = []									
								for (let i = 1; i < jsonData.length; i++) {
									// Check if the reference is not empty
									
									if (jsonData[i][1]) {
										products_importCarton.push({
											name: jsonData[i][1],
											codeean: jsonData[i][2],																																				
										});
									}
								}
								dataObj ={
									products : products_importCarton,                        
								}
								axios.post('importProductPriceCarton/',dataObj, {
									headers: {
									'Content-Type': 'application/json',
									'X-CSRFToken': getCookie('csrftoken'),
									}
								}).then(response => {
										// Check if the deletion was successful
										if (response.data.success) {            			
											showModal = false;
											alert(response.data.message);
											window.location.reload();
										} else {
											alert(response.data.message);
										}
									})
									.catch(error => {
									// Handle request errors
									alert(error);
								});
							};										
							reader.readAsArrayBuffer(file);
							this.$refs.fileInput.value = '';										
						}
					},
				
					init() {
						var products = [];
						var last_id = '';
						{% for prod in stock %}
							var quantity_total = 0;
							{% if prod.myvariants.all %}
								{% for variant in prod.myvariants.all %}
									quantity_total += {{ variant.total_quantity_in_stock }};
								{% endfor %}
							{% endif %}   
					
							var productData = {
								id: "{{prod.id}}",
								reference: "{{ prod.reference }}",
								reforme: "{{ prod.reforme }}" == 'True' ? true : false,
								name: "{{ prod.name }}",
								prix_a: {{prod.prix_achat}},
								prix_mag: {{prod.prix_vente}},
								price: Math.round(((parseFloat("{{prod.clientfinal_price}}") + parseFloat("{{prod.prix_livraison}}") + parseFloat("{{prod.tva_douan}}")) * 1.19).toFixed(2)),
								priceachat: parseFloat("{{prod.prix_vente}}") + parseFloat("{{prod.prix_livraison}}"),
								prixRevendeur: Math.round(((parseFloat("{{prod.revendeur_price}}") + parseFloat("{{prod.prix_livraison}}") + parseFloat("{{prod.tva_douan}}")) * 1.19).toFixed(2)),
								fournisseur: "{{prod.fournisseur}}",
								qty_diva: "{{prod.qty_in_store}}" != '' ? "{{prod.qty_in_store}}" : '',
								quantity: quantity_total,
								frais_livraison: {{prod.prix_livraison}},
								tax: {{prod.tva_douan}},
								entrepot_quantities: {{prod.quantities_per_entrepot | safe}},
								entrepot_blockedquantities: {{prod.quantitiesblocked_per_entrepot | safe}},
								family: "{{ prod.category }}",
								motherfamily: {{ prod.ancestor_categories | safe }},
								showVariants: false,
								price_variants: {{prod.get_price_variants | safe}},
								variants: [],
							};
							{% for variant_product in  prod.myvariants.all %}
								var variantData ={
									id : "{{ variant_product.id }}",
									name: "{{ variant_product.name }}",
									reference: "{{ variant_product.reference }}",
									price: "{{variant_product.prix_vente}}",
									priceachat: "{{variant_product.prix_achat}}",
									fournisseur: "{{prod.fournisseur}}",
									quantity: "{{variant_product.total_quantity_in_stock}}",
									quantity_per_ent: {{variant_product.quantities_per_entrepot | safe}},
									family: "{{ variant_product.category }}",    
								}
								productData.variants.push(variantData)
							{% endfor %}
							// Check if the product already exists in the products array
							var exists = products.some(function(existingProduct) {
								return existingProduct.name === productData.name;
							});
							if (!exists) {
								products.push(productData);
							}
							last_id = productData.id;
						{% endfor %}
						
						const entrepots_list = []
						{% for ent in entrepots %}
							var entrepot = '{{ent.name}}'
							var exists = entrepots_list.some(function(existing) {
								return existing === entrepot;
							});
							if (!exists) {
								entrepots_list.push(entrepot);
							}
						{% endfor %}
						this.entrepots = entrepots_list;
					
						// Now, assign the filtered products array to this.products
						this.products = products;
						setTimeout(() => {
							this.LoadOtherProducts(last_id);
						}, 2000); // Delay of 1000 milliseconds (1 second)
					},

					LoadOtherProducts(last_id){
						//Load Other pRODUC
						var products = this.products;
						console.log('loading ..');
						axios.post('LoadOtherProducts', {
							lastId: last_id
							},{
							headers: {
							'Content-Type': '',
							'X-CSRFToken': getCookie('csrftoken'),
							}
						}).then((response) => {
							console.log('End loading ..');
							data= response.data
							console.log(data.stock)
							data.stock.forEach(function(prod) {						
								var productData = {
									id: prod.id,
									reference: prod.reference,
									reforme: prod.reforme === 'True',
									name: prod.name,
									prix_a: prod.prix_a,
									prix_mag: prod.prix_mag,
									price: (parseFloat(prod.price)).toFixed(2),
									priceachat: (parseFloat(prod.priceachat)).toFixed(0),
									prixRevendeur: (parseFloat(prod.prixRevendeur)).toFixed(0),
									fournisseur: prod.fournisseur,
									qty_diva: prod.qty_diva,
									frais_livraison: prod.frais_livraison,
									tax: prod.tax,
									entrepot_quantities: prod.entrepot_quantities,
									entrepot_blockedquantities: prod.entrepot_blockedquantities,
									family: prod.family,
									motherfamily: prod.motherfamily,								
									showVariants: false,
									price_variants: prod.price_variants,
									variants: []
								};
								console.log(products)
								// Check if the product already exists in the products array
								var exists = products.some(function(existingProduct) {
									return existingProduct.name === productData.name;
								});
								if (!exists) {
									products.push(productData);
								}
							});  
						})
						.catch((error) => {
							console.log(error)
						});	
						this.products = products;		
					},
		   
	 }
	}
	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie !== '') {
		var cookies = document.cookie.split(';');
		for (var i = 0; i < cookies.length; i++) {
			var cookie = cookies[i].trim();
		// Does this cookie string begin with the name we want?
			if (cookie.substring(0, name.length + 1) === (name + '=')) {
				cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
				break;
			}
		}
		}
		return cookieValue;
	}
	</script> 
				
			  </div>
			</div>
		  </div>
		</div>
</main>
	<!-- end Main content  -->

  </div>
</div>
</div>
</div>

{% endblock content %}
